<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pro - Sistema de Controle</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-color: #5636D3;
            --secondary-color: #FF872C;
            --success-color: #12A454;
            --danger-color: #E83F5B;
            --pending-color: #4B90F7;
            --background-color: #F0F2F5;
            --text-color: #363F5F;
            --text-light-color: #969CB2;
            --card-bg-color: #FFFFFF;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
        }
        
        /* --- Layout Geral --- */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg-color);
            height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: fixed;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            padding: 2rem 3rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        header h2 {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }
        
        /* --- Sidebar --- */
        .sidebar .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3rem;
        }
        
        .sidebar .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .sidebar .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .sidebar nav ul {
            list-style: none;
        }
        
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-light-color);
            font-weight: 500;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sidebar nav li a:hover,
        .sidebar nav li a.active {
            background-color: #f0edff;
            color: var(--primary-color);
        }
        
        .sidebar nav li a i {
            width: 20px;
            text-align: center;
        }
        
        /* --- Elementos Comuns --- */
        .card {
            background-color: var(--card-bg-color);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn.secondary {
            background-color: #e0e0e0;
            color: var(--text-color);
        }
        
        .btn.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn.download {
            background-color: var(--pending-color);
            color: white;
        }
        
        .list-item {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* --- Dashboard --- */
        #dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        #dashboard-cards .card {
            border-radius: 22px; 
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        #dashboard-cards .card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--text-light-color);
        }
        
        .card-header i {
            font-size: 1.8rem;
        }
        
        #dashboard-cards .event i { color: var(--primary-color); }
        #dashboard-cards .guests i { color: var(--success-color); }
        #dashboard-cards .suppliers i { color: var(--secondary-color); }
        #dashboard-cards .payments i { color: var(--pending-color); }
        
        .card p {
            font-size: 2rem;
            font-weight: 500;
        }
        
        .transaction-details { display: flex; align-items: center; gap: 1rem; }
        .transaction-status { width: 10px; height: 10px; border-radius: 50%; }
        .transaction-status.paid { background-color: var(--success-color); }
        .transaction-status.pending { background-color: var(--pending-color); }
        .transaction-info span { display: block; }
        .transaction-info .description { font-weight: 500; }
        .transaction-info .details { font-size: 0.8rem; color: var(--text-light-color); }
        .transaction-amount { font-weight: 500; font-size: 1.1rem; }
        .transaction-amount.income { color: var(--success-color); }
        .transaction-amount.expense { color: var(--danger-color); }
        .list-item-actions { display: flex; align-items: center; gap: 1rem; }
        
        /* --- Páginas de Gerenciamento --- */
        .management-page .card { margin-bottom: 2rem; }
        .management-page form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .management-page .form-control { flex-grow: 1; min-width: 200px; }
        .management-page label { font-size: 0.9rem; margin-bottom: 0.25rem; display: block; }
        .management-page input, .management-page select, .management-page textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;
        }
        .management-page .list-item i { font-size: 1.2rem; margin-right: 1rem; color: var(--primary-color); }
        .list-item-main { flex-grow: 1; display: flex; align-items: center; }
        
        /* --- Página Controle de Entrada --- */
        .checkin-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }
        .checkin-container input {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 0.5em;
        }
        .checkin-result { 
            margin-top: 15px; 
            padding: 15px; 
            border-radius: 10px; 
            background-color: #f8f9fa; 
            display: none; 
            text-align: left;
        }
        .checkin-result h4 { margin-bottom: 0.5rem; }
        .checkin-result.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .checkin-result.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .checkin-result.pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        
        /* --- Página Relatórios --- */
        #reports-page .filters { background-color: #fff; padding: 1.5rem; margin-bottom: 2rem; border-radius: var(--border-radius); display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        #reports-page .filters .form-control { flex-grow: 1; min-width: 200px; }
        #reports-page .filters label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #reports-page .filters input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .report-card p { font-size: 1.5rem; }
        
        /* --- Modal e FAB --- */
        .fab { position: fixed; bottom: 2rem; right: 3rem; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 101; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 102; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-content h3 { margin-bottom: 1.5rem; }
        .form-control { margin-bottom: 1rem; }
        .form-control label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control input, .form-control select, .form-control textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
        .modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .modal-actions .spacer { flex-grow: 1; }
        
        /* --- Header Mobile --- */
        .mobile-header { display: none; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background-color: var(--card-bg-color); box-shadow: var(--box-shadow); margin-bottom: 1.5rem; }
        .mobile-header #menu-toggle-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .mobile-header h2 { font-size: 1.25rem; margin-bottom: 0; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        
        /* --- Status --- */
        .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .status.paid { background-color: #d4edda; color: #155724; }
        .status.pending { background-color: #fff3cd; color: #856404; }
        .status.partial { background-color: #cce7ff; color: #004085; }
        .checkin-status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .checkin-status.checked { background-color: #d4edda; color: #155724; }
        .checkin-status.not-checked { background-color: #f8d7da; color: #721c24; }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 0; }
            .page-content { padding: 0 1.5rem 1.5rem 1.5rem; }
            header { display: none; }
            .mobile-header { display: flex; }
            .form-grid { grid-template-columns: 1fr; }
            .fab { right: 1.5rem; bottom: 1.5rem; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .list-item-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fa-solid fa-calendar-alt"></i>
            <h1>Eventos Pro</h1>
        </div>
        <nav>
            <ul id="nav-links">
                <li><a data-page="dashboard-page" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                <li><a data-page="event-page"><i class="fa-solid fa-calendar-check"></i> Evento</a></li>
                <li><a data-page="guests-page"><i class="fa-solid fa-users"></i> Convidados</a></li>
                <li><a data-page="suppliers-page"><i class="fa-solid fa-truck"></i> Fornecedores</a></li>
                <li><a data-page="payments-page"><i class="fa-solid fa-money-bill-wave"></i> Pagamentos</a></li>
                <li><a data-page="checkin-page"><i class="fa-solid fa-id-card"></i> Controle de Entrada</a></li>
                <li><a data-page="reports-page"><i class="fa-solid fa-chart-line"></i> Relatórios</a></li>
                <li><a data-page="backup-page"><i class="fa-solid fa-database"></i> Backup</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="mobile-header">
            <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h2 id="mobile-page-title">Dashboard</h2>
        </header>

        <section id="dashboard-page" class="page-content active">
            <header><h2>Dashboard</h2></header>
            <div id="dashboard-cards">
                <div class="card event" data-page="event-page">
                    <div class="card-header"><span>Evento</span><i class="fa-solid fa-calendar-alt"></i></div>
                    <p id="dashboard-event-name">Configurar</p>
                </div>
                <div class="card guests" data-page="guests-page">
                    <div class="card-header"><span>Convidados</span><i class="fa-solid fa-users"></i></div>
                    <p id="dashboard-guest-count">0</p>
                </div>
                <div class="card suppliers" data-page="suppliers-page">
                    <div class="card-header"><span>Fornecedores</span><i class="fa-solid fa-truck"></i></div>
                    <p id="dashboard-supplier-count">0</p>
                </div>
                <div class="card payments" data-page="payments-page">
                    <div class="card-header"><span>Total Recebido</span><i class="fa-solid fa-arrow-up"></i></div>
                    <p id="dashboard-payment-total">R$ 0,00</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Resumo Financeiro</h3>
                <div class="form-grid">
                    <div><strong>Custo Total do Evento:</strong> <span id="total-cost">R$ 0,00</span></div>
                    <div><strong>Custo por Convidado:</strong> <span id="cost-per-guest">R$ 0,00</span></div>
                    <div><strong>Total Recebido:</strong> <span id="total-received" style="color: var(--success-color);">R$ 0,00</span></div>
                    <div><strong>Total a Receber:</strong> <span id="total-pending" style="color: var(--danger-color);">R$ 0,00</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>Últimos Pagamentos Recebidos</h3>
                <ul id="recent-payments-list"></ul>
            </div>
        </section>

        <section id="event-page" class="page-content management-page">
            <header><h2>Configuração do Evento</h2></header>
            <div class="card">
                <div class="card-header"><h3>Informações do Evento</h3><button class="btn primary" id="edit-event-btn">Editar Evento</button></div>
                <div id="event-info"></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Custos do Evento</h3><button class="btn primary" id="edit-costs-btn">Editar Custos</button></div>
                <div id="costs-info"></div>
            </div>
        </section>

        <section id="guests-page" class="page-content management-page">
            <header><h2>Lista de Convidados</h2></header>
            <div class="card">
                <div class="form-control"><input type="text" id="guest-search" placeholder="Buscar convidado..."></div>
            </div>
            <ul id="guests-list"></ul>
        </section>

        <section id="suppliers-page" class="page-content management-page">
            <header><h2>Fornecedores</h2></header>
            <ul id="suppliers-list"></ul>
        </section>

        <section id="payments-page" class="page-content">
            <header><h2>Controle de Pagamentos</h2></header>
            <div class="card">
                <div class="form-grid">
                    <div><h3>Total Recebido: <span id="payments-total-received" style="color: var(--success-color);">R$ 0,00</span></h3></div>
                    <div><h3>Total a Receber: <span id="payments-total-pending" style="color: var(--danger-color);">R$ 0,00</span></h3></div>
                </div>
            </div>
            <div class="card"><h3>Pagamentos Recebidos de Convidados</h3><ul id="guest-payments-list"></ul></div>
            <div class="card"><h3>Pagamentos Efetuados a Fornecedores</h3><ul id="supplier-payments-list"></ul></div>
        </section>

        <section id="checkin-page" class="page-content">
            <header><h2>Controle de Entrada</h2></header>
            <div class="card">
                <h3>Verificação de Acesso</h3>
                <p>Digite o código de 4 dígitos do convidado para validar a entrada.</p>
                <div class="checkin-container">
                    <form id="checkin-form">
                        <div class="form-control">
                            <label for="checkin-code">Código de Acesso (4 dígitos)</label>
                            <input type="tel" id="checkin-code" maxlength="4" pattern="\d{4}" inputmode="numeric" required>
                        </div>
                        <div class="modal-actions" style="justify-content: center;">
                            <button type="submit" class="btn primary">Verificar Entrada</button>
                        </div>
                    </form>
                    <div id="checkin-result" class="checkin-result"></div>
                </div>
            </div>
        </section>

        <section id="reports-page" class="page-content">
            <header><h2>Relatórios Financeiros</h2></header>
             <div id="report-summary">
                <div class="card"><div class="card-header"><span>Total de Receitas</span></div><p id="total-income">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Total de Despesas</span></div><p id="total-expenses">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Saldo Final</span></div><p id="final-balance">R$ 0,00</p></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Balanço Geral</h3><button class="btn download" id="generate-balance-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="balance-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Pagamentos de Convidados</h3><button class="btn download" id="generate-guest-payments-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="guest-payments-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Despesas do Evento</h3><button class="btn download" id="generate-expenses-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="expenses-details"></tbody></table>
            </div>
        </section>

        <section id="backup-page" class="page-content">
            <header><h2>Backup e Restauração</h2></header>
            <div class="card">
                <h3>Exportar Dados</h3>
                <p>Faça backup de todos os dados do sistema para um arquivo JSON.</p>
                <div class="modal-actions">
                    <button class="btn success" id="export-data-btn">Exportar Tudo</button>
                    <button class="btn success" id="export-guests-btn">Exportar Convidados</button>
                </div>
            </div>
            <div class="card">
                <h3>Importar Dados</h3>
                <p>Restaurar dados de um backup anterior. A importação adicionará novos dados aos existentes.</p>
                <div class="form-control"><label for="backup-file">Selecionar arquivo de backup (.json)</label><input type="file" id="backup-file" accept=".json"></div>
                <div class="modal-actions">
                    <button class="btn secondary" id="import-data-btn">Importar Dados</button>
                </div>
            </div>
            <div class="card">
                <h3>Limpar Dados</h3>
                <p>Remover todos os dados do sistema. Esta ação não pode ser desfeita.</p>
                <div class="modal-actions"><button class="btn danger" id="clear-data-btn">Limpar Todos os Dados</button></div>
            </div>
        </section>
    </main>

    <button class="fab" id="fab-add-btn" style="display: none;"><i class="fa-solid fa-plus"></i></button>

    <div class="modal-overlay" id="event-modal"><div class="modal-content"><h3 id="event-modal-title"></h3><form id="event-form"></form></div></div>
    <div class="modal-overlay" id="costs-modal"><div class="modal-content"><h3 id="costs-modal-title"></h3><form id="costs-form"></form></div></div>
    <div class="modal-overlay" id="guest-modal"><div class="modal-content"><h3 id="guest-modal-title"></h3><form id="guest-form"></form></div></div>
    <div class="modal-overlay" id="supplier-modal"><div class="modal-content"><h3 id="supplier-modal-title"></h3><form id="supplier-form"></form></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-content"><h3 id="delete-modal-title"></h3><p id="delete-message"></p><div class="modal-actions"><button type="button" class="btn secondary" id="cancel-delete-btn">Cancelar</button><button type="button" class="btn danger" id="confirm-delete-btn">Excluir</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===== ESTADO CENTRAL DA APLICAÇÃO =====
        const state = {
            eventData: {},
            guests: [],
            suppliers: [],
            activePage: 'dashboard-page',
            currentEditingId: null,
            currentEditingType: null,
        };

        // ===== SELETORES DE ELEMENTOS COMUNS =====
        const selectors = {
            navLinks: document.getElementById('nav-links'),
            pages: document.querySelectorAll('.page-content'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            mobilePageTitle: document.getElementById('mobile-page-title'),
            fab: document.getElementById('fab-add-btn'),
            dashboardCardsContainer: document.getElementById('dashboard-cards')
        };
        
        // ===== FUNÇÕES AUXILIARES =====
        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getPaymentStatusText = (status) => ({ paid: 'Pago', partial: 'Parcial', pending: 'Pendente' }[status] || 'Pendente');
        const getCostCategoryName = (category) => ({ food: 'Alimentação', music: 'Música', venue: 'Aluguel do Espaço', drinks: 'Bebidas', other: 'Outros Custos' }[category] || category);
        const calculateTotalCost = () => (Object.values(state.eventData.costs || {}).reduce((s, c) => s + c, 0)) + (state.suppliers.reduce((s, sup) => s + (sup.cost || 0), 0));

        // ===== PERSISTÊNCIA DE DADOS (LocalStorage) =====
        const initializeData = () => {
            const savedData = JSON.parse(localStorage.getItem('eventManagementData_v2'));
            if (savedData) {
                state.eventData = savedData.eventData || { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
                state.guests = savedData.guests || [];
                
                // --- Migração de Dados: Adiciona accessCode para convidados antigos ---
                let needsSave = false;
                const existingCodes = new Set(state.guests.map(g => g.accessCode).filter(Boolean)); // Pega todos os códigos que já existem
                
                state.guests.forEach((guest, index) => {
                    if (!guest.regOrder) {
                        guest.regOrder = index + 1;
                        needsSave = true;
                    }
                    
                    // Se o convidado não tem um código, gera um novo e único
                    if (!guest.accessCode) {
                        let newCode;
                        do {
                            newCode = Math.floor(1000 + Math.random() * 9000); // Gera um número de 1000 a 9999
                        } while (existingCodes.has(newCode)); // Garante que seja único
                        
                        guest.accessCode = newCode;
                        existingCodes.add(newCode); // Adiciona ao set para a próxima verificação
                        needsSave = true;
                    }

                    // Remove dados antigos de QR Code, se existirem
                    if (guest.qrCode) {
                        delete guest.qrCode;
                        needsSave = true;
                    }
                });

                if (needsSave) {
                    saveData(); // Salva os novos códigos gerados
                }
                // --- Fim da Migração ---

                state.suppliers = savedData.suppliers || [];
            } else {
                state.eventData = { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
                state.guests = [];
                state.suppliers = [];
                saveData();
            }
        };

        const saveData = () => {
            localStorage.setItem('eventManagementData_v2', JSON.stringify({
                eventData: state.eventData,
                guests: state.guests,
                suppliers: state.suppliers
            }));
        };

        // ===== NAVEGAÇÃO E INTERFACE =====
        const setupNavigation = () => {
            // Navegação por clique nos links
            selectors.navLinks.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' || e.target.parentElement.tagName === 'A') {
                    e.preventDefault();
                    const link = e.target.tagName === 'A' ? e.target : e.target.parentElement;
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        navigateToPage(pageId);
                        // Fechar menu mobile após seleção
                        if (window.innerWidth <= 768) {
                            selectors.sidebar.classList.remove('open');
                            selectors.sidebarOverlay.classList.remove('active');
                        }
                    }
                }
            });

            // Navegação por clique nos cards do dashboard
            selectors.dashboardCardsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                if (card && card.dataset.page) {
                    navigateToPage(card.dataset.page);
                }
            });

            // Menu mobile toggle
            selectors.menuToggleBtn.addEventListener('click', () => {
                selectors.sidebar.classList.toggle('open');
                selectors.sidebarOverlay.classList.toggle('active');
            });

            // Fechar menu mobile ao clicar no overlay
            selectors.sidebarOverlay.addEventListener('click', () => {
                selectors.sidebar.classList.remove('open');
                selectors.sidebarOverlay.classList.remove('active');
            });
        };

        const navigateToPage = (pageId) => {
            // Atualizar navegação
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar nav a[data-page="${pageId}"]`).classList.add('active');
            
            // Atualizar páginas
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Atualizar título mobile
            const pageTitle = document.querySelector(`.sidebar nav a[data-page="${pageId}"]`).textContent.trim();
            selectors.mobilePageTitle.textContent = pageTitle;
            
            // Atualizar botão FAB
            updateFAB(pageId);
            
            // Atualizar estado
            state.activePage = pageId;
            
            // Renderizar conteúdo específico da página
            renderPageContent(pageId);
        };

        const updateFAB = (pageId) => {
            const fab = selectors.fab;
            const showFab = ['guests-page', 'suppliers-page'].includes(pageId);
            fab.style.display = showFab ? 'flex' : 'none';
            
            if (showFab) {
                fab.onclick = () => {
                    if (pageId === 'guests-page') showGuestModal();
                    if (pageId === 'suppliers-page') showSupplierModal();
                };
            }
        };

        const renderPageContent = (pageId) => {
            switch(pageId) {
                case 'dashboard-page':
                    renderDashboard();
                    break;
                case 'event-page':
                    renderEventPage();
                    break;
                case 'guests-page':
                    renderGuestsPage();
                    break;
                case 'suppliers-page':
                    renderSuppliersPage();
                    break;
                case 'payments-page':
                    renderPaymentsPage();
                    break;
                case 'checkin-page': // Alterado de qr-page
                    renderCheckinPage();
                    break;
                case 'reports-page':
                    renderReportsPage();
                    break;
                case 'backup-page':
                    renderBackupPage();
                    break;
            }
        };

        // ===== GERENCIAMENTO DE MODAIS =====
        const setupModals = () => {
            // Fechar modais ao clicar fora do conteúdo
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeAllModals();
                    }
                });
            });

            // Botões de cancelar
            document.querySelectorAll('.modal-actions .btn.secondary').forEach(btn => {
                if (btn.id !== 'cancel-delete-btn') {
                    btn.addEventListener('click', closeAllModals);
                }
            });
        };

        const closeAllModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            state.currentEditingId = null;
            state.currentEditingType = null;
        };

        // ===== DASHBOARD =====
        const renderDashboard = () => {
            // Atualizar cards principais
            document.getElementById('dashboard-event-name').textContent = state.eventData.name || 'Configurar';
            document.getElementById('dashboard-guest-count').textContent = state.guests.length;
            document.getElementById('dashboard-supplier-count').textContent = state.suppliers.length;
            
            // Calcular totais de pagamentos
            const totalReceived = state.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalPending = state.guests.reduce((sum, guest) => {
                const total = guest.totalAmount || 0;
                const paid = guest.paidAmount || 0;
                return sum + (total - paid);
            }, 0);
            
            document.getElementById('dashboard-payment-total').textContent = formatCurrency(totalReceived);
            
            // Atualizar resumo financeiro
            const totalCost = calculateTotalCost();
            const costPerGuest = state.guests.length > 0 ? totalCost / state.guests.length : 0;
            
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            document.getElementById('cost-per-guest').textContent = formatCurrency(costPerGuest);
            document.getElementById('total-received').textContent = formatCurrency(totalReceived);
            document.getElementById('total-pending').textContent = formatCurrency(totalPending);
            
            // Atualizar lista de pagamentos recentes
            renderRecentPayments();
        };

        const renderRecentPayments = () => {
            const container = document.getElementById('recent-payments-list');
            container.innerHTML = '';
            
            // Obter pagamentos recentes (últimos 5)
            const recentPayments = state.guests
                .filter(guest => guest.paidAmount > 0)
                .sort((a, b) => new Date(b.lastPaymentDate || 0) - new Date(a.lastPaymentDate || 0))
                .slice(0, 5);
            
            if (recentPayments.length === 0) {
                container.innerHTML = '<li class="list-item">Nenhum pagamento recebido ainda</li>';
                return;
            }
            
            recentPayments.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-status ${guest.paymentStatus === 'paid' ? 'paid' : 'pending'}"></div>
                        <div class="transaction-info">
                            <span class="description">${guest.name}</span>
                            <span class="details">${guest.lastPaymentDate ? new Date(guest.lastPaymentDate).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="transaction-amount income">${formatCurrency(guest.paidAmount || 0)}</div>
                `;
                container.appendChild(li);
            });
        };

        // ===== PÁGINA DO EVENTO =====
        const renderEventPage = () => {
            // Configurar botões de edição
            document.getElementById('edit-event-btn').onclick = () => showEventModal();
            document.getElementById('edit-costs-btn').onclick = () => showCostsModal();
            
            // Renderizar informações do evento
            renderEventInfo();
            renderCostsInfo();
        };

        const renderEventInfo = () => {
            const container = document.getElementById('event-info');
            const event = state.eventData;
            
            container.innerHTML = `
                <div class="form-grid">
                    <div><strong>Nome do Evento:</strong> ${event.name || 'Não definido'}</div>
                    <div><strong>Data:</strong> ${event.date ? new Date(event.date).toLocaleDateString('pt-BR') : 'Não definida'}</div>
                    <div><strong>Local:</strong> ${event.location || 'Não definido'}</div>
                    <div><strong>Descrição:</strong> ${event.description || 'Não definida'}</div>
                </div>
            `;
        };

        const renderCostsInfo = () => {
            const container = document.getElementById('costs-info');
            const costs = state.eventData.costs || {};
            const suppliersTotal = state.suppliers.reduce((sum, supplier) => sum + (supplier.cost || 0), 0);
            const totalCost = calculateTotalCost();
            
            let html = `
                <div class="form-grid">
                    <div><strong>Alimentação:</strong> ${formatCurrency(costs.food || 0)}</div>
                    <div><strong>Música:</strong> ${formatCurrency(costs.music || 0)}</div>
                    <div><strong>Aluguel do Espaço:</strong> ${formatCurrency(costs.venue || 0)}</div>
                    <div><strong>Bebidas:</strong> ${formatCurrency(costs.drinks || 0)}</div>
                    <div><strong>Outros Custos:</strong> ${formatCurrency(costs.other || 0)}</div>
                    <div><strong>Custos com Fornecedores:</strong> ${formatCurrency(suppliersTotal)}</div>
                    <div style="grid-column: span 2; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                        <strong>Custo Total do Evento:</strong> ${formatCurrency(totalCost)}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        };

        const showEventModal = () => {
            const modal = document.getElementById('event-modal');
            const title = document.getElementById('event-modal-title');
            const form = document.getElementById('event-form');
            
            title.textContent = state.eventData.name ? 'Editar Evento' : 'Criar Evento';
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="event-name">Nome do Evento</label>
                    <input type="text" id="event-name" value="${state.eventData.name || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-date">Data do Evento</label>
                    <input type="date" id="event-date" value="${state.eventData.date || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-location">Local</label>
                    <input type="text" id="event-location" value="${state.eventData.location || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-description">Descrição</label>
                    <textarea id="event-description" rows="3">${state.eventData.description || ''}</textarea>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary" onclick="closeAllModals()">Cancelar</button>
                    <button type="submit" class="btn primary">Salvar</button>
                </div>
            `;
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveEventData();
            };
            
            modal.classList.add('active');
        };

        const showCostsModal = () => {
            const modal = document.getElementById('costs-modal');
            const title = document.getElementById('costs-modal-title');
            const form = document.getElementById('costs-form');
            
            title.textContent = 'Editar Custos do Evento';
            const costs = state.eventData.costs || { food: 0, music: 0, venue: 0, drinks: 0, other: 0 };
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="cost-food">Alimentação</label>
                    <input type="number" id="cost-food" step="0.01" value="${costs.food || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-music">Música</label>
                    <input type="number" id="cost-music" step="0.01" value="${costs.music || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-venue">Aluguel do Espaço</label>
                    <input type="number" id="cost-venue" step="0.01" value="${costs.venue || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-drinks">Bebidas</label>
                    <input type="number" id="cost-drinks" step="0.01" value="${costs.drinks || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-other">Outros Custos</label>
                    <input type="number" id="cost-other" step="0.01" value="${costs.other || 0}" required>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary" onclick="closeAllModals()">Cancelar</button>
                    <button type="submit" class="btn primary">Salvar</button>
                </div>
            `;
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveCostsData();
            };
            
            modal.classList.add('active');
        };

        const saveEventData = () => {
            state.eventData = {
                ...state.eventData,
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value,
                location: document.getElementById('event-location').value,
                description: document.getElementById('event-description').value
            };
            
            saveData();
            renderEventInfo();
            renderDashboard();
            closeAllModals();
        };

        const saveCostsData = () => {
            state.eventData.costs = {
                food: parseFloat(document.getElementById('cost-food').value) || 0,
                music: parseFloat(document.getElementById('cost-music').value) || 0,
                venue: parseFloat(document.getElementById('cost-venue').value) || 0,
                drinks: parseFloat(document.getElementById('cost-drinks').value) || 0,
                other: parseFloat(document.getElementById('cost-other').value) || 0
            };
            
            saveData();
            renderCostsInfo();
            renderDashboard();
            closeAllModals();
        };

        // ===== PÁGINA DE CONVIDADOS =====
        const renderGuestsPage = () => {
            const container = document.getElementById('guests-list');
            const searchInput = document.getElementById('guest-search');
            
            // Configurar busca
            searchInput.oninput = () => renderGuestsList();
            
            // Renderizar lista
            renderGuestsList();
        };

        const renderGuestsList = () => {
            const container = document.getElementById('guests-list');
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            
            // Filtrar convidados
            const filteredGuests = state.guests.filter(guest => 
                guest.name.toLowerCase().includes(searchTerm) || 
                (guest.phone && guest.phone.includes(searchTerm)) || // Busca por telefone
                (guest.email && guest.email.toLowerCase().includes(searchTerm))
            );
            
            if (filteredGuests.length === 0) {
                container.innerHTML = '<li class="list-item">Nenhum convidado encontrado</li>';
                return;
            }
            
            container.innerHTML = '';
            
            filteredGuests.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const paymentStatus = guest.paymentStatus || 'pending';
                const checkinStatus = guest.checkedIn ? 'checked' : 'not-checked';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-user"></i>
                        <div>
                            <div><strong>${guest.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${guest.phone || 'Sem telefone'}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span class="checkin-status ${checkinStatus}">${guest.checkedIn ? 'Entrada Confirmada' : 'Não Entrou'}</span>
                        <span>${formatCurrency(paidAmount)} / ${formatCurrency(totalAmount)}</span>
                        <button class="btn secondary" onclick="editGuest(${guest.id})"><i class="fa-solid fa-edit"></i></button>
                        <button class="btn secondary" onclick="showReceipt(${guest.id})"><i class="fa-solid fa-receipt"></i></button>
                        <button class="delete-btn" onclick="confirmDelete(${guest.id}, 'guest')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        };

        const showGuestModal = (guestId = null) => {
            const modal = document.getElementById('guest-modal');
            const title = document.getElementById('guest-modal-title');
            const form = document.getElementById('guest-form');
            
            const isEditing = guestId !== null;
            const guest = isEditing ? state.guests.find(g => g.id === guestId) : null;
            
            title.textContent = isEditing ? 'Editar Convidado' : 'Adicionar Convidado';

            // Adiciona o campo de código de acesso (somente leitura) se estiver editando
            let accessCodeHtml = '';
            if (isEditing) {
                accessCodeHtml = `
                <div class="form-control">
                    <label>Código de Acesso</label>
                    <input type="text" value="${guest.accessCode}" readonly style="background-color: #eee; text-align: center; font-size: 1.2rem; letter-spacing: 0.2em;">
                </div>`;
            }
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="guest-name">Nome</label>
                    <input type="text" id="guest-name" value="${guest ? guest.name : ''}" required>
                </div>
                <div class="form-control">
                    <label for="guest-phone">Telefone</label>
                    <input type="tel" id="guest-phone" value="${guest ? guest.phone : ''}" required>
                </div>
                ${accessCodeHtml} 
                <div class="form-control">
                    <label for="guest-email">E-mail (Opcional)</label>
                    <input type="email" id="guest-email" value="${guest ? guest.email : ''}">
                </div>
                <div class="form-control">
                    <label for="guest-total-amount">Valor Total</label>
                    <input type="number" id="guest-total-amount" step="0.01" value="${guest ? guest.totalAmount : '0'}" required>
                </div>
                <div class="form-control">
                    <label for="guest-paid-amount">Valor Pago</label>
                    <input type="number" id="guest-paid-amount" step="0.01" value="${guest ? guest.paidAmount : '0'}" required>
                </div>
                <div class="form-control">
                    <label for="guest-payment-status">Status do Pagamento</label>
                    <select id="guest-payment-status">
                        <option value="pending" ${guest && guest.paymentStatus === 'pending' ? 'selected' : ''}>Pendente</option>
                        <option value="partial" ${guest && guest.paymentStatus === 'partial' ? 'selected' : ''}>Parcial</option>
                        <option value="paid" ${guest && guest.paymentStatus === 'paid' ? 'selected' : ''}>Pago</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary" onclick="closeAllModals()">Cancelar</button>
                    <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                </div>
            `;
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveGuestData(guestId);
            };
            
            modal.classList.add('active');
        };

        const saveGuestData = (guestId = null) => {
            const name = document.getElementById('guest-name').value;
            const email = document.getElementById('guest-email').value;
            const phone = document.getElementById('guest-phone').value;
            const totalAmount = parseFloat(document.getElementById('guest-total-amount').value) || 0;
            const paidAmount = parseFloat(document.getElementById('guest-paid-amount').value) || 0;
            const paymentStatus = document.getElementById('guest-payment-status').value;

            const autoPaymentStatus = paidAmount === 0 ? 'pending' : (paidAmount >= totalAmount ? 'paid' : 'partial');
            const finalPaymentStatus = paymentStatus || autoPaymentStatus;

            if (guestId !== null) {
                // Editar convidado existente
                const index = state.guests.findIndex(g => g.id === guestId);
                if (index !== -1) {
                    state.guests[index] = {
                        ...state.guests[index], // Mantém o accessCode e outros dados
                        name, email, phone, totalAmount, paidAmount,
                        paymentStatus: finalPaymentStatus,
                        lastPaymentDate: paidAmount > state.guests[index].paidAmount ? new Date().toISOString() : state.guests[index].lastPaymentDate
                    };
                }
            } else {
                // Adicionar novo convidado
                
                // Gerar código de acesso único
                const existingCodes = new Set(state.guests.map(g => g.accessCode));
                let newCode;
                do {
                    newCode = Math.floor(1000 + Math.random() * 9000);
                } while (existingCodes.has(newCode));

                const newGuest = {
                    id: Date.now(),
                    name, email, phone, totalAmount, paidAmount,
                    paymentStatus: finalPaymentStatus,
                    checkedIn: false,
                    regOrder: state.guests.length + 1,
                    lastPaymentDate: paidAmount > 0 ? new Date().toISOString() : null,
                    accessCode: newCode // Adiciona o novo código
                };
                
                state.guests.push(newGuest);
            }

            saveData();
            renderGuestsList();
            renderDashboard();
            renderPaymentsPage();
            closeAllModals();
        };

        const editGuest = (guestId) => {
            showGuestModal(guestId);
        };

        // ===== PÁGINA DE FORNECEDORES =====
        const renderSuppliersPage = () => {
            renderSuppliersList();
        };

        const renderSuppliersList = () => {
            const container = document.getElementById('suppliers-list');
            
            if (state.suppliers.length === 0) {
                container.innerHTML = '<li class="list-item">Nenhum fornecedor cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            
            state.suppliers.forEach(supplier => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-truck"></i>
                        <div>
                            <div><strong>${supplier.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${supplier.service}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span>${formatCurrency(supplier.cost || 0)}</span>
                        <button class="btn secondary" onclick="editSupplier(${supplier.id})"><i class="fa-solid fa-edit"></i></button>
                        <button class="delete-btn" onclick="confirmDelete(${supplier.id}, 'supplier')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        };

        const showSupplierModal = (supplierId = null) => {
            const modal = document.getElementById('supplier-modal');
            const title = document.getElementById('supplier-modal-title');
            const form = document.getElementById('supplier-form');
            
            const isEditing = supplierId !== null;
            const supplier = isEditing ? state.suppliers.find(s => s.id === supplierId) : null;
            
            title.textContent = isEditing ? 'Editar Fornecedor' : 'Adicionar Fornecedor';
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="supplier-name">Nome</label>
                    <input type="text" id="supplier-name" value="${supplier ? supplier.name : ''}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-service">Serviço</label>
                    <input type="text" id="supplier-service" value="${supplier ? supplier.service : ''}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-phone">Telefone</label>
                    <input type="tel" id="supplier-phone" value="${supplier ? supplier.phone : ''}">
                </div>
                <div class="form-control">
                    <label for="supplier-cost">Custo</label>
                    <input type="number" id="supplier-cost" step="0.01" value="${supplier ? supplier.cost : '0'}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-paid">Valor Pago</label>
                    <input type="number" id="supplier-paid" step="0.01" value="${supplier ? supplier.paid : '0'}" required>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary" onclick="closeAllModals()">Cancelar</button>
                    <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                </div>
            `;
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveSupplierData(supplierId);
            };
            
            modal.classList.add('active');
        };

        const saveSupplierData = (supplierId = null) => {
            const name = document.getElementById('supplier-name').value;
            const service = document.getElementById('supplier-service').value;
            const phone = document.getElementById('supplier-phone').value;
            const cost = parseFloat(document.getElementById('supplier-cost').value) || 0;
            const paid = parseFloat(document.getElementById('supplier-paid').value) || 0;
            
            if (supplierId !== null) {
                // Editar fornecedor existente
                const index = state.suppliers.findIndex(s => s.id === supplierId);
                if (index !== -1) {
                    state.suppliers[index] = {
                        ...state.suppliers[index],
                        name,
                        service,
                        phone,
                        cost,
                        paid
                    };
                }
            } else {
                // Adicionar novo fornecedor
                state.suppliers.push({
                    id: Date.now(),
                    name,
                    service,
                    phone,
                    cost,
                    paid
                });
            }
            
            saveData();
            renderSuppliersList();
            renderDashboard();
            renderPaymentsPage();
            closeAllModals();
        };

        const editSupplier = (supplierId) => {
            showSupplierModal(supplierId);
        };

        // ===== PÁGINA DE PAGAMENTOS =====
        const renderPaymentsPage = () => {
            // Calcular totais
            const totalReceived = state.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalPending = state.guests.reduce((sum, guest) => {
                const total = guest.totalAmount || 0;
                const paid = guest.paidAmount || 0;
                return sum + (total - paid);
            }, 0);
            
            document.getElementById('payments-total-received').textContent = formatCurrency(totalReceived);
            document.getElementById('payments-total-pending').textContent = formatCurrency(totalPending);
            
            // Renderizar listas
            renderGuestPaymentsList();
            renderSupplierPaymentsList();
        };

        const renderGuestPaymentsList = () => {
            const container = document.getElementById('guest-payments-list');
            
            if (state.guests.length === 0) {
                container.innerHTML = '<li class="list-item">Nenhum convidado cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            
            state.guests.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const paymentStatus = guest.paymentStatus || 'pending';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-user"></i>
                        <div>
                            <div><strong>${guest.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${guest.phone || guest.email}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span>${formatCurrency(paidAmount)} / ${formatCurrency(totalAmount)}</span>
                        <button class="btn secondary" onclick="editGuest(${guest.id})"><i class="fa-solid fa-edit"></i></button>
                        <button class="btn secondary" onclick="showReceipt(${guest.id})"><i class="fa-solid fa-receipt"></i></button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        };

        const renderSupplierPaymentsList = () => {
            const container = document.getElementById('supplier-payments-list');
            
            if (state.suppliers.length === 0) {
                container.innerHTML = '<li class="list-item">Nenhum fornecedor cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            
            state.suppliers.forEach(supplier => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const cost = supplier.cost || 0;
                const paid = supplier.paid || 0;
                const paymentStatus = paid >= cost ? 'paid' : paid > 0 ? 'partial' : 'pending';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-truck"></i>
                        <div>
                            <div><strong>${supplier.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${supplier.service}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span>${formatCurrency(paid)} / ${formatCurrency(cost)}</span>
                        <button class="btn secondary" onclick="editSupplier(${supplier.id})"><i class="fa-solid fa-edit"></i></button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        };

        // ===== PÁGINA DE CONTROLE DE ENTRADA =====
        const renderCheckinPage = () => {
            const form = document.getElementById('checkin-form');
            const input = document.getElementById('checkin-code');
            const resultDiv = document.getElementById('checkin-result');

            form.onsubmit = (e) => {
                e.preventDefault();
                processCheckinCode();
            };

            // Limpa o resultado ao focar no input
            input.onfocus = () => {
                resultDiv.style.display = 'none';
            }
        };

        const processCheckinCode = () => {
            const input = document.getElementById('checkin-code');
            const code = input.value;
            const resultDiv = document.getElementById('checkin-result');

            if (!code || code.length !== 4) {
                resultDiv.innerHTML = `<h4>Código Inválido</h4><p>O código de acesso deve ter 4 dígitos.</p>`;
                resultDiv.className = 'checkin-result error';
                resultDiv.style.display = 'block';
                return;
            }

            // Encontra o convidado pelo código de acesso
            const guest = state.guests.find(g => g.accessCode == code); // Use == para comparar string com número

            if (!guest) {
                resultDiv.innerHTML = `<h4>Código Inválido</h4><p>Nenhum convidado encontrado com este código.</p>`;
                resultDiv.className = 'checkin-result error';
            } else {
                if (guest.checkedIn) {
                    resultDiv.innerHTML = `<h4>Entrada já Registrada</h4><p><strong>${guest.name}</strong> já fez check-in.</p><p>Horário: ${new Date(guest.checkinTime).toLocaleString('pt-BR')}</p>`;
                    resultDiv.className = 'checkin-result pending';
                } else if (guest.paymentStatus === 'paid') {
                    // Pagamento integral - Acesso liberado
                    guest.checkedIn = true;
                    guest.checkinTime = new Date().toISOString();
                    saveData(); // Salva o status do check-in
                    
                    resultDiv.innerHTML = `<h4>Acesso Liberado!</h4><p>Bem-vindo(a), <strong>${guest.name}</strong>!</p><p>Pagamento confirmado.</p>`;
                    resultDiv.className = 'checkin-result success';
                    
                    // Atualiza a lista de convidados em segundo plano
                    if (document.getElementById('guests-list').innerHTML) {
                        renderGuestsList();
                    }
                } else {
                    // Pagamento pendente ou parcial
                    resultDiv.innerHTML = `<h4>Pagamento Pendente</h4><p>A entrada de <strong>${guest.name}</strong> não pode ser liberada.</p><p>Status do Pagamento: <strong>${getPaymentStatusText(guest.paymentStatus)}</strong>.</p><p>Favor regularizar a situação.</p>`;
                    resultDiv.className = 'checkin-result error';
                }
            }

            resultDiv.style.display = 'block';
            input.value = ''; // Limpa o campo
        };

        // ===== PÁGINA DE RELATÓRIOS =====
        const renderReportsPage = () => {
            // Calcular totais
            const totalIncome = state.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalExpenses = calculateTotalCost();
            const finalBalance = totalIncome - totalExpenses;
            
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('final-balance').textContent = formatCurrency(finalBalance);
            
            // Renderizar detalhes
            renderBalanceDetails();
            renderGuestPaymentsDetails();
            renderExpensesDetails();
            
            // Configurar botões de geração de PDF
            document.getElementById('generate-balance-report-btn').onclick = () => generateBalancePDF();
            document.getElementById('generate-guest-payments-report-btn').onclick = () => generateGuestPaymentsPDF();
            document.getElementById('generate-expenses-report-btn').onclick = () => generateExpensesPDF();
        };

        const renderBalanceDetails = () => {
            const container = document.getElementById('balance-details');
            const totalIncome = state.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalExpenses = calculateTotalCost();
            const finalBalance = totalIncome - totalExpenses;
            
            container.innerHTML = `
                <tr><td style="padding: 10px; border-bottom: 1px solid #eee;">Total de Receitas</td><td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(totalIncome)}</td></tr>
                <tr><td style="padding: 10px; border-bottom: 1px solid #eee;">Total de Despesas</td><td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(totalExpenses)}</td></tr>
                <tr><td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Saldo Final</strong></td><td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;"><strong>${formatCurrency(finalBalance)}</strong></td></tr>
            `;
        };

        const renderGuestPaymentsDetails = () => {
            const container = document.getElementById('guest-payments-details');
            
            if (state.guests.length === 0) {
                container.innerHTML = '<tr><td colspan="3" style="padding: 10px; text-align: center;">Nenhum convidado cadastrado</td></tr>';
                return;
            }
            
            let html = '';
            state.guests.forEach(guest => {
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const pendingAmount = totalAmount - paidAmount;
                
                html += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${guest.name}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(paidAmount)}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(pendingAmount)}</td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        };

        const renderExpensesDetails = () => {
            const container = document.getElementById('expenses-details');
            const costs = state.eventData.costs || {};
            const suppliersTotal = state.suppliers.reduce((sum, supplier) => sum + (supplier.cost || 0), 0);
            const totalCost = calculateTotalCost();
            
            let html = '';
            
            // Custos fixos do evento
            Object.entries(costs).forEach(([category, amount]) => {
                if (amount > 0) {
                    html += `
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${getCostCategoryName(category)}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(amount)}</td>
                        </tr>
                    `;
                }
            });
            
            // Custos com fornecedores
            state.suppliers.forEach(supplier => {
                html += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${supplier.name} (${supplier.service})</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(supplier.cost || 0)}</td>
                    </tr>
                `;
            });
            
            // Total
            html += `
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Total de Despesas</strong></td>
                    <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;"><strong>${formatCurrency(totalCost)}</strong></td>
                </tr>
            `;
            
            container.innerHTML = html;
        };

        // ===== PÁGINA DE BACKUP =====
        const renderBackupPage = () => {
            // Configurar botões de exportação
            document.getElementById('export-data-btn').onclick = exportAllData;
            document.getElementById('export-guests-btn').onclick = exportGuestsData;
            document.getElementById('import-data-btn').onclick = importData;
            document.getElementById('clear-data-btn').onclick = confirmClearData;
        };

        const exportAllData = () => {
            const data = {
                eventData: state.eventData,
                guests: state.guests,
                suppliers: state.suppliers,
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(data, 'eventos-pro-backup-completo.json');
        };

        const exportGuestsData = () => {
            const data = {
                guests: state.guests,
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(data, 'eventos-pro-convidados.json');
        };

        const importData = () => {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo de backup.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Mesclar dados importados com dados existentes
                    if (importedData.eventData) {
                        state.eventData = { ...state.eventData, ...importedData.eventData };
                    }
                    
                    if (importedData.guests) {
                        // Adicionar novos convidados (evitar duplicação por ID)
                        importedData.guests.forEach(importedGuest => {
                            const existingIndex = state.guests.findIndex(g => g.id === importedGuest.id);
                            if (existingIndex === -1) {
                                state.guests.push(importedGuest);
                            } else {
                                state.guests[existingIndex] = importedGuest;
                            }
                        });
                    }
                    
                    if (importedData.suppliers) {
                        // Adicionar novos fornecedores (evitar duplicação por ID)
                        importedData.suppliers.forEach(importedSupplier => {
                            const existingIndex = state.suppliers.findIndex(s => s.id === importedSupplier.id);
                            if (existingIndex === -1) {
                                state.suppliers.push(importedSupplier);
                            } else {
                                state.suppliers[existingIndex] = importedSupplier;
                            }
                        });
                    }
                    
                    saveData();
                    alert('Dados importados com sucesso!');
                    location.reload(); // Recarregar para atualizar todas as visualizações
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    alert('Erro ao importar dados. Verifique se o arquivo é válido.');
                }
            };
            
            reader.readAsText(file);
        };

        const confirmClearData = () => {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
                localStorage.removeItem('eventManagementData_v2');
                alert('Todos os dados foram removidos.');
                location.reload();
            }
        };

        const downloadJSON = (data, filename) => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ===== COMPROVANTE DE PAGAMENTO (PDF) =====
        const showReceipt = (guestId) => {
            const guest = state.guests.find(g => g.id === guestId);
            if (!guest) {
                alert('Convidado não encontrado!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [100, 150] // Um formato de "recibo" (10cm x 15cm)
            });

            // --- Estilos ---
            const primaryColor = '#5636D3';
            const textColor = '#363F5F';
            const lightTextColor = '#969CB2';
            const dangerColor = '#E83F5B';
            const successColor = '#12A454'; // Cor para o sucesso
            const margin = 10;
            let yPosition = 15;

            // --- Cabeçalho ---
            doc.setFontSize(16);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Eventos Pro', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 6;
            
            doc.setFontSize(10);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'normal');
            doc.text('Comprovante de Pagamento', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 4;
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(primaryColor);
            doc.line(margin, yPosition, doc.internal.pageSize.getWidth() - margin, yPosition);
            yPosition += 10;

            // --- Detalhes ---
            const addDetail = (label, value) => {
                doc.setFontSize(10);
                doc.setTextColor(lightTextColor);
                doc.setFont(undefined, 'normal');
                doc.text(label, margin, yPosition);
                
                doc.setTextColor(textColor);
                doc.setFont(undefined, 'bold');
                doc.text(String(value), doc.internal.pageSize.getWidth() - margin, yPosition, { align: 'right' }); // Converte valor para string
                
                yPosition += 7;
            };

            addDetail('Convidado:', guest.name);
            addDetail('Telefone:', guest.phone || 'N/A');
            addDetail('Data do Evento:', state.eventData.date ? new Date(state.eventData.date).toLocaleDateString('pt-BR') : 'N/A');
            yPosition += 3; // Espaço
            addDetail('Valor Total:', formatCurrency(guest.totalAmount || 0));
            addDetail('Valor Pago:', formatCurrency(guest.paidAmount || 0));
            addDetail('Status:', getPaymentStatusText(guest.paymentStatus));
            yPosition += 3; // Espaço

            // --- Código de Acesso ---
            doc.setFontSize(10);
            doc.setTextColor(lightTextColor);
            doc.setFont(undefined, 'normal');
            doc.text('Código de Acesso:', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 10;

            doc.setFontSize(22);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text(String(guest.accessCode), doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // ===== INÍCIO DA MODIFICAÇÃO =====
            // Adicionar aviso de pendência ou mensagem de sucesso
            if (guest.paymentStatus !== 'paid') {
                doc.setFontSize(10);
                doc.setTextColor(dangerColor); // Cor vermelha de perigo
                doc.setFont(undefined, 'bold');
                
                const avisoText = "A entrada só será liberada com o PAGAMENTO INTEGRAL.";
                const splitText = doc.splitTextToSize(avisoText, doc.internal.pageSize.getWidth() - (margin * 2)); 
                
                doc.text(splitText, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
                yPosition += (splitText.length * 5) + 5; 
            } else {
                // Mensagem de pagamento total efetuado
                doc.setFontSize(10);
                doc.setTextColor(successColor); // Cor verde de sucesso
                doc.setFont(undefined, 'bold');
                
                const avisoText = "PAGAMENTO TOTAL efetuado, apresente seu recibo na entrada e curta a festa";
                const splitText = doc.splitTextToSize(avisoText, doc.internal.pageSize.getWidth() - (margin * 2));
                
                doc.text(splitText, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
                yPosition += (splitText.length * 5) + 5;
            }
            // ===== FIM DA MODIFICAÇÃO =====

            // --- Rodapé ---
            doc.setLineWidth(0.2);
            doc.setDrawColor(lightTextColor);
            doc.line(margin, yPosition, doc.internal.pageSize.getWidth() - margin, yPosition);
            yPosition += 5;

            doc.setFontSize(8);
            doc.setTextColor(lightTextColor);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            
            // --- Salvar ---
            doc.save(`recibo-${guest.name.replace(/ /g, '_')}-${guest.id}.pdf`);
        };

        // ===== EXCLUSÃO DE ITENS =====
        const confirmDelete = (id, type) => {
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-modal-title');
            const message = document.getElementById('delete-message');
            
            state.currentEditingId = id;
            state.currentEditingType = type;
            
            if (type === 'guest') {
                const guest = state.guests.find(g => g.id === id);
                title.textContent = 'Excluir Convidado';
                message.textContent = `Tem certeza que deseja excluir o convidado "${guest.name}"? Esta ação não pode ser desfeita.`;
            } else if (type === 'supplier') {
                const supplier = state.suppliers.find(s => s.id === id);
                title.textContent = 'Excluir Fornecedor';
                message.textContent = `Tem certeza que deseja excluir o fornecedor "${supplier.name}"? Esta ação não pode ser desfeita.`;
            }
            
            modal.classList.add('active');
        };

        // Configurar botões de confirmação de exclusão
        document.getElementById('confirm-delete-btn').onclick = () => {
            if (state.currentEditingType === 'guest') {
                state.guests = state.guests.filter(g => g.id !== state.currentEditingId);
                saveData();
                renderGuestsList();
                renderDashboard();
                renderPaymentsPage();
            } else if (state.currentEditingType === 'supplier') {
                state.suppliers = state.suppliers.filter(s => s.id !== state.currentEditingId);
                saveData();
                renderSuppliersList();
                renderDashboard();
                renderPaymentsPage();
            }
            
            closeAllModals();
        };

        document.getElementById('cancel-delete-btn').onclick = closeAllModals;

        // ===== GERAÇÃO DE PDF (Relatórios) =====
        const generateBalancePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.setTextColor(86, 54, 211);
            doc.text('Relatório Financeiro - Eventos Pro', 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Evento: ${state.eventData.name || 'Não definido'}`, 20, 35);
            doc.text(`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
            
            // Resumo
            const totalIncome = state.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalExpenses = calculateTotalCost();
            const finalBalance = totalIncome - totalExpenses;
            
            doc.setFontSize(14);
            doc.text('Resumo Financeiro', 20, 60);
            
            doc.setFontSize(12);
            doc.text(`Total de Receitas: ${formatCurrency(totalIncome)}`, 20, 72);
            doc.text(`Total de Despesas: ${formatCurrency(totalExpenses)}`, 20, 80);
            doc.text(`Saldo Final: ${formatCurrency(finalBalance)}`, 20, 88);
            
            // Detalhes das Despesas
            let yPosition = 110;
            doc.setFontSize(14);
            doc.text('Detalhes das Despesas', 20, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            const costs = state.eventData.costs || {};
            Object.entries(costs).forEach(([category, amount]) => {
                if (amount > 0) {
                    doc.text(`${getCostCategoryName(category)}: ${formatCurrency(amount)}`, 20, yPosition);
                    yPosition += 6;
                }
            });
            
            state.suppliers.forEach(supplier => {
                doc.text(`${supplier.name} (${supplier.service}): ${formatCurrency(supplier.cost || 0)}`, 20, yPosition);
                yPosition += 6;
            });
            
            // Salvar PDF
            doc.save(`relatorio-financeiro-${new Date().toISOString().split('T')[0]}.pdf`);
        };

        const generateGuestPaymentsPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.setTextColor(86, 54, 211);
            doc.text('Relatório de Pagamentos - Convidados', 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Evento: ${state.eventData.name || 'Não definido'}`, 20, 35);
            doc.text(`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
            
            // Tabela de pagamentos
            let yPosition = 60;
            doc.setFontSize(14);
            doc.text('Pagamentos dos Convidados', 20, yPosition);
            yPosition += 10;
            
            // Cabeçalho da tabela
            doc.setFillColor(86, 54, 211);
            doc.setTextColor(255, 255, 255);
            doc.rect(20, yPosition, 170, 8, 'F');
            doc.text('Nome', 22, yPosition + 6);
            doc.text('Valor Pago', 120, yPosition + 6);
            doc.text('Valor Pendente', 150, yPosition + 6);
            
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            // Dados da tabela
            state.guests.forEach(guest => {
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const pendingAmount = totalAmount - paidAmount;
                
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(guest.name, 22, yPosition + 6);
                doc.text(formatCurrency(paidAmount), 120, yPosition + 6);
                doc.text(formatCurrency(pendingAmount), 150, yPosition + 6);
                
                yPosition += 8;
            });
            
            // Salvar PDF
            doc.save(`relatorio-pagamentos-${new Date().toISOString().split('T')[0]}.pdf`);
        };

        const generateExpensesPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFontSize(20);
            doc.setTextColor(86, 54, 211);
            doc.text('Relatório de Despesas - Eventos Pro', 20, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Evento: ${state.eventData.name || 'Não definido'}`, 20, 35);
            doc.text(`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`, 20, 42);
            
            // Tabela de despesas
            let yPosition = 60;
            doc.setFontSize(14);
            doc.text('Detalhes das Despesas', 20, yPosition);
            yPosition += 10;
            
            // Cabeçalho da tabela
            doc.setFillColor(86, 54, 211);
            doc.setTextColor(255, 255, 255);
            doc.rect(20, yPosition, 170, 8, 'F');
            doc.text('Descrição', 22, yPosition + 6);
            doc.text('Valor', 150, yPosition + 6);
            
            yPosition += 8;
            doc.setTextColor(0, 0, 0);
            
            // Custos fixos
            const costs = state.eventData.costs || {};
            Object.entries(costs).forEach(([category, amount]) => {
                if (amount > 0) {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(getCostCategoryName(category), 22, yPosition + 6);
                    doc.text(formatCurrency(amount), 150, yPosition + 6);
                    yPosition += 8;
                }
            });
            
            // Fornecedores
            state.suppliers.forEach(supplier => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(`${supplier.name} (${supplier.service})`, 22, yPosition + 6);
                doc.text(formatCurrency(supplier.cost || 0), 150, yPosition + 6);
                yPosition += 8;
            });
            
            // Total
            const totalCost = calculateTotalCost();
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Total de Despesas:', 22, yPosition + 6);
            doc.text(formatCurrency(totalCost), 150, yPosition + 6);
            
            // Salvar PDF
            doc.save(`relatorio-despesas-${new Date().toISOString().split('T')[0]}.pdf`);
        };

        // ===== INICIALIZAÇÃO =====
        const init = () => {
            initializeData();
            setupNavigation();
            setupModals();
            renderDashboard();
            
            // Expor funções globais para uso nos event handlers
            window.editGuest = editGuest;
            window.editSupplier = editSupplier;
            window.confirmDelete = confirmDelete;
            window.showReceipt = showReceipt;
            window.closeAllModals = closeAllModals;
        };

        // Iniciar aplicação
        init();
    });
    </script>
</body>
</html>
