<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pro - Sistema de Controle</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        :root {
            --primary-color: #5636D3;
            --secondary-color: #FF872C;
            --success-color: #12A454;
            --danger-color: #E83F5B;
            --pending-color: #4B90F7;
            --background-color: #F0F2F5;
            --text-color: #363F5F;
            --text-light-color: #969CB2;
            --card-bg-color: #FFFFFF;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
        }
        
        /* --- Layout Geral --- */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg-color);
            height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: fixed;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            padding: 2rem 3rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        header h2 {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }
        
        /* --- Sidebar --- */
        .sidebar .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3rem;
        }
        
        .sidebar .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .sidebar .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .sidebar nav ul {
            list-style: none;
        }
        
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-light-color);
            font-weight: 500;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sidebar nav li a:hover,
        .sidebar nav li a.active {
            background-color: #f0edff;
            color: var(--primary-color);
        }
        
        .sidebar nav li a i {
            width: 20px;
            text-align: center;
        }
        
        /* --- Elementos Comuns --- */
        .card {
            background-color: var(--card-bg-color);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn.secondary {
            background-color: #e0e0e0;
            color: var(--text-color);
        }
        
        .btn.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn.download {
            background-color: var(--pending-color);
            color: white;
        }
        
        .list-item {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* --- Dashboard --- */
        #dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        /* Estilo "iPhone Widget" para os cards do dashboard */
        #dashboard-cards .card {
            border-radius: 22px; /* Mais arredondado */
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0,0,0,0.05); /* Borda sutil */
        }
        
        #dashboard-cards .card:hover {
            transform: scale(1.03); /* Efeito de escala ao passar o mouse */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--text-light-color);
        }
        
        .card-header i {
            font-size: 1.8rem;
        }
        
        #dashboard-cards .event i { color: var(--primary-color); }
        #dashboard-cards .guests i { color: var(--success-color); }
        #dashboard-cards .suppliers i { color: var(--secondary-color); }
        #dashboard-cards .payments i { color: var(--pending-color); }
        
        .card p {
            font-size: 2rem;
            font-weight: 500;
        }
        
        .transaction-details { display: flex; align-items: center; gap: 1rem; }
        .transaction-status { width: 10px; height: 10px; border-radius: 50%; }
        .transaction-status.paid { background-color: var(--success-color); }
        .transaction-status.pending { background-color: var(--pending-color); }
        .transaction-info span { display: block; }
        .transaction-info .description { font-weight: 500; }
        .transaction-info .details { font-size: 0.8rem; color: var(--text-light-color); }
        .transaction-amount { font-weight: 500; font-size: 1.1rem; }
        .transaction-amount.income { color: var(--success-color); }
        .transaction-amount.expense { color: var(--danger-color); }
        .list-item-actions { display: flex; align-items: center; gap: 1rem; }
        
        /* --- Páginas de Gerenciamento --- */
        .management-page .card { margin-bottom: 2rem; }
        .management-page form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .management-page .form-control { flex-grow: 1; min-width: 200px; }
        .management-page label { font-size: 0.9rem; margin-bottom: 0.25rem; display: block; }
        .management-page input, .management-page select, .management-page textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;
        }
        .management-page .list-item i { font-size: 1.2rem; margin-right: 1rem; color: var(--primary-color); }
        .list-item-main { flex-grow: 1; display: flex; align-items: center; }
        
        /* --- Página QR Code --- */
        .qr-code-container { text-align: center; margin: 20px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: white; }
        .qr-code { margin: 0 auto; max-width: 200px; display: flex; justify-content: center; align-items: center; height: 150px; }
        .qr-info { margin-top: 15px; font-size: 14px; color: #666; }
        .qr-scanner-container { width: 100%; max-width: 400px; margin: 2rem auto; text-align: center; }
        .qr-scanner {
            width: 100%; height: 300px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px;
            background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        .qr-scanner video, .qr-scanner canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .hidden { display: none; }
        .qr-result { margin-top: 15px; padding: 15px; border-radius: 10px; background-color: #f8f9fa; display: none; }
        .qr-result.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .qr-result.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .qr-result.pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        /* --- Página Relatórios --- */
        #reports-page .filters { background-color: #fff; padding: 1.5rem; margin-bottom: 2rem; border-radius: var(--border-radius); display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        #reports-page .filters .form-control { flex-grow: 1; min-width: 200px; }
        #reports-page .filters label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #reports-page .filters input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .report-card p { font-size: 1.5rem; }
        
        /* --- Modal e FAB --- */
        .fab { position: fixed; bottom: 2rem; right: 3rem; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 101; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 102; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-content h3 { margin-bottom: 1.5rem; }
        .form-control { margin-bottom: 1rem; }
        .form-control label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control input, .form-control select, .form-control textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
        .modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .modal-actions .spacer { flex-grow: 1; }
        
        /* --- Header Mobile --- */
        .mobile-header { display: none; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background-color: var(--card-bg-color); box-shadow: var(--box-shadow); margin-bottom: 1.5rem; }
        .mobile-header #menu-toggle-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .mobile-header h2 { font-size: 1.25rem; margin-bottom: 0; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        
        /* --- Status --- */
        .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .status.paid { background-color: #d4edda; color: #155724; }
        .status.pending { background-color: #fff3cd; color: #856404; }
        .status.partial { background-color: #cce7ff; color: #004085; }
        .checkin-status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .checkin-status.checked { background-color: #d4edda; color: #155724; }
        .checkin-status.not-checked { background-color: #f8d7da; color: #721c24; }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 0; }
            .page-content { padding: 0 1.5rem 1.5rem 1.5rem; }
            header { display: none; }
            .mobile-header { display: flex; }
            .form-grid { grid-template-columns: 1fr; }
            .fab { right: 1.5rem; bottom: 1.5rem; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .list-item-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fa-solid fa-calendar-alt"></i>
            <h1>Eventos Pro</h1>
        </div>
        <nav>
            <ul id="nav-links">
                <li><a data-page="dashboard-page" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                <li><a data-page="event-page"><i class="fa-solid fa-calendar-check"></i> Evento</a></li>
                <li><a data-page="guests-page"><i class="fa-solid fa-users"></i> Convidados</a></li>
                <li><a data-page="suppliers-page"><i class="fa-solid fa-truck"></i> Fornecedores</a></li>
                <li><a data-page="payments-page"><i class="fa-solid fa-money-bill-wave"></i> Pagamentos</a></li>
                <li><a data-page="qr-page"><i class="fa-solid fa-qrcode"></i> QR Code</a></li>
                <li><a data-page="reports-page"><i class="fa-solid fa-chart-line"></i> Relatórios</a></li>
                <li><a data-page="backup-page"><i class="fa-solid fa-database"></i> Backup</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="mobile-header">
            <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h2 id="mobile-page-title">Dashboard</h2>
        </header>

        <section id="dashboard-page" class="page-content active">
            <header><h2>Dashboard</h2></header>
            <div id="dashboard-cards">
                <div class="card event" data-page="event-page">
                    <div class="card-header"><span>Evento</span><i class="fa-solid fa-calendar-alt"></i></div>
                    <p id="dashboard-event-name">Configurar</p>
                </div>
                <div class="card guests" data-page="guests-page">
                    <div class="card-header"><span>Convidados</span><i class="fa-solid fa-users"></i></div>
                    <p id="dashboard-guest-count">0</p>
                </div>
                <div class="card suppliers" data-page="suppliers-page">
                    <div class="card-header"><span>Fornecedores</span><i class="fa-solid fa-truck"></i></div>
                    <p id="dashboard-supplier-count">0</p>
                </div>
                <div class="card payments" data-page="payments-page">
                    <div class="card-header"><span>Total Recebido</span><i class="fa-solid fa-arrow-up"></i></div>
                    <p id="dashboard-payment-total">R$ 0,00</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Resumo Financeiro</h3>
                <div class="form-grid">
                    <div><strong>Custo Total do Evento:</strong> <span id="total-cost">R$ 0,00</span></div>
                    <div><strong>Custo por Convidado:</strong> <span id="cost-per-guest">R$ 0,00</span></div>
                    <div><strong>Total Recebido:</strong> <span id="total-received" style="color: var(--success-color);">R$ 0,00</span></div>
                    <div><strong>Total a Receber:</strong> <span id="total-pending" style="color: var(--danger-color);">R$ 0,00</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>Últimos Pagamentos Recebidos</h3>
                <ul id="recent-payments-list"></ul>
            </div>
        </section>

        <section id="event-page" class="page-content management-page">
            <header><h2>Configuração do Evento</h2></header>
            <div class="card">
                <div class="card-header"><h3>Informações do Evento</h3><button class="btn primary" id="edit-event-btn">Editar Evento</button></div>
                <div id="event-info"></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Custos do Evento</h3><button class="btn primary" id="edit-costs-btn">Editar Custos</button></div>
                <div id="costs-info"></div>
            </div>
        </section>

        <section id="guests-page" class="page-content management-page">
            <header><h2>Lista de Convidados</h2></header>
            <div class="card">
                <div class="form-control"><input type="text" id="guest-search" placeholder="Buscar convidado..."></div>
            </div>
            <ul id="guests-list"></ul>
        </section>

        <section id="suppliers-page" class="page-content management-page">
            <header><h2>Fornecedores</h2></header>
            <ul id="suppliers-list"></ul>
        </section>

        <section id="payments-page" class="page-content">
            <header><h2>Controle de Pagamentos</h2></header>
            <div class="card">
                <div class="form-grid">
                    <div><h3>Total Recebido: <span id="payments-total-received" style="color: var(--success-color);">R$ 0,00</span></h3></div>
                    <div><h3>Total a Receber: <span id="payments-total-pending" style="color: var(--danger-color);">R$ 0,00</span></h3></div>
                </div>
            </div>
            <div class="card"><h3>Pagamentos Recebidos de Convidados</h3><ul id="guest-payments-list"></ul></div>
            <div class="card"><h3>Pagamentos Efetuados a Fornecedores</h3><ul id="supplier-payments-list"></ul></div>
        </section>

        <section id="qr-page" class="page-content">
            <header><h2>Controle de Entrada com QR Code</h2></header>
            <div class="card">
                <h3>Leitor de QR Code</h3>
                <p>Use esta ferramenta para escanear os QR Codes dos convidados na entrada do evento.</p>
                <div class="qr-scanner-container">
                    <div class="qr-scanner" id="qr-scanner">
                        <div id="qr-scanner-placeholder"><p>Clique em "Iniciar Câmera" para escanear</p></div>
                        <video id="qr-video" class="hidden" playsinline></video>
                        <canvas id="qr-canvas" class="hidden"></canvas>
                    </div>
                    <div class="modal-actions" style="justify-content: center;">
                        <button class="btn success" id="start-camera-btn">Iniciar Câmera</button>
                        <button class="btn secondary hidden" id="stop-camera-btn">Parar Câmera</button>
                    </div>
                    <div id="qr-result" class="qr-result"></div>
                </div>
            </div>
            <div class="card">
                <h3>QR Codes dos Convidados</h3>
                <p>Lista de convidados com seus respectivos QR Codes para entrada no evento.</p>
                <div id="qr-codes-list" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem;"></div>
            </div>
        </section>

        <section id="reports-page" class="page-content">
            <header><h2>Relatórios Financeiros</h2></header>
             <div id="report-summary">
                <div class="card"><div class="card-header"><span>Total de Receitas</span></div><p id="total-income">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Total de Despesas</span></div><p id="total-expenses">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Saldo Final</span></div><p id="final-balance">R$ 0,00</p></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Balanço Geral</h3><button class="btn download" id="generate-balance-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="balance-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Pagamentos de Convidados</h3><button class="btn download" id="generate-guest-payments-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="guest-payments-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Despesas do Evento</h3><button class="btn download" id="generate-expenses-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="expenses-details"></tbody></table>
            </div>
        </section>

        <section id="backup-page" class="page-content">
            <header><h2>Backup e Restauração</h2></header>
            <div class="card">
                <h3>Exportar Dados</h3>
                <p>Faça backup de todos os dados do sistema para um arquivo JSON.</p>
                <div class="modal-actions">
                    <button class="btn success" id="export-data-btn">Exportar Tudo</button>
                    <button class="btn success" id="export-guests-btn">Exportar Convidados</button>
                </div>
            </div>
            <div class="card">
                <h3>Importar Dados</h3>
                <p>Restaurar dados de um backup anterior. A importação adicionará novos dados aos existentes.</p>
                <div class="form-control"><label for="backup-file">Selecionar arquivo de backup (.json)</label><input type="file" id="backup-file" accept=".json"></div>
                <div class="modal-actions">
                    <button class="btn secondary" id="import-data-btn">Importar Dados</button>
                </div>
            </div>
            <div class="card">
                <h3>Limpar Dados</h3>
                <p>Remover todos os dados do sistema. Esta ação não pode ser desfeita.</p>
                <div class="modal-actions"><button class="btn danger" id="clear-data-btn">Limpar Todos os Dados</button></div>
            </div>
        </section>
    </main>

    <button class="fab" id="fab-add-btn" style="display: none;"><i class="fa-solid fa-plus"></i></button>

    <div class="modal-overlay" id="event-modal"><div class="modal-content"><h3 id="event-modal-title"></h3><form id="event-form"></form></div></div>
    <div class="modal-overlay" id="costs-modal"><div class="modal-content"><h3 id="costs-modal-title"></h3><form id="costs-form"></form></div></div>
    <div class="modal-overlay" id="guest-modal"><div class="modal-content"><h3 id="guest-modal-title"></h3><form id="guest-form"></form></div></div>
    <div class="modal-overlay" id="supplier-modal"><div class="modal-content"><h3 id="supplier-modal-title"></h3><form id="supplier-form"></form></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-content"><h3 id="delete-modal-title"></h3><p id="delete-message"></p><div class="modal-actions"><button type="button" class="btn secondary" id="cancel-delete-btn">Cancelar</button><button type="button" class="btn danger" id="confirm-delete-btn">Excluir</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===== ESTADO CENTRAL DA APLICAÇÃO =====
        const state = {
            eventData: {},
            guests: [],
            suppliers: [],
            activePage: 'dashboard-page',
            currentEditingId: null,
            currentEditingType: null,
            qrScannerStream: null,
            qrScannerAnimationId: null
        };

        // ===== SELETORES DE ELEMENTOS COMUNS =====
        const selectors = {
            navLinks: document.getElementById('nav-links'),
            pages: document.querySelectorAll('.page-content'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            mobilePageTitle: document.getElementById('mobile-page-title'),
            fab: document.getElementById('fab-add-btn'),
            dashboardCardsContainer: document.getElementById('dashboard-cards')
        };
        
        // ===== FUNÇÕES AUXILIARES =====
        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getPaymentStatusText = (status) => ({ paid: 'Pago', partial: 'Parcial', pending: 'Pendente' }[status] || 'Pendente');
        const getCostCategoryName = (category) => ({ food: 'Alimentação', music: 'Música', venue: 'Aluguel do Espaço', drinks: 'Bebidas', other: 'Outros Custos' }[category] || category);
        const calculateTotalCost = () => (Object.values(state.eventData.costs || {}).reduce((s, c) => s + c, 0)) + (state.suppliers.reduce((s, sup) => s + (sup.cost || 0), 0));

        // ===== PERSISTÊNCIA DE DADOS (LocalStorage) =====
        const initializeData = () => {
            const savedData = JSON.parse(localStorage.getItem('eventManagementData_v2'));
            if (savedData) {
                state.eventData = savedData.eventData || { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
                state.guests = savedData.guests || [];
                // Migração de dados para garantir que convidados antigos tenham as novas propriedades
                state.guests.forEach((guest, index) => {
                    if (!guest.regOrder) {
                        guest.regOrder = index + 1;
                    }
                    if (!guest.qrCode) {
                        guest.qrCode = ''; 
                    }
                });
                state.suppliers = savedData.suppliers || [];
            } else {
                 state.eventData = { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
            }
            state.activePage = localStorage.getItem('eventActivePage_v2') || 'dashboard-page';
        };

        const saveState = () => {
            const dataToSave = { eventData: state.eventData, guests: state.guests, suppliers: state.suppliers };
            localStorage.setItem('eventManagementData_v2', JSON.stringify(dataToSave));
            localStorage.setItem('eventActivePage_v2', state.activePage);
        };

        // ===== NAVEGAÇÃO E CONTROLE DA UI =====
        const navigateTo = (pageId) => {
            state.activePage = pageId;
            const activeLink = document.querySelector(`.sidebar nav a[data-page="${pageId}"]`);
            document.querySelector('.sidebar nav a.active')?.classList.remove('active');
            activeLink?.classList.add('active');
            
            selectors.mobilePageTitle.textContent = activeLink?.textContent.trim() || 'Dashboard';
            selectors.pages.forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');

            selectors.fab.style.display = ['guests-page', 'suppliers-page'].includes(pageId) ? 'flex' : 'none';
            
            if (window.innerWidth <= 768) {
                selectors.sidebar.classList.remove('open');
                selectors.sidebarOverlay.classList.remove('active');
            }
            app.renderActivePage();
        };

        // ===== MODAIS =====
        const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        const app = {
            // ===== LÓGICA DE RENDERIZAÇÃO DAS PÁGINAS =====
            renderDashboard() {
                document.getElementById('dashboard-event-name').textContent = state.eventData.name || 'Configurar';
                document.getElementById('dashboard-guest-count').textContent = state.guests.length;
                document.getElementById('dashboard-supplier-count').textContent = state.suppliers.length;
                const totalReceived = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                document.getElementById('dashboard-payment-total').textContent = formatCurrency(totalReceived);

                const totalCost = calculateTotalCost();
                document.getElementById('total-cost').textContent = formatCurrency(totalCost);
                document.getElementById('cost-per-guest').textContent = formatCurrency(state.guests.length ? totalCost / state.guests.length : 0);
                document.getElementById('total-received').textContent = formatCurrency(totalReceived);
                const totalPending = state.guests.reduce((s, g) => s + (g.expectedValue || 0) - (g.paidValue || 0), 0);
                document.getElementById('total-pending').textContent = formatCurrency(totalPending);

                const recentPaymentsList = document.getElementById('recent-payments-list');
                recentPaymentsList.innerHTML = '';
                const recentPayments = state.guests.filter(g => g.paidValue > 0).sort((a, b) => new Date(b.paymentDate || 0) - new Date(a.paymentDate || 0)).slice(0, 5);
                if (recentPayments.length === 0) {
                    recentPaymentsList.innerHTML = '<li class="list-item"><span>Nenhum pagamento recebido ainda</span></li>';
                } else {
                    recentPayments.forEach(guest => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="transaction-details">
                                <div class="transaction-status paid"></div>
                                <div class="transaction-info">
                                    <span class="description">${guest.name}</span>
                                    <span class="details">${guest.paymentDate ? new Date(guest.paymentDate).toLocaleDateString('pt-BR') : 'Data não informada'}</span>
                                </div>
                            </div>
                            <div class="transaction-amount income">${formatCurrency(guest.paidValue)}</div>
                        `;
                        recentPaymentsList.appendChild(li);
                    });
                }
            },

            renderEventPage() {
                const eventInfo = document.getElementById('event-info');
                if (!state.eventData.name) {
                    eventInfo.innerHTML = '<p>Nenhum evento configurado. Clique em "Editar Evento" para começar.</p>';
                } else {
                    eventInfo.innerHTML = `
                        <div class="form-grid">
                            <div><strong>Nome do Evento:</strong> ${state.eventData.name}</div>
                            <div><strong>Data:</strong> ${state.eventData.date ? new Date(state.eventData.date).toLocaleDateString('pt-BR') : 'Não definida'}</div>
                            <div><strong>Local:</strong> ${state.eventData.location || 'Não definido'}</div>
                            <div><strong>Descrição:</strong> ${state.eventData.description || 'Não definida'}</div>
                        </div>
                    `;
                }

                const costsInfo = document.getElementById('costs-info');
                const totalCost = calculateTotalCost();
                let costsHtml = `<div class="form-grid"><div><strong>Custo Total:</strong> ${formatCurrency(totalCost)}</div></div><div class="form-grid">`;
                Object.entries(state.eventData.costs || {}).forEach(([category, value]) => {
                    if (value > 0) {
                        costsHtml += `<div><strong>${getCostCategoryName(category)}:</strong> ${formatCurrency(value)}</div>`;
                    }
                });
                state.suppliers.forEach(s => {
                    if (s.cost > 0) {
                        costsHtml += `<div><strong>${s.name}:</strong> ${formatCurrency(s.cost)}</div>`;
                    }
                });
                costsHtml += '</div>';
                costsInfo.innerHTML = costsHtml;
            },

            renderGuestsPage() {
                const searchTerm = document.getElementById('guest-search').value.toLowerCase();
                const filteredGuests = state.guests.filter(g => g.name.toLowerCase().includes(searchTerm));
                const guestsList = document.getElementById('guests-list');
                guestsList.innerHTML = '';

                if (filteredGuests.length === 0) {
                    guestsList.innerHTML = '<li class="list-item"><span>Nenhum convidado encontrado</span></li>';
                    return;
                }

                filteredGuests.forEach(guest => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <div class="list-item-main">
                            <i class="fa-solid fa-user"></i>
                            <div>
                                <strong>${guest.name}</strong>
                                <div style="font-size: 0.9rem; color: var(--text-light-color);">
                                    ${guest.email || ''} ${guest.phone ? ' | ' + guest.phone : ''}
                                </div>
                                <div style="font-size: 0.8rem; margin-top: 0.25rem;">
                                    <span class="status ${guest.paymentStatus || 'pending'}">${getPaymentStatusText(guest.paymentStatus)}</span>
                                    <span class="checkin-status ${guest.checkedIn ? 'checked' : 'not-checked'}">${guest.checkedIn ? 'Confirmado' : 'Não confirmado'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <span>${formatCurrency(guest.paidValue || 0)} / ${formatCurrency(guest.expectedValue || 0)}</span>
                            <button class="delete-btn" data-id="${guest.id}" data-type="guest"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    guestsList.appendChild(li);
                });

                document.querySelectorAll('#guests-list .delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        const guest = state.guests.find(g => g.id === id);
                        document.getElementById('delete-modal-title').textContent = 'Excluir Convidado';
                        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o convidado "${guest.name}"?`;
                        document.getElementById('confirm-delete-btn').onclick = () => app.deleteItem(id, 'guest');
                        openModal('delete-modal');
                    });
                });

                document.querySelectorAll('#guests-list .list-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        const guestId = item.querySelector('.delete-btn').dataset.id;
                        app.openGuestModal(guestId);
                    });
                });
            },

            renderSuppliersPage() {
                const suppliersList = document.getElementById('suppliers-list');
                suppliersList.innerHTML = '';

                if (state.suppliers.length === 0) {
                    suppliersList.innerHTML = '<li class="list-item"><span>Nenhum fornecedor cadastrado</span></li>';
                    return;
                }

                state.suppliers.forEach(supplier => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <div class="list-item-main">
                            <i class="fa-solid fa-truck"></i>
                            <div>
                                <strong>${supplier.name}</strong>
                                <div style="font-size: 0.9rem; color: var(--text-light-color);">
                                    ${supplier.service || ''} ${supplier.contact ? ' | ' + supplier.contact : ''}
                                </div>
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <span>${formatCurrency(supplier.cost || 0)}</span>
                            <button class="delete-btn" data-id="${supplier.id}" data-type="supplier"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    suppliersList.appendChild(li);
                });

                document.querySelectorAll('#suppliers-list .delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        const supplier = state.suppliers.find(s => s.id === id);
                        document.getElementById('delete-modal-title').textContent = 'Excluir Fornecedor';
                        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o fornecedor "${supplier.name}"?`;
                        document.getElementById('confirm-delete-btn').onclick = () => app.deleteItem(id, 'supplier');
                        openModal('delete-modal');
                    });
                });

                document.querySelectorAll('#suppliers-list .list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const supplierId = item.querySelector('.delete-btn').dataset.id;
                        app.openSupplierModal(supplierId);
                    });
                });
            },

            renderPaymentsPage() {
                const guestPaymentsTotal = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                const guestPaymentsPending = state.guests.reduce((s, g) => s + (g.expectedValue || 0) - (g.paidValue || 0), 0);
                document.getElementById('payments-total-received').textContent = formatCurrency(guestPaymentsTotal);
                document.getElementById('payments-total-pending').textContent = formatCurrency(guestPaymentsPending);

                const guestPaymentsList = document.getElementById('guest-payments-list');
                guestPaymentsList.innerHTML = '';
                if (state.guests.length === 0) {
                    guestPaymentsList.innerHTML = '<li class="list-item"><span>Nenhum convidado cadastrado</span></li>';
                } else {
                    state.guests.forEach(guest => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="list-item-main">
                                <i class="fa-solid fa-user"></i>
                                <div>
                                    <strong>${guest.name}</strong>
                                    <div style="font-size: 0.9rem; color: var(--text-light-color);">
                                        ${guest.email || ''}
                                    </div>
                                </div>
                            </div>
                            <div class="list-item-actions">
                                <span class="status ${guest.paymentStatus || 'pending'}">${getPaymentStatusText(guest.paymentStatus)}</span>
                                <span>${formatCurrency(guest.paidValue || 0)} / ${formatCurrency(guest.expectedValue || 0)}</span>
                            </div>
                        `;
                        guestPaymentsList.appendChild(li);
                    });
                }

                const supplierPaymentsList = document.getElementById('supplier-payments-list');
                supplierPaymentsList.innerHTML = '';
                if (state.suppliers.length === 0) {
                    supplierPaymentsList.innerHTML = '<li class="list-item"><span>Nenhum fornecedor cadastrado</span></li>';
                } else {
                    state.suppliers.forEach(supplier => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="list-item-main">
                                <i class="fa-solid fa-truck"></i>
                                <div>
                                    <strong>${supplier.name}</strong>
                                    <div style="font-size: 0.9rem; color: var(--text-light-color);">
                                        ${supplier.service || ''}
                                    </div>
                                </div>
                            </div>
                            <div class="list-item-actions">
                                <span>${formatCurrency(supplier.cost || 0)}</span>
                            </div>
                        `;
                        supplierPaymentsList.appendChild(li);
                    });
                }
            },

            renderQRPage() {
                const qrCodesList = document.getElementById('qr-codes-list');
                qrCodesList.innerHTML = '';
                
                if (state.guests.length === 0) {
                    qrCodesList.innerHTML = '<p>Nenhum convidado cadastrado para gerar QR Codes.</p>';
                    return;
                }

                state.guests.forEach(guest => {
                    const guestCard = document.createElement('div');
                    guestCard.className = 'qr-code-container';
                    guestCard.style.width = '180px';
                    
                    const qrContainer = document.createElement('div');
                    qrContainer.className = 'qr-code';
                    qrContainer.id = `qr-${guest.id}`;
                    
                    const guestInfo = document.createElement('div');
                    guestInfo.className = 'qr-info';
                    guestInfo.innerHTML = `
                        <strong>${guest.name}</strong><br>
                        <span class="checkin-status ${guest.checkedIn ? 'checked' : 'not-checked'}">${guest.checkedIn ? 'Confirmado' : 'Pendente'}</span>
                    `;
                    
                    guestCard.appendChild(qrContainer);
                    guestCard.appendChild(guestInfo);
                    qrCodesList.appendChild(guestCard);
                    
                    // Gerar QR Code para o convidado
                    this.generateQRCodeForGuest(guest);
                });
            },

            renderReportsPage() {
                const totalIncome = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                const totalExpenses = calculateTotalCost();
                const finalBalance = totalIncome - totalExpenses;

                document.getElementById('total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('final-balance').textContent = formatCurrency(finalBalance);

                // Balanço Geral
                const balanceDetails = document.getElementById('balance-details');
                balanceDetails.innerHTML = `
                    <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Total de Receitas</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; color: var(--success-color);">${formatCurrency(totalIncome)}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Total de Despesas</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; color: var(--danger-color);">${formatCurrency(totalExpenses)}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">Saldo Final</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; color: ${finalBalance >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${formatCurrency(finalBalance)}</td></tr>
                `;

                // Pagamentos de Convidados
                const guestPaymentsDetails = document.getElementById('guest-payments-details');
                guestPaymentsDetails.innerHTML = '';
                state.guests.forEach(guest => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${guest.name}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(guest.paidValue || 0)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency((guest.expectedValue || 0) - (guest.paidValue || 0))}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><span class="status ${guest.paymentStatus || 'pending'}">${getPaymentStatusText(guest.paymentStatus)}</span></td>
                    `;
                    guestPaymentsDetails.appendChild(row);
                });

                // Despesas do Evento
                const expensesDetails = document.getElementById('expenses-details');
                expensesDetails.innerHTML = '';
                Object.entries(state.eventData.costs || {}).forEach(([category, value]) => {
                    if (value > 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${getCostCategoryName(category)}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(value)}</td>
                        `;
                        expensesDetails.appendChild(row);
                    }
                });
                state.suppliers.forEach(supplier => {
                    if (supplier.cost > 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${supplier.name} (${supplier.service})</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${formatCurrency(supplier.cost)}</td>
                        `;
                        expensesDetails.appendChild(row);
                    }
                });
            },

            renderActivePage() {
                switch (state.activePage) {
                    case 'dashboard-page': this.renderDashboard(); break;
                    case 'event-page': this.renderEventPage(); break;
                    case 'guests-page': this.renderGuestsPage(); break;
                    case 'suppliers-page': this.renderSuppliersPage(); break;
                    case 'payments-page': this.renderPaymentsPage(); break;
                    case 'qr-page': this.renderQRPage(); break;
                    case 'reports-page': this.renderReportsPage(); break;
                }
            },

            // ===== GERENCIAMENTO DE FORMULÁRIOS =====
            openEventModal() {
                document.getElementById('event-modal-title').textContent = state.eventData.name ? 'Editar Evento' : 'Criar Evento';
                const form = document.getElementById('event-form');
                form.innerHTML = `
                    <div class="form-control">
                        <label for="event-name">Nome do Evento</label>
                        <input type="text" id="event-name" value="${state.eventData.name || ''}" required>
                    </div>
                    <div class="form-control">
                        <label for="event-date">Data do Evento</label>
                        <input type="date" id="event-date" value="${state.eventData.date || ''}">
                    </div>
                    <div class="form-control">
                        <label for="event-location">Local</label>
                        <input type="text" id="event-location" value="${state.eventData.location || ''}">
                    </div>
                    <div class="form-control">
                        <label for="event-description">Descrição</label>
                        <textarea id="event-description" rows="3">${state.eventData.description || ''}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" onclick="closeModal('event-modal')">Cancelar</button>
                        <button type="submit" class="btn primary">Salvar</button>
                    </div>
                `;
                form.onsubmit = (e) => {
                    e.preventDefault();
                    state.eventData = {
                        ...state.eventData,
                        name: document.getElementById('event-name').value,
                        date: document.getElementById('event-date').value,
                        location: document.getElementById('event-location').value,
                        description: document.getElementById('event-description').value
                    };
                    saveState();
                    closeModal('event-modal');
                    this.renderActivePage();
                };
                openModal('event-modal');
            },

            openCostsModal() {
                document.getElementById('costs-modal-title').textContent = 'Editar Custos do Evento';
                const form = document.getElementById('costs-form');
                form.innerHTML = `
                    <div class="form-control">
                        <label for="cost-food">Alimentação</label>
                        <input type="number" id="cost-food" step="0.01" value="${state.eventData.costs?.food || 0}">
                    </div>
                    <div class="form-control">
                        <label for="cost-music">Música</label>
                        <input type="number" id="cost-music" step="0.01" value="${state.eventData.costs?.music || 0}">
                    </div>
                    <div class="form-control">
                        <label for="cost-venue">Aluguel do Espaço</label>
                        <input type="number" id="cost-venue" step="0.01" value="${state.eventData.costs?.venue || 0}">
                    </div>
                    <div class="form-control">
                        <label for="cost-drinks">Bebidas</label>
                        <input type="number" id="cost-drinks" step="0.01" value="${state.eventData.costs?.drinks || 0}">
                    </div>
                    <div class="form-control">
                        <label for="cost-other">Outros Custos</label>
                        <input type="number" id="cost-other" step="0.01" value="${state.eventData.costs?.other || 0}">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" onclick="closeModal('costs-modal')">Cancelar</button>
                        <button type="submit" class="btn primary">Salvar</button>
                    </div>
                `;
                form.onsubmit = (e) => {
                    e.preventDefault();
                    state.eventData.costs = {
                        food: parseFloat(document.getElementById('cost-food').value) || 0,
                        music: parseFloat(document.getElementById('cost-music').value) || 0,
                        venue: parseFloat(document.getElementById('cost-venue').value) || 0,
                        drinks: parseFloat(document.getElementById('cost-drinks').value) || 0,
                        other: parseFloat(document.getElementById('cost-other').value) || 0
                    };
                    saveState();
                    closeModal('costs-modal');
                    this.renderActivePage();
                };
                openModal('costs-modal');
            },

            openGuestModal(guestId = null) {
                const isEditing = guestId !== null;
                const guest = isEditing ? state.guests.find(g => g.id === guestId) : null;
                document.getElementById('guest-modal-title').textContent = isEditing ? 'Editar Convidado' : 'Adicionar Convidado';
                const form = document.getElementById('guest-form');
                form.innerHTML = `
                    <div class="form-control">
                        <label for="guest-name">Nome</label>
                        <input type="text" id="guest-name" value="${guest?.name || ''}" required>
                    </div>
                    <div class="form-control">
                        <label for="guest-email">E-mail</label>
                        <input type="email" id="guest-email" value="${guest?.email || ''}">
                    </div>
                    <div class="form-control">
                        <label for="guest-phone">Telefone</label>
                        <input type="tel" id="guest-phone" value="${guest?.phone || ''}">
                    </div>
                    <div class="form-control">
                        <label for="guest-expected-value">Valor Esperado (R$)</label>
                        <input type="number" id="guest-expected-value" step="0.01" value="${guest?.expectedValue || 0}">
                    </div>
                    <div class="form-control">
                        <label for="guest-paid-value">Valor Pago (R$)</label>
                        <input type="number" id="guest-paid-value" step="0.01" value="${guest?.paidValue || 0}">
                    </div>
                    <div class="form-control">
                        <label for="guest-payment-date">Data do Pagamento</label>
                        <input type="date" id="guest-payment-date" value="${guest?.paymentDate || ''}">
                    </div>
                    <div class="form-control">
                        <label for="guest-payment-status">Status do Pagamento</label>
                        <select id="guest-payment-status">
                            <option value="pending" ${guest?.paymentStatus === 'pending' ? 'selected' : ''}>Pendente</option>
                            <option value="partial" ${guest?.paymentStatus === 'partial' ? 'selected' : ''}>Parcial</option>
                            <option value="paid" ${guest?.paymentStatus === 'paid' ? 'selected' : ''}>Pago</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" onclick="closeModal('guest-modal')">Cancelar</button>
                        <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                    </div>
                `;
                form.onsubmit = (e) => {
                    e.preventDefault();
                    const guestData = {
                        id: guestId || Date.now().toString(),
                        name: document.getElementById('guest-name').value,
                        email: document.getElementById('guest-email').value,
                        phone: document.getElementById('guest-phone').value,
                        expectedValue: parseFloat(document.getElementById('guest-expected-value').value) || 0,
                        paidValue: parseFloat(document.getElementById('guest-paid-value').value) || 0,
                        paymentDate: document.getElementById('guest-payment-date').value,
                        paymentStatus: document.getElementById('guest-payment-status').value,
                        checkedIn: guest?.checkedIn || false,
                        regOrder: guest?.regOrder || state.guests.length + 1
                    };
                    if (isEditing) {
                        const index = state.guests.findIndex(g => g.id === guestId);
                        if (index !== -1) state.guests[index] = guestData;
                    } else {
                        state.guests.push(guestData);
                    }
                    saveState();
                    closeModal('guest-modal');
                    this.renderActivePage();
                };
                openModal('guest-modal');
            },

            openSupplierModal(supplierId = null) {
                const isEditing = supplierId !== null;
                const supplier = isEditing ? state.suppliers.find(s => s.id === supplierId) : null;
                document.getElementById('supplier-modal-title').textContent = isEditing ? 'Editar Fornecedor' : 'Adicionar Fornecedor';
                const form = document.getElementById('supplier-form');
                form.innerHTML = `
                    <div class="form-control">
                        <label for="supplier-name">Nome</label>
                        <input type="text" id="supplier-name" value="${supplier?.name || ''}" required>
                    </div>
                    <div class="form-control">
                        <label for="supplier-service">Serviço</label>
                        <input type="text" id="supplier-service" value="${supplier?.service || ''}">
                    </div>
                    <div class="form-control">
                        <label for="supplier-contact">Contato</label>
                        <input type="text" id="supplier-contact" value="${supplier?.contact || ''}">
                    </div>
                    <div class="form-control">
                        <label for="supplier-cost">Custo (R$)</label>
                        <input type="number" id="supplier-cost" step="0.01" value="${supplier?.cost || 0}">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" onclick="closeModal('supplier-modal')">Cancelar</button>
                        <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                    </div>
                `;
                form.onsubmit = (e) => {
                    e.preventDefault();
                    const supplierData = {
                        id: supplierId || Date.now().toString(),
                        name: document.getElementById('supplier-name').value,
                        service: document.getElementById('supplier-service').value,
                        contact: document.getElementById('supplier-contact').value,
                        cost: parseFloat(document.getElementById('supplier-cost').value) || 0
                    };
                    if (isEditing) {
                        const index = state.suppliers.findIndex(s => s.id === supplierId);
                        if (index !== -1) state.suppliers[index] = supplierData;
                    } else {
                        state.suppliers.push(supplierData);
                    }
                    saveState();
                    closeModal('supplier-modal');
                    this.renderActivePage();
                };
                openModal('supplier-modal');
            },

            deleteItem(id, type) {
                if (type === 'guest') {
                    state.guests = state.guests.filter(g => g.id !== id);
                } else if (type === 'supplier') {
                    state.suppliers = state.suppliers.filter(s => s.id !== id);
                }
                saveState();
                closeModal('delete-modal');
                this.renderActivePage();
            },

            // ===== FUNCIONALIDADES DE QR CODE =====
            generateQRCodeForGuest(guest) {
                const qrContainer = document.getElementById(`qr-${guest.id}`);
                if (!qrContainer) return;
                
                // Limpar container antes de gerar novo QR Code
                qrContainer.innerHTML = '';
                
                // Verificar se a biblioteca QRCode está disponível
                if (typeof QRCode !== 'undefined') {
                    try {
                        // Gerar QR Code com dados do convidado
                        QRCode.toCanvas(qrContainer, JSON.stringify({
                            id: guest.id,
                            name: guest.name,
                            event: state.eventData.name
                        }), {
                            width: 150,
                            height: 150,
                            margin: 1,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            }
                        }, function(error) {
                            if (error) {
                                console.error('Erro ao gerar QR Code:', error);
                                qrContainer.innerHTML = '<p style="color: red; font-size: 12px;">Erro no QR Code</p>';
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        qrContainer.innerHTML = '<p style="color: red; font-size: 12px;">Erro no QR Code</p>';
                    }
                } else {
                    qrContainer.innerHTML = '<p style="color: red; font-size: 12px;">Biblioteca QR Code não carregada</p>';
                }
            },

            startQRScanner() {
                const video = document.getElementById('qr-video');
                const canvas = document.getElementById('qr-canvas');
                const canvasContext = canvas.getContext('2d');
                const resultDiv = document.getElementById('qr-result');
                const startBtn = document.getElementById('start-camera-btn');
                const stopBtn = document.getElementById('stop-camera-btn');
                const placeholder = document.getElementById('qr-scanner-placeholder');

                // Verificar se a biblioteca jsQR está disponível
                if (typeof jsQR === 'undefined') {
                    resultDiv.textContent = 'Erro: Biblioteca de leitura QR não carregada. Verifique sua conexão com a internet.';
                    resultDiv.className = 'qr-result error';
                    resultDiv.style.display = 'block';
                    return;
                }

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        state.qrScannerStream = stream;
                        video.srcObject = stream;
                        video.classList.remove('hidden');
                        canvas.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        startBtn.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        resultDiv.style.display = 'none';

                        video.play();
                        requestAnimationFrame(tick);

                        function tick() {
                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                canvas.height = video.videoHeight;
                                canvas.width = video.videoWidth;
                                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                    inversionAttempts: 'dontInvert',
                                });

                                if (code) {
                                    try {
                                        const guestData = JSON.parse(code.data);
                                        const guest = state.guests.find(g => g.id === guestData.id);
                                        if (guest) {
                                            if (!guest.checkedIn) {
                                                guest.checkedIn = true;
                                                saveState();
                                                app.renderActivePage();
                                                resultDiv.innerHTML = `
                                                    <strong>Check-in realizado com sucesso!</strong><br>
                                                    ${guest.name}<br>
                                                    <span style="font-size: 12px;">${new Date().toLocaleString('pt-BR')}</span>
                                                `;
                                                resultDiv.className = 'qr-result success';
                                            } else {
                                                resultDiv.innerHTML = `
                                                    <strong>Convidado já fez check-in</strong><br>
                                                    ${guest.name}<br>
                                                    <span style="font-size: 12px;">Check-in anterior</span>
                                                `;
                                                resultDiv.className = 'qr-result pending';
                                            }
                                        } else {
                                            resultDiv.innerHTML = '<strong>Convidado não encontrado</strong>';
                                            resultDiv.className = 'qr-result error';
                                        }
                                    } catch (e) {
                                        resultDiv.innerHTML = '<strong>QR Code inválido</strong>';
                                        resultDiv.className = 'qr-result error';
                                    }
                                    resultDiv.style.display = 'block';
                                }
                            }
                            state.qrScannerAnimationId = requestAnimationFrame(tick);
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao acessar câmera:', err);
                        resultDiv.textContent = 'Erro ao acessar a câmera. Verifique as permissões.';
                        resultDiv.className = 'qr-result error';
                        resultDiv.style.display = 'block';
                    });
            },

            stopQRScanner() {
                const video = document.getElementById('qr-video');
                const canvas = document.getElementById('qr-canvas');
                const startBtn = document.getElementById('start-camera-btn');
                const stopBtn = document.getElementById('stop-camera-btn');
                const placeholder = document.getElementById('qr-scanner-placeholder');
                const resultDiv = document.getElementById('qr-result');

                if (state.qrScannerAnimationId) {
                    cancelAnimationFrame(state.qrScannerAnimationId);
                    state.qrScannerAnimationId = null;
                }

                if (state.qrScannerStream) {
                    state.qrScannerStream.getTracks().forEach(track => track.stop());
                    state.qrScannerStream = null;
                }

                video.classList.add('hidden');
                canvas.classList.add('hidden');
                placeholder.classList.remove('hidden');
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                resultDiv.style.display = 'none';
            },

            // ===== RELATÓRIOS E BACKUP =====
            generatePDFReport(type) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPosition = 20;

                // Cabeçalho
                doc.setFontSize(20);
                doc.setTextColor(86, 54, 211);
                doc.text('Eventos Pro - Relatório', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const reportTitle = type === 'balance' ? 'Balanço Geral' : 
                                  type === 'guest-payments' ? 'Pagamentos de Convidados' : 'Despesas do Evento';
                doc.text(reportTitle, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                if (type === 'balance') {
                    const totalIncome = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                    const totalExpenses = calculateTotalCost();
                    const finalBalance = totalIncome - totalExpenses;

                    doc.text(`Total de Receitas: ${formatCurrency(totalIncome)}`, 20, yPosition);
                    yPosition += 10;
                    doc.text(`Total de Despesas: ${formatCurrency(totalExpenses)}`, 20, yPosition);
                    yPosition += 10;
                    doc.text(`Saldo Final: ${formatCurrency(finalBalance)}`, 20, yPosition);
                    yPosition += 20;
                } else if (type === 'guest-payments') {
                    const headers = [['Nome', 'Valor Pago', 'Valor Pendente', 'Status']];
                    const data = state.guests.map(g => [
                        g.name,
                        formatCurrency(g.paidValue || 0),
                        formatCurrency((g.expectedValue || 0) - (g.paidValue || 0)),
                        getPaymentStatusText(g.paymentStatus)
                    ]);
                    doc.autoTable({
                        head: headers,
                        body: data,
                        startY: yPosition,
                        theme: 'grid',
                        headStyles: { fillColor: [86, 54, 211] }
                    });
                } else if (type === 'expenses') {
                    const headers = [['Descrição', 'Valor']];
                    const data = [];
                    Object.entries(state.eventData.costs || {}).forEach(([category, value]) => {
                        if (value > 0) {
                            data.push([getCostCategoryName(category), formatCurrency(value)]);
                        }
                    });
                    state.suppliers.forEach(s => {
                        if (s.cost > 0) {
                            data.push([`${s.name} (${s.service})`, formatCurrency(s.cost)]);
                        }
                    });
                    doc.autoTable({
                        head: headers,
                        body: data,
                        startY: yPosition,
                        theme: 'grid',
                        headStyles: { fillColor: [86, 54, 211] }
                    });
                }

                doc.save(`relatorio-${type}-${new Date().toISOString().slice(0,10)}.pdf`);
            },

            exportData(type = 'all') {
                let dataToExport;
                let filename;

                if (type === 'all') {
                    dataToExport = { eventData: state.eventData, guests: state.guests, suppliers: state.suppliers };
                    filename = `backup-completo-${new Date().toISOString().slice(0,10)}.json`;
                } else if (type === 'guests') {
                    dataToExport = state.guests;
                    filename = `convidados-${new Date().toISOString().slice(0,10)}.json`;
                }

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            // É uma lista de convidados
                            state.guests = [...state.guests, ...importedData];
                        } else if (importedData.eventData || importedData.guests || importedData.suppliers) {
                            // É um backup completo
                            if (importedData.eventData) state.eventData = { ...state.eventData, ...importedData.eventData };
                            if (importedData.guests) state.guests = [...state.guests, ...importedData.guests];
                            if (importedData.suppliers) state.suppliers = [...state.suppliers, ...importedData.suppliers];
                        }
                        saveState();
                        app.renderActivePage();
                        alert('Dados importados com sucesso!');
                    } catch (error) {
                        alert('Erro ao importar dados. Verifique se o arquivo é válido.');
                    }
                };
                reader.readAsText(file);
            },

            clearAllData() {
                if (confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
                    state.eventData = { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
                    state.guests = [];
                    state.suppliers = [];
                    saveState();
                    app.renderActivePage();
                    alert('Todos os dados foram removidos.');
                }
            },

            // ===== INICIALIZAÇÃO =====
            init() {
                initializeData();
                
                // Eventos de Navegação
                selectors.navLinks.addEventListener('click', (e) => {
                    const link = e.target.closest('a[data-page]');
                    if (link) navigateTo(link.dataset.page);
                });

                // Navegação por cards do dashboard
                selectors.dashboardCardsContainer.addEventListener('click', (e) => {
                    const card = e.target.closest('.card[data-page]');
                    if (card) navigateTo(card.dataset.page);
                });

                // Menu Mobile
                selectors.menuToggleBtn.addEventListener('click', () => {
                    selectors.sidebar.classList.toggle('open');
                    selectors.sidebarOverlay.classList.toggle('active');
                });

                selectors.sidebarOverlay.addEventListener('click', () => {
                    selectors.sidebar.classList.remove('open');
                    selectors.sidebarOverlay.classList.remove('active');
                });

                // FAB (Botão de adicionar)
                selectors.fab.addEventListener('click', () => {
                    if (state.activePage === 'guests-page') app.openGuestModal();
                    else if (state.activePage === 'suppliers-page') app.openSupplierModal();
                });

                // Busca de convidados
                document.getElementById('guest-search').addEventListener('input', () => app.renderGuestsPage());

                // Botões de ação
                document.getElementById('edit-event-btn').addEventListener('click', () => app.openEventModal());
                document.getElementById('edit-costs-btn').addEventListener('click', () => app.openCostsModal());
                document.getElementById('start-camera-btn').addEventListener('click', () => app.startQRScanner());
                document.getElementById('stop-camera-btn').addEventListener('click', () => app.stopQRScanner());
                document.getElementById('generate-balance-report-btn').addEventListener('click', () => app.generatePDFReport('balance'));
                document.getElementById('generate-guest-payments-report-btn').addEventListener('click', () => app.generatePDFReport('guest-payments'));
                document.getElementById('generate-expenses-report-btn').addEventListener('click', () => app.generatePDFReport('expenses'));
                document.getElementById('export-data-btn').addEventListener('click', () => app.exportData('all'));
                document.getElementById('export-guests-btn').addEventListener('click', () => app.exportData('guests'));
                document.getElementById('import-data-btn').addEventListener('click', () => {
                    const fileInput = document.getElementById('backup-file');
                    if (fileInput.files.length > 0) {
                        app.importData(fileInput.files[0]);
                    } else {
                        alert('Por favor, selecione um arquivo de backup.');
                    }
                });
                document.getElementById('clear-data-btn').addEventListener('click', () => app.clearAllData());

                // Modal de confirmação de exclusão
                document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal('delete-modal'));

                // Inicialização
                navigateTo(state.activePage);
            }
        };

        // Inicializar a aplicação
        app.init();
    });
    </script>
</body>
</html>
