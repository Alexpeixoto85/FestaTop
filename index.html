<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pro - Sistema de Controle</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>


    <style>
        :root {
            /* Paleta de Cores Refinada */
            --primary-color: #5636D3;
            --primary-light: #8e73ff;
            --secondary-color: #FF872C;
            --success-color: #12A454;
            --danger-color: #E83F5B;
            --pending-color: #4B90F7;
            --background-color: #F7F8FC; /* Cor de fundo mais suave */
            --text-color: #363F5F;
            --text-light-color: #969CB2;
            --card-bg-color: #FFFFFF;
            --border-color: #EAEBF0;
            --border-radius: 12px; /* Bordas mais arredondadas */

            /* Sombras e Efeitos 3D */
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 6px 15px rgba(0, 0, 0, 0.08);
            --shadow-float: 0 10px 25px rgba(0, 0, 0, 0.1);
            
            /* Gradientes Vivos */
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            --gradient-success: linear-gradient(135deg, var(--success-color) 0%, #18d36d 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, #ffab63 100%);
            --gradient-pending: linear-gradient(135deg, var(--pending-color) 0%, #74b0fb 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
        }
        
        /* --- Layout Geral --- */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg-color);
            height: 100vh;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.03); /* Sombra mais sutil */
            border-right: 1px solid var(--border-color);
            position: fixed;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            padding: 2rem 3rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        header h2 {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }
        
        /* --- Sidebar --- */
        .sidebar .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
            padding: 0 2rem;
        }
        
        .sidebar .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .sidebar .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .event-selector-container {
            padding: 0 2rem 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .event-selector-container label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light-color);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .event-selector-container select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            background-color: #f9f9f9;
        }

        .event-selector-container button {
            width: 100%; 
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
        }
        
        .sidebar nav {
            padding: 0 2rem;
        }

        .sidebar nav ul {
            list-style: none;
        }
        
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-light-color);
            font-weight: 500;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sidebar nav li a:hover {
            background-color: #f0edff;
            color: var(--primary-color);
            transform: translateX(5px);
        }

        .sidebar nav li a.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(86, 54, 211, 0.3);
        }
        
        .sidebar nav li a i {
            width: 20px;
            text-align: center;
        }
        
        /* --- Elementos Comuns (Botões 3D e Cards Interativos) --- */
        .card {
            background-color: var(--card-bg-color);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease-in-out;
        }

        .card:hover {
            box-shadow: var(--shadow-float);
            transform: translateY(-5px);
        }
        
        .btn {
            padding: 12px 20px; /* Mais preenchimento */
            border: none;
            border-radius: 8px; /* Mais arredondado */
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600; /* Mais forte */
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn.primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(86, 54, 211, 0.3);
        }
        .btn.primary:hover {
             box-shadow: 0 6px 16px rgba(86, 54, 211, 0.4);
        }
        
        .btn.secondary {
            background-color: #f0f2f5;
            color: var(--text-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn.secondary:hover {
            background-color: #e6e8eb;
        }
        
        .btn.success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 12px rgba(18, 164, 84, 0.3);
        }
        .btn.success:hover {
            box-shadow: 0 6px 16px rgba(18, 164, 84, 0.4);
        }
        
        .btn.danger {
            background: var(--gradient-danger, linear-gradient(135deg, var(--danger-color) 0%, #ff6b8a 100%));
            color: white;
            box-shadow: 0 4px 12px rgba(232, 63, 91, 0.3);
        }
        .btn.danger:hover {
            box-shadow: 0 6px 16px rgba(232, 63, 91, 0.4);
        }
        
        .btn.download {
            background: var(--gradient-pending);
            color: white;
            box-shadow: 0 4px 12px rgba(75, 144, 247, 0.3);
        }
         .btn.download:hover {
            box-shadow: 0 6px 16px rgba(75, 144, 247, 0.4);
        }
        
        .list-item {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
            transform: scale(1.01);
        }
        
        .list-item:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        /* --- Dashboard (Com Gráficos) --- */
        #dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        #dashboard-cards .card {
            border-radius: 22px; 
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }
        
        #dashboard-cards .card:hover {
            transform: scale(1.03) translateY(-5px);
            box-shadow: var(--shadow-float);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--text-light-color);
            font-weight: 500;
        }
        
        .card-header i {
            font-size: 1.8rem;
        }
        
        /* Cores dos ícones dos cards */
        #dashboard-cards .event i { background: -webkit-linear-gradient(135deg, var(--primary-color), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #dashboard-cards .guests i { background: -webkit-linear-gradient(135deg, var(--success-color), #18d36d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #dashboard-cards .suppliers i { background: -webkit-linear-gradient(135deg, var(--secondary-color), #ffab63); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #dashboard-cards .payments i { background: -webkit-linear-gradient(135deg, var(--pending-color), #74b0fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #dashboard-cards .tasks i { background: -webkit-linear-gradient(135deg, #6c757d, #adb5bd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .card p {
            font-size: 2rem;
            font-weight: 600; /* Mais forte */
        }
        
        /* NOVO: Dashboard Charts */
        #dashboard-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }
        .chart-container {
            padding: 1.5rem;
            height: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .chart-container h3 {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        /* --- Página Controle de Entrada (Com QR Scanner) --- */
        .checkin-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }
        /* ... (restante do CSS do checkin-container) ... */
        
        /* NOVO: Estilo do Leitor de QR Code */
        #qr-scanner-container {
            display: none; /* Inicia oculto */
            margin-top: 2rem;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        #qr-scanner-container button {
            margin-top: 1rem;
        }

        /* --- NOVO: Página de Tarefas --- */
        #tasks-page #add-task-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        #tasks-page #add-task-form input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        #tasks-list .list-item {
            cursor: default;
        }
        #tasks-list .list-item:hover {
            transform: none;
            border-color: var(--border-color);
        }
        .task-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-grow: 1;
        }
        .task-content input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .task-content span {
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .task-content span.completed {
            text-decoration: line-through;
            color: var(--text-light-color);
            font-style: italic;
        }
        #tasks-list .delete-btn {
            opacity: 1; /* Sempre visível */
            background: var(--danger-color);
            color: white;
            border-radius: 5px;
            padding: 8px 10px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        #tasks-list .delete-btn:hover {
            box-shadow: 0 2px 8px rgba(232, 63, 91, 0.3);
        }

        /* --- NOVO: Página de Backup (Melhoria Visual) --- */
        #backup-page .card {
            border-left: 5px solid var(--border-color);
        }
        #backup-page .card:nth-of-type(1) { border-left-color: var(--success-color); }
        #backup-page .card:nth-of-type(2) { border-left-color: var(--pending-color); }
        #backup-page .card:nth-of-type(3) { border-left-color: var(--danger-color); }
        
        #backup-page .card h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        #backup-page .card h3 i {
            font-size: 1.6rem; /* Ajustado */
            padding: 10px;
            border-radius: 50%;
            color: #fff;
            width: 44px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        #backup-page .card .icon-success { background-color: var(--success-color); }
        #backup-page .card .icon-pending { background-color: var(--pending-color); }
        #backup-page .card .icon-danger { background-color: var(--danger-color); }


        /* ... (restante do CSS existente: management-page, reports-page, modal, fab, etc.) ... */
        /* (Copiei o CSS restante do seu arquivo original para manter a funcionalidade) */
        
        .transaction-details { display: flex; align-items: center; gap: 1rem; }
        .transaction-status { width: 10px; height: 10px; border-radius: 50%; }
        .transaction-status.paid { background-color: var(--success-color); }
        .transaction-status.pending { background-color: var(--pending-color); }
        .transaction-info span { display: block; }
        .transaction-info .description { font-weight: 500; }
        .transaction-info .details { font-size: 0.8rem; color: var(--text-light-color); }
        .transaction-amount { font-weight: 500; font-size: 1.1rem; }
        .transaction-amount.income { color: var(--success-color); }
        .transaction-amount.expense { color: var(--danger-color); }
        .list-item-actions { display: flex; align-items: center; gap: 1rem; }
        
        .management-page .card { margin-bottom: 2rem; }
        .management-page form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .management-page .form-control { flex-grow: 1; min-width: 200px; }
        .management-page label { font-size: 0.9rem; margin-bottom: 0.25rem; display: block; }
        .management-page input, .management-page select, .management-page textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
        }
        .management-page .list-item i { font-size: 1.2rem; margin-right: 1rem; color: var(--primary-color); }
        .list-item-main { flex-grow: 1; display: flex; align-items: center; }
        
        .checkin-container input {
            font-size: 2rem;
            text-align: center;
            letter-spacing: 0.5em;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .checkin-result { 
            margin-top: 15px; 
            padding: 15px; 
            border-radius: 10px; 
            background-color: #f8f9fa; 
            display: none; 
            text-align: left;
            font-size: 1.1rem;
            box-shadow: var(--shadow-light);
        }
        .checkin-result h4 { margin-bottom: 0.5rem; font-size: 1.3rem;}
        .checkin-result.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .checkin-result.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .checkin-result.pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        #reports-page .filters { background-color: #fff; padding: 1.5rem; margin-bottom: 2rem; border-radius: var(--border-radius); display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        #reports-page .filters .form-control { flex-grow: 1; min-width: 200px; }
        #reports-page .filters label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #reports-page .filters input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .report-card p { font-size: 1.5rem; }
        
        .fab { position: fixed; bottom: 2rem; right: 3rem; width: 60px; height: 60px; background: var(--gradient-primary); color: white; border: none; border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(86, 54, 211, 0.4); cursor: pointer; z-index: 101; transition: all 0.3s ease; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 8px 25px rgba(86, 54, 211, 0.5); }
        .fab:active { transform: scale(1.05) translateY(1px); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 102; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-content h3 { margin-bottom: 1.5rem; }
        .form-control { margin-bottom: 1rem; }
        .form-control label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control input, .form-control select, .form-control textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
        /* Checkbox especial no modal */
        .form-control.form-control-inline { flex-direction: row; display: flex; align-items: center; gap: 10px; }
        .form-control.form-control-inline input[type="checkbox"] { width: auto; }
        .form-control.form-control-inline label { margin-bottom: 0; }
        
        .modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
        .modal-actions .spacer { flex-grow: 1; }
        
        .mobile-header { display: none; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background-color: var(--card-bg-color); box-shadow: var(--shadow-medium); margin-bottom: 1.5rem; }
        .mobile-header #menu-toggle-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .mobile-header h2 { font-size: 1.25rem; margin-bottom: 0; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        
        .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .status.paid { background-color: #d4edda; color: #155724; }
        .status.pending { background-color: #fff3cd; color: #856404; }
        .status.partial { background-color: #cce7ff; color: #004085; }
        .checkin-status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .checkin-status.checked { background-color: #d4edda; color: #155724; }
        .checkin-status.not-checked { background-color: #f8d7da; color: #721c24; }
        /* NOVO: Status de check-in parcial */
        .checkin-status.partial { background-color: #cce7ff; color: #004085; }
        
        /* Responsividade */
        @media (max-width: 992px) {
             #dashboard-charts {
                grid-template-columns: 1fr;
                height: auto;
            }
            .chart-container {
                height: 350px; /* Mantém a altura no mobile */
            }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 0; }
            .page-content { padding: 0 1.5rem 1.5rem 1.5rem; }
            header { display: none; }
            .mobile-header { display: flex; }
            .form-grid { grid-template-columns: 1fr; }
            .fab { right: 1.5rem; bottom: 1.5rem; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .list-item-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fa-solid fa-calendar-alt"></i>
            <h1>Eventos Pro</h1>
        </div>

        <div class="event-selector-container">
            <label for="event-selector">Evento Ativo:</label>
            <select id="event-selector"></select>
            <button id="new-event-btn" class="btn primary">
                <i class="fa-solid fa-plus"></i> Novo Evento
            </button>
        </div>
        
        <nav>
            <ul id="nav-links">
                <li><a data-page="dashboard-page" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                <li><a data-page="event-page"><i class="fa-solid fa-calendar-check"></i> Evento</a></li>
                <li><a data-page="tasks-page"><i class="fa-solid fa-check-square"></i> Tarefas</a></li> <li><a data-page="guests-page"><i class="fa-solid fa-users"></i> Convidados</a></li>
                <li><a data-page="suppliers-page"><i class="fa-solid fa-truck"></i> Fornecedores</a></li>
                <li><a data-page="payments-page"><i class="fa-solid fa-money-bill-wave"></i> Pagamentos</a></li>
                <li><a data-page="checkin-page"><i class="fa-solid fa-id-card"></i> Controle de Entrada</a></li>
                <li><a data-page="reports-page"><i class="fa-solid fa-chart-line"></i> Relatórios</a></li>
                <li><a data-page="backup-page"><i class="fa-solid fa-database"></i> Backup</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="mobile-header">
            <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h2 id="mobile-page-title">Dashboard</h2>
        </header>

        <section id="dashboard-page" class="page-content active">
            <header><h2>Dashboard</h2></header>

            <div id="no-event-message" class="card" style="display: none; text-align: center;">
                <h3>Bem-vindo ao Eventos Pro!</h3>
                <p style="margin: 1rem 0;">Selecione um evento na barra lateral ou crie um novo para começar.</p>
                <button id="create-event-dashboard-btn" class="btn primary">Criar Novo Evento</button>
            </div>

            <div id="event-content-container">
                <div id="dashboard-cards">
                    <div class="card event" data-page="event-page">
                        <div class="card-header"><span>Evento</span><i class="fa-solid fa-calendar-alt"></i></div>
                        <p id="dashboard-event-name">Configurar</p>
                    </div>
                    <div class="card guests" data-page="guests-page">
                        <div class="card-header"><span id="dashboard-guest-title">Convidados</span><i class="fa-solid fa-users"></i></div>
                        <p id="dashboard-guest-count">0</p>
                    </div>
                    <div class="card suppliers" data-page="suppliers-page">
                        <div class="card-header"><span>Fornecedores</span><i class="fa-solid fa-truck"></i></div>
                        <p id="dashboard-supplier-count">0</p>
                    </div>
                    <div class="card tasks" data-page="tasks-page"> <div class="card-header"><span>Tarefas Pendentes</span><i class="fa-solid fa-check-square"></i></div>
                        <p id="dashboard-tasks-count">0</p>
                    </div>
                    <div class="card payments" data-page="payments-page">
                        <div class="card-header"><span>Total Recebido</span><i class="fa-solid fa-arrow-up"></i></div>
                        <p id="dashboard-payment-total">R$ 0,00</p>
                    </div>
                </div>

                <div id="dashboard-charts">
                    <div class="card chart-container">
                        <h3>Status dos Pagamentos</h3>
                        <canvas id="payment-status-chart"></canvas>
                    </div>
                    <div class="card chart-container">
                        <h3>Status de Check-in (Grupos)</h3>
                        <canvas id="checkin-status-chart"></canvas>
                    </div>
                </div>
                
                <div class="card" id="financial-summary-card">
                    <h3>Resumo Financeiro</h3>
                    <div class="form-grid">
                        <div><strong>Custo Total do Evento:</strong> <span id="total-cost">R$ 0,00</span></div>
                        <div><strong>Custo por Convidado:</strong> <span id="cost-per-guest">R$ 0,00</span></div>
                        <div><strong>Total Recebido:</strong> <span id="total-received" style="color: var(--success-color);">R$ 0,00</span></div>
                        <div><strong>Total a Receber:</strong> <span id="total-pending" style="color: var(--danger-color);">R$ 0,00</span></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Últimos Pagamentos Recebidos</h3>
                    <ul id="recent-payments-list"></ul>
                </div>
            </div>
        </section>

        <section id="event-page" class="page-content management-page">
            <header><h2>Configuração do Evento</h2></header>
            <div class="card">
                <div class="card-header"><h3>Informações do Evento</h3><button class="btn primary" id="edit-event-btn"><i class="fa-solid fa-edit"></i> Editar Evento</button></div>
                <div id="event-info"></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Custos do Evento</h3><button class="btn primary" id="edit-costs-btn"><i class="fa-solid fa-edit"></i> Editar Custos</button></div>
                <div id="costs-info"></div>
            </div>
        </section>

        <section id="tasks-page" class="page-content management-page">
            <header><h2>Lista de Tarefas</h2></header>
            <div class="card">
                <form id="add-task-form">
                    <input type="text" id="new-task-input" placeholder="Adicionar nova tarefa..." required>
                    <button type="submit" class="btn primary"><i class="fa-solid fa-plus"></i> Adicionar</button>
                </form>
            </div>
            <ul id="tasks-list"></ul>
        </section>

        <section id="guests-page" class="page-content management-page">
            <header><h2>Lista de Convidados</h2></header>
            <div class="card">
                <div class="form-control"><input type="text" id="guest-search" placeholder="Buscar convidado..."></div>
            </div>
            <ul id="guests-list"></ul>
        </section>

        <section id="suppliers-page" class="page-content management-page">
            <header><h2>Fornecedores</h2></header>
            <ul id="suppliers-list"></ul>
        </section>

        <section id="payments-page" class="page-content">
            <header><h2>Controle de Pagamentos</h2></header>
            <div class="card">
                <div class="form-grid">
                    <div><h3>Total Recebido: <span id="payments-total-received" style="color: var(--success-color);">R$ 0,00</span></h3></div>
                    <div><h3>Total a Receber: <span id="payments-total-pending" style="color: var(--danger-color);">R$ 0,00</span></h3></div>
                </div>
            </div>
            <div class="card"><h3>Pagamentos Recebidos de Convidados</h3><ul id="guest-payments-list"></ul></div>
            <div class="card"><h3>Pagamentos Efetuados a Fornecedores</h3><ul id="supplier-payments-list"></ul></div>
        </section>

        <section id="checkin-page" class="page-content">
            <header><h2>Controle de Entrada</h2></header>
            
            <div class="card">
                <h3>Verificação por QR Code</h3>
                <p>Aponte a câmera para o QR Code do convite/recibo do convidado.</p>
                <div class="modal-actions" style="justify-content: center; margin-top: 1rem;">
                    <button id="start-qr-scanner-btn" class="btn success"><i class="fa-solid fa-qrcode"></i> Iniciar Leitor QR</button>
                </div>
                
                <div id="qr-scanner-container">
                    <div id="qr-reader"></div>
                    <button id="stop-qr-scanner-btn" class="btn danger" style="margin-top: 1rem;">Parar Leitor</button>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <a href="#" id="toggle-manual-checkin" style="color: var(--primary-color); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fa-solid fa-keyboard"></i> Não conseguiu ler? Digite o código manual.
                    </a>
                </div>

                <div id="manual-checkin-container" style="display: none; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
                    <h3>Verificação por Código Manual</h3>
                    <p>Digite o código de 4 dígitos do convidado para validar a entrada.</p>
                    <div class="checkin-container">
                        <form id="checkin-form">
                            <div class="form-control">
                                <label for="checkin-code">Código de Acesso (4 dígitos)</label>
                                <input type="tel" id="checkin-code" maxlength="4" pattern="\d{4}" inputmode="numeric" required>
                            </div>
                            <div class="modal-actions" style="justify-content: center;">
                                <button type="submit" class="btn primary">Verificar Entrada</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="checkin-result" class="checkin-result" style="margin-top: 2rem;"></div>
            </div>
        </section>
        <section id="reports-page" class="page-content">
            <header><h2>Relatórios Financeiros</h2></header>
             <div id="report-summary">
                <div class="card"><div class="card-header"><span>Total de Receitas</span></div><p id="total-income">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Total de Despesas</span></div><p id="total-expenses">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Saldo Final</span></div><p id="final-balance">R$ 0,00</p></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Balanço Geral</h3><button class="btn download" id="generate-balance-report-btn"><i class="fa-solid fa-file-pdf"></i> Gerar PDF</button></div>
                </div>
            <div class="card">
                <div class="card-header"><h3>Pagamentos de Convidados</h3><button class="btn download" id="generate-guest-payments-report-btn"><i class="fa-solid fa-file-pdf"></i> Gerar PDF</button></div>
                 </div>
            <div class="card">
                <div class="card-header"><h3>Despesas do Evento</h3><button class="btn download" id="generate-expenses-report-btn"><i class="fa-solid fa-file-pdf"></i> Gerar PDF</button></div>
                 </div>
        </section>

        <section id="backup-page" class="page-content">
            <header><h2>Backup e Restauração</h2></header>
            <div class="card">
                <h3><i class="fa-solid fa-download icon-success"></i> Exportar Dados</h3>
                <p>Faça backup de todos os dados do sistema para um arquivo JSON.</p>
                <div class="modal-actions">
                    <button class="btn success" id="export-data-btn"><i class="fa-solid fa-download"></i> Exportar Tudo (v3)</button>
                    <button class="btn success" id="export-guests-btn"><i class="fa-solid fa-users"></i> Exportar Convidados (Evento Ativo)</button>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-upload icon-pending"></i> Importar Dados</h3>
                <p>Restaurar dados de um backup v3. A importação adicionará novos eventos e atualizará eventos existentes com o mesmo ID.</p>
                <div class="form-control"><label for="backup-file">Selecionar arquivo de backup (.json)</label><input type="file" id="backup-file" accept=".json"></div>
                <div class="modal-actions">
                    <button class="btn download" id="import-data-btn"><i class="fa-solid fa-upload"></i> Importar Dados</button>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-trash-alt icon-danger"></i> Limpar Dados</h3>
                <p>Remover todos os dados do sistema (v3). Esta ação não pode ser desfeita.</p>
                <div class="modal-actions"><button class="btn danger" id="clear-data-btn"><i class="fa-solid fa-trash-alt"></i> Limpar Todos os Dados</button></div>
            </div>
        </section>
        </main>

    <button class="fab" id="fab-add-btn" style="display: none;"><i class="fa-solid fa-plus"></i></button>

    <div class="modal-overlay" id="event-modal"><div class="modal-content"><h3 id="event-modal-title"></h3><form id="event-form"></form></div></div>
    <div class="modal-overlay" id="costs-modal"><div class="modal-content"><h3 id="costs-modal-title"></h3><form id="costs-form"></form></div></div>
    <div class="modal-overlay" id="guest-modal"><div class="modal-content"><h3 id="guest-modal-title"></h3><form id="guest-form"></form></div></div>
    <div class="modal-overlay" id="supplier-modal"><div class="modal-content"><h3 id="supplier-modal-title"></h3><form id="supplier-form"></form></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-content"><h3 id="delete-modal-title"></h3><p id="delete-message"></p><div class="modal-actions"><button type="button" class="btn secondary" id="cancel-delete-btn">Cancelar</button><button type="button" class="btn danger" id="confirm-delete-btn">Excluir</button></div></div></div>

    <div class="modal-overlay" id="new-event-modal">
        <div class="modal-content">
            <h3>Criar Novo Evento</h3>
            <form id="new-event-form">
                <div class="form-control">
                    <label for="new-event-name">Nome do Evento</label>
                    <input type="text" id="new-event-name" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn secondary" onclick="closeAllModals()">Cancelar</button>
                    <button type="submit" class="btn primary">Criar e Selecionar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===== ESTADO CENTRAL DA APLICAÇÃO =====
        const state = {
            events: [], 
            activeEventId: null,
            activePage: 'dashboard-page',
            currentEditingId: null,
            currentEditingType: null,
            charts: {}, // Armazenar instâncias dos gráficos
            qrScanner: null // Armazenar instância do leitor de QR
        };

        // ===== SELETORES DE ELEMENTOS COMUNS =====
        const selectors = {
            navLinks: document.getElementById('nav-links'),
            pages: document.querySelectorAll('.page-content'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            mobilePageTitle: document.getElementById('mobile-page-title'),
            fab: document.getElementById('fab-add-btn'),
            dashboardCardsContainer: document.getElementById('dashboard-cards'),
            eventSelector: document.getElementById('event-selector'),
            newEventBtn: document.getElementById('new-event-btn'),
            createEventDashboardBtn: document.getElementById('create-event-dashboard-btn'),
            noEventMessage: document.getElementById('no-event-message'),
            eventContentContainer: document.getElementById('event-content-container')
        };
        
        // ===== FUNÇÕES AUXILIARES =====
        
        const getActiveEvent = () => {
            if (!state.activeEventId) return null;
            return state.events.find(e => e.id === state.activeEventId);
        };

        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getPaymentStatusText = (status) => ({ paid: 'Pago', partial: 'Parcial', pending: 'Pendente' }[status] || 'Pendente');
        const getCostCategoryName = (category) => ({ food: 'Alimentação', music: 'Música', venue: 'Aluguel do Espaço', drinks: 'Bebidas', other: 'Outros Custos' }[category] || category);
        
        const calculateTotalCost = () => {
            const event = getActiveEvent();
            if (!event) return 0;
            const costs = event.eventData.costs || {};
            const suppliersCost = event.suppliers.reduce((s, sup) => s + (sup.cost || 0), 0);
            const fixedCosts = Object.values(costs).reduce((s, c) => s + c, 0);
            return fixedCosts + suppliersCost;
        };

        // ===== PERSISTÊNCIA DE DADOS (LocalStorage) (Refatorado para v3) =====
        
        /**
         * NOVO: Migra dados de convidados para incluir familyCount e checkedInCount
         */
        const migrateGuestData = (event) => {
            let needsSave = false;
            const existingCodes = new Set(event.guests.map(g => g.accessCode).filter(Boolean));
            
            event.guests.forEach((guest, index) => {
                if (!guest.regOrder) {
                    guest.regOrder = index + 1;
                    needsSave = true;
                }
                if (!guest.accessCode) {
                    let newCode;
                    do {
                        newCode = Math.floor(1000 + Math.random() * 9000);
                    } while (existingCodes.has(newCode));
                    guest.accessCode = newCode;
                    existingCodes.add(newCode);
                    needsSave = true;
                }
                if (guest.qrCode) {
                    delete guest.qrCode;
                    needsSave = true;
                }
                
                // --- NOVAS MIGRAÇÕES (familyCount, checkedInCount) ---
                if (guest.familyCount === undefined) {
                    guest.familyCount = 1; // Padrão é 1
                    needsSave = true;
                }
                if (guest.checkedInCount === undefined) {
                    // Se o convidado estava marcado como checkedIn, assume 1 e familyCount 1
                    if (guest.checkedIn === true) {
                        guest.checkedInCount = 1;
                        guest.familyCount = 1; // Força contagem 1 para dados antigos
                    } else {
                        guest.checkedInCount = 0;
                    }
                    needsSave = true;
                }
                
                // Garante que o booleano 'checkedIn' reflete o estado da contagem
                guest.checkedIn = (guest.checkedInCount >= guest.familyCount);
                // --- FIM DAS NOVAS MIGRAÇÕES ---
            });
            return needsSave;
        };

        const initializeData = () => {
            const savedData_v3 = JSON.parse(localStorage.getItem('eventManagementData_v3'));
            const savedData_v2 = JSON.parse(localStorage.getItem('eventManagementData_v2'));

            if (savedData_v3) {
                state.events = savedData_v3.events || [];
                state.activeEventId = savedData_v3.activeEventId || null;
                
                if (state.activeEventId && !state.events.find(e => e.id === state.activeEventId)) {
                    state.activeEventId = state.events.length > 0 ? state.events[0].id : null;
                }
                
            } else if (savedData_v2) {
                console.log("Migrando dados v2 para v3...");
                const newEventId = Date.now();
                const migratedEvent = {
                    id: newEventId,
                    eventData: savedData_v2.eventData || { name: 'Evento Migrado', date: '', location: '', description: '', isFree: false, costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } },
                    guests: savedData_v2.guests || [],
                    suppliers: savedData_v2.suppliers || [],
                    tasks: [] 
                };
                
                migrateGuestData(migratedEvent);
                
                state.events = [migratedEvent];
                state.activeEventId = newEventId;
                
                saveData();
                localStorage.removeItem('eventManagementData_v2');
                
            } else {
                state.events = [];
                state.activeEventId = null;
            }

            // Garantir que eventos existentes tenham campos novos (tasks, isFree, e migração de convidados)
            let anyMigration = false;
            state.events.forEach(event => {
                if (!event.tasks) {
                    event.tasks = [];
                    anyMigration = true;
                }
                if (event.eventData.isFree === undefined) {
                    event.eventData.isFree = false; // Padrão para eventos antigos
                    anyMigration = true;
                }
                if (migrateGuestData(event)) { // Roda a migração de convidados
                    anyMigration = true;
                }
            });
            
            if (anyMigration) {
                console.log("Dados migrados para o formato mais recente.");
                saveData();
            }
            
            populateEventSelector();
        };

        const saveData = () => {
            localStorage.setItem('eventManagementData_v3', JSON.stringify({
                activeEventId: state.activeEventId,
                events: state.events
            }));
        };

        // ===== NAVEGAÇÃO E INTERFACE =====
        const setupNavigation = () => {
            selectors.navLinks.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' || e.target.parentElement.tagName === 'A') {
                    e.preventDefault();
                    const link = e.target.tagName === 'A' ? e.target : e.target.parentElement;
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        navigateToPage(pageId);
                        if (window.innerWidth <= 768) {
                            selectors.sidebar.classList.remove('open');
                            selectors.sidebarOverlay.classList.remove('active');
                        }
                    }
                }
            });

            selectors.dashboardCardsContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                if (card && card.dataset.page) {
                    navigateToPage(card.dataset.page);
                }
            });

            selectors.menuToggleBtn.addEventListener('click', () => {
                selectors.sidebar.classList.toggle('open');
                selectors.sidebarOverlay.classList.toggle('active');
            });

            selectors.sidebarOverlay.addEventListener('click', () => {
                selectors.sidebar.classList.remove('open');
                selectors.sidebarOverlay.classList.remove('active');
            });
        };

        const navigateToPage = (pageId) => {
            // Parar o leitor de QR se sair da página de check-in
            if (state.activePage === 'checkin-page' && pageId !== 'checkin-page') {
                stopQrScanner();
            }

            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar nav a[data-page="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                const pageTitle = activeLink.textContent.trim();
                selectors.mobilePageTitle.textContent = pageTitle;
            }
            
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            state.activePage = pageId;
            renderPageContent(pageId); // Movido para depois de definir a página ativa
        };

        const updateFAB = (pageId) => {
            const fab = selectors.fab;
            const showFab = ['guests-page', 'suppliers-page'].includes(pageId) && getActiveEvent();
            fab.style.display = showFab ? 'flex' : 'none';
            
            if (showFab) {
                fab.onclick = () => {
                    if (pageId === 'guests-page') showGuestModal();
                    if (pageId === 'suppliers-page') showSupplierModal();
                };
            }
        };

        const renderPageContent = (pageId) => {
            const activeEvent = getActiveEvent();

            // --- NOVO: Lógica para Evento Gratuito ---
            const paymentsNavLink = document.querySelector('a[data-page="payments-page"]').parentElement;
            const reportsNavLink = document.querySelector('a[data-page="reports-page"]').parentElement;
            
            if (activeEvent && activeEvent.eventData.isFree) {
                // Esconde links de navegação
                paymentsNavLink.style.display = 'none';
                reportsNavLink.style.display = 'none';

                // Se o usuário tentar acessar a página de pagamentos ou relatórios, redireciona
                if (pageId === 'payments-page' || pageId === 'reports-page') {
                    navigateToPage('dashboard-page');
                    return; // Para a execução para evitar renderizar a página errada
                }
            } else if (activeEvent) {
                // Garante que eles estão visíveis se o evento não for gratuito
                paymentsNavLink.style.display = 'list-item';
                reportsNavLink.style.display = 'list-item';
            }
            // --- FIM DA LÓGICA DE EVENTO GRATUITO ---

            if (!activeEvent && pageId !== 'backup-page') { 
                navigateToPage('dashboard-page');
                return;
            }

            updateFAB(pageId);

            switch(pageId) {
                case 'dashboard-page':
                    renderDashboard();
                    break;
                case 'event-page':
                    renderEventPage();
                    break;
                case 'tasks-page': 
                    renderTasksPage();
                    break;
                case 'guests-page':
                    renderGuestsPage();
                    break;
                case 'suppliers-page':
                    renderSuppliersPage();
                    break;
                case 'payments-page':
                    renderPaymentsPage();
                    break;
                case 'checkin-page':
                    renderCheckinPage();
                    break;
                case 'reports-page':
                    renderReportsPage();
                    break;
                case 'backup-page':
                    renderBackupPage();
                    break;
            }
        };

        // ===== GERENCIAMENTO DE EVENTOS (Dropdown e Modal) =====
        const populateEventSelector = () => {
            const selector = selectors.eventSelector;
            selector.innerHTML = '';
            
            if (state.events.length === 0) {
                selector.innerHTML = '<option value="">Crie um evento</option>';
                selector.disabled = true;
            } else {
                selector.disabled = false;
                state.events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = event.eventData.name || 'Evento Sem Nome';
                    if (event.id === state.activeEventId) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }
        };

        const setupEventSelector = () => {
            selectors.newEventBtn.onclick = showNewEventModal;
            selectors.createEventDashboardBtn.onclick = showNewEventModal;
            
            selectors.eventSelector.onchange = (e) => {
                const newEventId = parseInt(e.target.value);
                if (newEventId) {
                    setActiveEvent(newEventId);
                }
            };
        };

        const setActiveEvent = (eventId) => {
            state.activeEventId = eventId;
            saveData();
            populateEventSelector(); 
            // Renderiza a página atual com o contexto do novo evento
            renderPageContent(state.activePage); 
        };

        const showNewEventModal = () => {
            const modal = document.getElementById('new-event-modal');
            const form = document.getElementById('new-event-form');
            form.reset();
            
            form.onsubmit = (e) => {
                e.preventDefault();
                const eventName = document.getElementById('new-event-name').value;
                if (eventName) {
                    createNewEvent(eventName);
                }
            };
            modal.classList.add('active');
        };

        const createNewEvent = (name) => {
            const newEventId = Date.now();
            const newEvent = {
                id: newEventId,
                eventData: { 
                    name: name, 
                    date: '', 
                    location: '', 
                    description: '', 
                    isFree: false, // NOVO: Padrão é falso
                    costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } 
                },
                guests: [],
                suppliers: [],
                tasks: []
            };
            
            state.events.push(newEvent);
            state.activeEventId = newEventId;
            
            saveData();
            populateEventSelector();
            closeAllModals();
            
            // Sempre navega para o dashboard após criar um novo evento
            navigateToPage('dashboard-page');
        };

        // ===== GERENCIAMENTO DE MODAIS =====
        const setupModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeAllModals();
                    }
                });
            });

            document.querySelectorAll('.modal-actions .btn.secondary').forEach(btn => {
                if (btn.id !== 'cancel-delete-btn') {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        closeAllModals();
                    });
                }
            });
            document.getElementById('cancel-delete-btn').onclick = closeAllModals;
        };

        const closeAllModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            state.currentEditingId = null;
            state.currentEditingType = null;
        };

        // ===== DASHBOARD (Refatorado com Gráficos) =====
        const renderDashboard = () => {
            const event = getActiveEvent();

            if (!event) {
                selectors.noEventMessage.style.display = 'block';
                selectors.eventContentContainer.style.display = 'none';
                return;
            }
            
            selectors.noEventMessage.style.display = 'none';
            selectors.eventContentContainer.style.display = 'block';
            
            const isFree = event.eventData.isFree;

            document.getElementById('dashboard-event-name').textContent = event.eventData.name || 'Configurar';
            
            // NOVO: Conta o total de pessoas (familiares)
            const totalPeople = event.guests.reduce((sum, guest) => sum + (guest.familyCount || 1), 0);
            document.getElementById('dashboard-guest-title').textContent = 'Total de Pessoas';
            document.getElementById('dashboard-guest-count').textContent = totalPeople;
            
            document.getElementById('dashboard-supplier-count').textContent = event.suppliers.length;
            
            const pendingTasks = event.tasks.filter(task => !task.completed).length;
            document.getElementById('dashboard-tasks-count').textContent = pendingTasks;
            
            // Lógica de Pagamentos (apenas se não for gratuito)
            const paymentsCard = document.querySelector('#dashboard-cards .payments');
            const financialSummaryCard = document.getElementById('financial-summary-card');
            
            if (isFree) {
                paymentsCard.style.display = 'none';
                financialSummaryCard.style.display = 'none';
            } else {
                paymentsCard.style.display = 'block';
                financialSummaryCard.style.display = 'block';

                const totalReceived = event.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
                const totalPending = event.guests.reduce((sum, guest) => {
                    const total = guest.totalAmount || 0;
                    const paid = guest.paidAmount || 0;
                    return sum + (total - paid);
                }, 0);
                
                document.getElementById('dashboard-payment-total').textContent = formatCurrency(totalReceived);
                
                const totalCost = calculateTotalCost();
                // NOVO: Custo por pessoa (total de pessoas) em vez de por convite
                const costPerGuest = totalPeople > 0 ? totalCost / totalPeople : 0;
                
                document.getElementById('total-cost').textContent = formatCurrency(totalCost);
                document.getElementById('cost-per-guest').textContent = formatCurrency(costPerGuest);
                document.getElementById('total-received').textContent = formatCurrency(totalReceived);
                document.getElementById('total-pending').textContent = formatCurrency(totalPending);
            }
            
            renderRecentPayments();
            renderDashboardCharts(); // Renderiza os gráficos
        };

        /**
         * Renderiza os gráficos do dashboard
         */
        const renderDashboardCharts = () => {
            const event = getActiveEvent();
            if (!event) return;
            
            const isFree = event.eventData.isFree;
            const chartsContainer = document.getElementById('dashboard-charts');
            const paymentChartContainer = document.getElementById('payment-status-chart').closest('.chart-container');

            // --- 1. Gráfico de Pagamentos ---
            if (isFree) {
                paymentChartContainer.style.display = 'none';
                // Ajusta o grid para o gráfico restante ocupar o espaço
                chartsContainer.style.gridTemplateColumns = '1fr';
            } else {
                paymentChartContainer.style.display = 'flex';
                chartsContainer.style.gridTemplateColumns = '1fr 1fr';
                
                const guestStats = { paid: 0, partial: 0, pending: 0, total: event.guests.length };
                event.guests.forEach(guest => {
                    guestStats[guest.paymentStatus || 'pending']++;
                });

                const paymentCtx = document.getElementById('payment-status-chart').getContext('2d');
                
                if (state.charts.paymentChart) {
                    state.charts.paymentChart.destroy();
                }

                state.charts.paymentChart = new Chart(paymentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pago', 'Parcial', 'Pendente'],
                        datasets: [{
                            label: 'Status de Pagamento',
                            data: [guestStats.paid, guestStats.partial, guestStats.pending],
                            backgroundColor: [
                                'rgba(18, 164, 84, 0.8)', // Success
                                'rgba(75, 144, 247, 0.8)', // Pending
                                'rgba(232, 63, 91, 0.8)'  // Danger
                            ],
                            borderColor: ['#FFFFFF', '#FFFFFF', '#FFFFFF'],
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            // --- 2. Gráfico de Check-in ---
            // A lógica aqui (guest.checkedIn) está correta, pois atualizamos
            // o 'checkedIn' para true apenas quando o check-in do GRUPO está completo.
            const checkinStats = { checked: 0, notChecked: 0 };
            event.guests.forEach(guest => {
                if (guest.checkedIn) { // guest.checkedIn (booleano) significa check-in completo do grupo
                    checkinStats.checked++;
                } else {
                    checkinStats.notChecked++;
                }
            });

            const checkinCtx = document.getElementById('checkin-status-chart').getContext('2d');
            
            if (state.charts.checkinChart) {
                state.charts.checkinChart.destroy();
            }

            state.charts.checkinChart = new Chart(checkinCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Check-in Completo', 'Aguardando'],
                    datasets: [{
                        label: 'Status de Check-in (Grupos)',
                        data: [checkinStats.checked, checkinStats.notChecked],
                        backgroundColor: [
                            'rgba(86, 54, 211, 0.8)', // Primary
                            'rgba(234, 235, 240, 0.8)' // Border
                        ],
                        borderColor: ['#FFFFFF', '#FFFFFF'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            
            // Em telas menores, força uma coluna se ambos os gráficos estiverem visíveis
             if (window.innerWidth <= 992 && !isFree) {
                 chartsContainer.style.gridTemplateColumns = '1fr';
             }
        };


        const renderRecentPayments = () => {
            const event = getActiveEvent();
            const container = document.getElementById('recent-payments-list');
            container.innerHTML = '';
            
            // NOVO: Oculta se o evento for gratuito
            if (!event || event.eventData.isFree) {
                container.parentElement.style.display = 'none';
                return;
            }
            container.parentElement.style.display = 'block';
            
            if (event.guests.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum pagamento recebido ainda</li>';
                return;
            }
            
            const recentPayments = event.guests
                .filter(guest => guest.paidAmount > 0)
                .sort((a, b) => new Date(b.lastPaymentDate || 0) - new Date(a.lastPaymentDate || 0))
                .slice(0, 5);
            
            if (recentPayments.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum pagamento recebido ainda</li>';
                return;
            }
            
            recentPayments.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-status ${guest.paymentStatus === 'paid' ? 'paid' : 'pending'}"></div>
                        <div class="transaction-info">
                            <span class="description">${guest.name}</span>
                            <span class="details">${guest.lastPaymentDate ? new Date(guest.lastPaymentDate).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="transaction-amount income">${formatCurrency(guest.paidAmount || 0)}</div>
                `;
                container.appendChild(li);
            });
        };

        // ===== PÁGINA DO EVENTO =====
        const renderEventPage = () => {
            const event = getActiveEvent();
            if (!event) {
                document.getElementById('event-info').innerHTML = '<p>Nenhum evento selecionado.</p>';
                document.getElementById('costs-info').innerHTML = '';
                return;
            }

            document.getElementById('edit-event-btn').onclick = () => showEventModal();
            document.getElementById('edit-costs-btn').onclick = () => showCostsModal();
            
            renderEventInfo();
            renderCostsInfo();
        };

        const renderEventInfo = () => {
            const event = getActiveEvent();
            if (!event) return;
            const container = document.getElementById('event-info');
            const eventData = event.eventData;
            
            container.innerHTML = `
                <div class="form-grid">
                    <div><strong>Nome do Evento:</strong> ${eventData.name || 'Não definido'}</div>
                    <div><strong>Data:</strong> ${eventData.date ? new Date(eventData.date).toLocaleDateString('pt-BR') : 'Não definida'}</div>
                    <div><strong>Local:</strong> ${eventData.location || 'Não definido'}</div>
                    <div><strong>Tipo:</strong> ${eventData.isFree ? 'Gratuito (Controle de Acesso)' : 'Pago'}</div>
                    <div style="grid-column: span 2;"><strong>Descrição:</strong> ${eventData.description || 'Não definida'}</div>
                </div>
            `;
        };

        const renderCostsInfo = () => {
            const event = getActiveEvent();
            if (!event) return;
            const container = document.getElementById('costs-info');
            const costs = event.eventData.costs || {};
            const suppliersTotal = event.suppliers.reduce((sum, supplier) => sum + (supplier.cost || 0), 0);
            const totalCost = calculateTotalCost();
            
            let html = `
                <div class="form-grid">
                    <div><strong>Alimentação:</strong> ${formatCurrency(costs.food || 0)}</div>
                    <div><strong>Música:</strong> ${formatCurrency(costs.music || 0)}</div>
                    <div><strong>Aluguel do Espaço:</strong> ${formatCurrency(costs.venue || 0)}</div>
                    <div><strong>Bebidas:</strong> ${formatCurrency(costs.drinks || 0)}</div>
                    <div><strong>Outros Custos:</strong> ${formatCurrency(costs.other || 0)}</div>
                    <div><strong>Custos com Fornecedores:</strong> ${formatCurrency(suppliersTotal)}</div>
                    <div style="grid-column: span 2; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; font-size: 1.2rem;">
                        <strong>Custo Total do Evento:</strong> ${formatCurrency(totalCost)}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        };

        const showEventModal = () => {
            const event = getActiveEvent();
            if (!event) return;
            const modal = document.getElementById('event-modal');
            const title = document.getElementById('event-modal-title');
            const form = document.getElementById('event-form');
            title.textContent = event.eventData.name ? 'Editar Evento' : 'Criar Evento';
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="event-name">Nome do Evento</label>
                    <input type="text" id="event-name" value="${event.eventData.name || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-date">Data do Evento</label>
                    <input type="date" id="event-date" value="${event.eventData.date || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-location">Local</label>
                    <input type="text" id="event-location" value="${event.eventData.location || ''}" required>
                </div>
                <div class="form-control">
                    <label for="event-description">Descrição</label>
                    <textarea id="event-description" rows="3">${event.eventData.description || ''}</textarea>
                </div>
                <div class="form-control form-control-inline">
                    <input type="checkbox" id="event-is-free" ${event.eventData.isFree ? 'checked' : ''}>
                    <label for="event-is-free">Evento Gratuito (Apenas controle de acesso)</label>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary">Cancelar</button>
                    <button type="submit" class="btn primary">Salvar</button>
                </div>
            `;
            form.onsubmit = (e) => { e.preventDefault(); saveEventData(); };
            modal.classList.add('active');
        };

        const showCostsModal = () => {
            const event = getActiveEvent();
            if (!event) return;
            const modal = document.getElementById('costs-modal');
            const title = document.getElementById('costs-modal-title');
            const form = document.getElementById('costs-form');
            title.textContent = 'Editar Custos do Evento';
            const costs = event.eventData.costs || { food: 0, music: 0, venue: 0, drinks: 0, other: 0 };
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="cost-food">Alimentação</label>
                    <input type="number" id="cost-food" step="0.01" value="${costs.food || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-music">Música</label>
                    <input type="number" id="cost-music" step="0.01" value="${costs.music || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-venue">Aluguel do Espaço</label>
                    <input type="number" id="cost-venue" step="0.01" value="${costs.venue || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-drinks">Bebidas</label>
                    <input type="number" id="cost-drinks" step="0.01" value="${costs.drinks || 0}" required>
                </div>
                <div class="form-control">
                    <label for="cost-other">Outros Custos</label>
                    <input type="number" id="cost-other" step="0.01" value="${costs.other || 0}" required>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary">Cancelar</button>
                    <button type="submit" class="btn primary">Salvar</button>
                </div>
            `;
            form.onsubmit = (e) => { e.preventDefault(); saveCostsData(); };
            modal.classList.add('active');
        };

        const saveEventData = () => {
            const event = getActiveEvent();
            if (!event) return;
            event.eventData = {
                ...event.eventData,
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value,
                location: document.getElementById('event-location').value,
                description: document.getElementById('event-description').value,
                isFree: document.getElementById('event-is-free').checked // NOVO
            };
            saveData();
            renderEventInfo();
            renderDashboard();
            populateEventSelector();
            renderPageContent(state.activePage); // Re-renderiza a página para ocultar/mostrar menus
            closeAllModals();
        };

        const saveCostsData = () => {
            const event = getActiveEvent();
            if (!event) return;
            event.eventData.costs = {
                food: parseFloat(document.getElementById('cost-food').value) || 0,
                music: parseFloat(document.getElementById('cost-music').value) || 0,
                venue: parseFloat(document.getElementById('cost-venue').value) || 0,
                drinks: parseFloat(document.getElementById('cost-drinks').value) || 0,
                other: parseFloat(document.getElementById('cost-other').value) || 0
            };
            saveData();
            renderCostsInfo();
            renderDashboard();
            closeAllModals();
        };

        // ===== PÁGINA DE TAREFAS =====
        const renderTasksPage = () => {
            const event = getActiveEvent();
            const container = document.getElementById('tasks-list');
            const form = document.getElementById('add-task-form');
            const input = document.getElementById('new-task-input');

            if (!event) {
                container.innerHTML = '<li class="list-item">Selecione um evento para ver as tarefas</li>';
                form.style.display = 'none';
                return;
            }

            form.style.display = 'flex';
            form.onsubmit = (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (text) {
                    addTask(text);
                    input.value = '';
                }
            };
            
            renderTasksList();
        };

        const renderTasksList = () => {
            const event = getActiveEvent();
            const container = document.getElementById('tasks-list');
            
            if (!event) return; 

            if (event.tasks.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhuma tarefa cadastrada</li>';
                return;
            }
            
            container.innerHTML = '';
            
            const pendingTasks = event.tasks.filter(t => !t.completed);
            const completedTasks = event.tasks.filter(t => t.completed);

            pendingTasks.forEach(task => container.appendChild(createTaskElement(task)));
            completedTasks.forEach(task => container.appendChild(createTaskElement(task)));
        };

        const createTaskElement = (task) => {
            const li = document.createElement('li');
            li.className = 'list-item';
            
            li.innerHTML = `
                <div class="task-content">
                    <input type="checkbox" onchange="toggleTaskCompletion(${task.id})" ${task.completed ? 'checked' : ''}>
                    <span class="${task.completed ? 'completed' : ''}">${task.text}</span>
                </div>
                <button class="delete-btn" onclick="deleteTask(${task.id})"><i class="fa-solid fa-trash"></i></button>
            `;
            return li;
        };

        const addTask = (text) => {
            const event = getActiveEvent();
            if (!event) return;
            
            const newTask = {
                id: Date.now(),
                text: text,
                completed: false
            };
            
            event.tasks.push(newTask);
            saveData();
            renderTasksList();
            renderDashboard(); 
        };

        const toggleTaskCompletion = (taskId) => {
            const event = getActiveEvent();
            if (!event) return;
            
            const task = event.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
            }
            
            saveData();
            renderTasksList();
            renderDashboard(); 
        };
        
        const deleteTask = (taskId) => {
            const event = getActiveEvent();
            if (!event) return;
            
            event.tasks = event.tasks.filter(t => t.id !== taskId);
            
            saveData();
            renderTasksList();
            renderDashboard(); 
        };


        // ===== PÁGINA DE CONVIDADOS =====
        const renderGuestsPage = () => {
            const container = document.getElementById('guests-list');
            const searchInput = document.getElementById('guest-search');
            const event = getActiveEvent();

            if (!event) {
                container.innerHTML = '<li class="list-item">Selecione um evento para ver os convidados</li>';
                searchInput.disabled = true;
                return;
            }
            
            searchInput.disabled = false;
            searchInput.oninput = () => renderGuestsList();
            renderGuestsList();
        };

        const renderGuestsList = () => {
            const event = getActiveEvent();
            const container = document.getElementById('guests-list');
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            
            if (!event) {
                container.innerHTML = '<li class="list-item">Selecione um evento para ver os convidados</li>';
                return;
            }
            
            const isFree = event.eventData.isFree;
            
            const filteredGuests = event.guests.filter(guest => 
                guest.name.toLowerCase().includes(searchTerm) || 
                (guest.phone && guest.phone.includes(searchTerm)) ||
                (guest.email && guest.email.toLowerCase().includes(searchTerm))
            );
            
            if (filteredGuests.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum convidado encontrado</li>';
                return;
            }
            
            container.innerHTML = '';
            
            filteredGuests.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const familyCount = guest.familyCount || 1;
                const checkedInCount = guest.checkedInCount || 0;
                
                // NOVO: Lógica de status de check-in (parcial)
                const checkinStatus = guest.checkedIn ? 'checked' : (checkedInCount > 0 ? 'partial' : 'not-checked');
                const checkinText = guest.checkedIn ? 'Check-in Completo' : (checkedInCount > 0 ? `Entrada Parcial (${checkedInCount}/${familyCount})` : 'Não Entrou');
                
                let paymentHtml = '';
                if (!isFree) {
                    const totalAmount = guest.totalAmount || 0;
                    const paidAmount = guest.paidAmount || 0;
                    const paymentStatus = guest.paymentStatus || 'pending';
                    paymentHtml = `
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span style="font-weight: 500;">${formatCurrency(paidAmount)} / ${formatCurrency(totalAmount)}</span>
                    `;
                }
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-user" style="color: ${checkinStatus === 'not-checked' ? 'var(--text-light-color)' : 'var(--success-color)'};"></i>
                        <div>
                            <div><strong>${guest.name}</strong> (${familyCount} ${familyCount > 1 ? 'pessoas' : 'pessoa'})</div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${guest.phone || 'Sem telefone'}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        ${paymentHtml}
                        <span class="checkin-status ${checkinStatus}">${checkinText}</span>
                        <button class="btn secondary" onclick="editGuest(${guest.id})" style="padding: 8px 10px;"><i class="fa-solid fa-edit"></i></button>
                        <button class="btn secondary" onclick="showReceipt(${guest.id})" style="padding: 8px 10px;"><i class="fa-solid fa-receipt"></i></button>
                        <button class="delete-btn" onclick="confirmDelete(${guest.id}, 'guest')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(li);
            });
        };

        const showGuestModal = (guestId = null) => {
            const event = getActiveEvent();
            if (!event) {
                alert('Por favor, selecione um evento primeiro.');
                return;
            }
            const modal = document.getElementById('guest-modal');
            const title = document.getElementById('guest-modal-title');
            const form = document.getElementById('guest-form');
            const isEditing = guestId !== null;
            const guest = isEditing ? event.guests.find(g => g.id === guestId) : null;
            
            const isFree = event.eventData.isFree; // NOVO
            
            title.textContent = isEditing ? 'Editar Convidado' : 'Adicionar Convidado';

            let accessCodeHtml = '';
            if (isEditing) {
                accessCodeHtml = `
                <div class="form-control">
                    <label>Código de Acesso</label>
                    <input type="text" value="${guest.accessCode}" readonly style="background-color: #eee; text-align: center; font-size: 1.2rem; letter-spacing: 0.2em;">
                </div>`;
            }
            
            form.innerHTML = `
                <div class="form-control">
                    <label for="guest-name">Nome (Responsável/Família)</label>
                    <input type="text" id="guest-name" value="${guest ? guest.name : ''}" required>
                </div>
                <div class="form-control">
                    <label for="guest-phone">Telefone</label>
                    <input type="tel" id="guest-phone" value="${guest ? guest.phone : ''}" required>
                </div>
                <div class="form-control">
                    <label for="guest-family-count">Total de Pessoas (incl. convidado)</label>
                    <input type="number" id="guest-family-count" min="1" step="1" value="${guest ? (guest.familyCount || 1) : '1'}" required>
                </div>
                ${accessCodeHtml} 
                <div class="form-control">
                    <label for="guest-email">E-mail (Opcional)</label>
                    <input type="email" id="guest-email" value="${guest ? guest.email : ''}">
                </div>
                <div class="form-control" ${isFree ? 'style="display:none;"' : ''}>
                    <label for="guest-total-amount">Valor Total</label>
                    <input type="number" id="guest-total-amount" step="0.01" value="${guest ? guest.totalAmount : '0'}" required>
                </div>
                <div class="form-control" ${isFree ? 'style="display:none;"' : ''}>
                    <label for="guest-paid-amount">Valor Pago</label>
                    <input type="number" id="guest-paid-amount" step="0.01" value="${guest ? guest.paidAmount : '0'}" required>
                </div>
                <div class="form-control" ${isFree ? 'style="display:none;"' : ''}>
                    <label for="guest-payment-status">Status do Pagamento</label>
                    <select id="guest-payment-status">
                        <option value="pending" ${guest && guest.paymentStatus === 'pending' ? 'selected' : ''}>Pendente</option>
                        <option value="partial" ${guest && guest.paymentStatus === 'partial' ? 'selected' : ''}>Parcial</option>
                        <option value="paid" ${guest && guest.paymentStatus === 'paid' ? 'selected' : ''}>Pago</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary">Cancelar</button>
                    <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                </div>
            `;
            form.onsubmit = (e) => { e.preventDefault(); saveGuestData(guestId); };
            modal.classList.add('active');
        };

        const saveGuestData = (guestId = null) => {
            const event = getActiveEvent();
            if (!event) return;
            
            const isFree = event.eventData.isFree;
            
            const name = document.getElementById('guest-name').value;
            const email = document.getElementById('guest-email').value;
            const phone = document.getElementById('guest-phone').value;
            const familyCount = parseInt(document.getElementById('guest-family-count').value) || 1; // NOVO
            
            // NOVO: Lógica de pagamento para evento gratuito
            const totalAmount = isFree ? 0 : (parseFloat(document.getElementById('guest-total-amount').value) || 0);
            const paidAmount = isFree ? 0 : (parseFloat(document.getElementById('guest-paid-amount').value) || 0);
            
            let paymentStatus;
            if (isFree) {
                paymentStatus = 'paid'; // Evento gratuito é considerado 'pago' para fins de acesso
            } else {
                paymentStatus = document.getElementById('guest-payment-status').value;
                const autoPaymentStatus = paidAmount === 0 ? 'pending' : (paidAmount >= totalAmount ? 'paid' : 'partial');
                paymentStatus = paymentStatus || autoPaymentStatus;
            }

            if (guestId !== null) {
                const index = event.guests.findIndex(g => g.id === guestId);
                if (index !== -1) {
                    // Mantém checkedInCount se familyCount não for alterado
                    const oldFamilyCount = event.guests[index].familyCount || 1;
                    let checkedInCount = event.guests[index].checkedInCount || 0;
                    if (familyCount !== oldFamilyCount) {
                         checkedInCount = 0; // Reseta o check-in se o total de pessoas mudou
                    }
                    
                    event.guests[index] = {
                        ...event.guests[index],
                        name, email, phone, totalAmount, paidAmount,
                        familyCount: familyCount, // NOVO
                        checkedInCount: checkedInCount, // NOVO
                        checkedIn: (checkedInCount >= familyCount), // NOVO
                        paymentStatus: paymentStatus,
                        lastPaymentDate: (paidAmount > event.guests[index].paidAmount && !isFree) ? new Date().toISOString() : event.guests[index].lastPaymentDate
                    };
                }
            } else {
                const existingCodes = new Set(event.guests.map(g => g.accessCode));
                let newCode;
                do {
                    newCode = Math.floor(1000 + Math.random() * 9000);
                } while (existingCodes.has(newCode));

                const newGuest = {
                    id: Date.now(),
                    name, email, phone, totalAmount, paidAmount,
                    paymentStatus: paymentStatus,
                    familyCount: familyCount, // NOVO
                    checkedIn: false, // NOVO
                    checkedInCount: 0, // NOVO
                    regOrder: event.guests.length + 1,
                    lastPaymentDate: (paidAmount > 0 && !isFree) ? new Date().toISOString() : null,
                    accessCode: newCode
                };
                event.guests.push(newGuest);
            }
            saveData();
            renderGuestsList();
            renderDashboard();
            renderPaymentsPage();
            closeAllModals();
        };

        const editGuest = (guestId) => { showGuestModal(guestId); };

        // ===== PÁGINA DE FORNECEDORES =====
        const renderSuppliersPage = () => { renderSuppliersList(); };

        const renderSuppliersList = () => {
            const event = getActiveEvent();
            const container = document.getElementById('suppliers-list');
            
            if (!event) {
                container.innerHTML = '<li class="list-item">Selecione um evento para ver os fornecedores</li>';
                return;
            }
            if (event.suppliers.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum fornecedor cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            event.suppliers.forEach(supplier => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-truck"></i>
                        <div>
                            <div><strong>${supplier.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${supplier.service}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span style="font-weight: 500;">${formatCurrency(supplier.cost || 0)}</span>
                        <button class="btn secondary" onclick="editSupplier(${supplier.id})" style="padding: 8px 10px;"><i class="fa-solid fa-edit"></i></button>
                        <button class="delete-btn" onclick="confirmDelete(${supplier.id}, 'supplier')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(li);
            });
        };

        const showSupplierModal = (supplierId = null) => {
            const event = getActiveEvent();
            if (!event) {
                alert('Por favor, selecione um evento primeiro.');
                return;
            }
            const modal = document.getElementById('supplier-modal');
            const title = document.getElementById('supplier-modal-title');
            const form = document.getElementById('supplier-form');
            const isEditing = supplierId !== null;
            const supplier = isEditing ? event.suppliers.find(s => s.id === supplierId) : null;
            
            title.textContent = isEditing ? 'Editar Fornecedor' : 'Adicionar Fornecedor';
            form.innerHTML = `
                <div class="form-control">
                    <label for="supplier-name">Nome</label>
                    <input type="text" id="supplier-name" value="${supplier ? supplier.name : ''}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-service">Serviço</label>
                    <input type="text" id="supplier-service" value="${supplier ? supplier.service : ''}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-phone">Telefone</label>
                    <input type="tel" id="supplier-phone" value="${supplier ? supplier.phone : ''}">
                </div>
                <div class="form-control">
                    <label for="supplier-cost">Custo</label>
                    <input type="number" id="supplier-cost" step="0.01" value="${supplier ? supplier.cost : '0'}" required>
                </div>
                <div class="form-control">
                    <label for="supplier-paid">Valor Pago</label>
                    <input type="number" id="supplier-paid" step="0.01" value="${supplier ? supplier.paid : '0'}" required>
                </div>
                <div class="modal-actions">
                    <div class="spacer"></div>
                    <button type="button" class="btn secondary">Cancelar</button>
                    <button type="submit" class="btn primary">${isEditing ? 'Atualizar' : 'Adicionar'}</button>
                </div>
            `;
            form.onsubmit = (e) => { e.preventDefault(); saveSupplierData(supplierId); };
            modal.classList.add('active');
        };

        const saveSupplierData = (supplierId = null) => {
            const event = getActiveEvent();
            if (!event) return;
            const name = document.getElementById('supplier-name').value;
            const service = document.getElementById('supplier-service').value;
            const phone = document.getElementById('supplier-phone').value;
            const cost = parseFloat(document.getElementById('supplier-cost').value) || 0;
            const paid = parseFloat(document.getElementById('supplier-paid').value) || 0;
            
            if (supplierId !== null) {
                const index = event.suppliers.findIndex(s => s.id === supplierId);
                if (index !== -1) {
                    event.suppliers[index] = { ...event.suppliers[index], name, service, phone, cost, paid };
                }
            } else {
                event.suppliers.push({ id: Date.now(), name, service, phone, cost, paid });
            }
            saveData();
            renderSuppliersList();
            renderDashboard();
            renderPaymentsPage();
            closeAllModals();
        };

        const editSupplier = (supplierId) => { showSupplierModal(supplierId); };

        // ===== PÁGINA DE PAGAMENTOS =====
        const renderPaymentsPage = () => {
            const event = getActiveEvent();
            if (!event) {
                document.getElementById('payments-total-received').textContent = formatCurrency(0);
                document.getElementById('payments-total-pending').textContent = formatCurrency(0);
                document.getElementById('guest-payments-list').innerHTML = '<li class="list-item">Nenhum evento selecionado</li>';
                document.getElementById('supplier-payments-list').innerHTML = '<li class="list-item">Nenhum evento selecionado</li>';
                return;
            }
            
            // Esta página não deve ser acessível se o evento for gratuito,
            // mas colocamos esta verificação por segurança.
            if (event.eventData.isFree) {
                 navigateToPage('dashboard-page');
                 return;
            }
            
            const totalReceived = event.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalPending = event.guests.reduce((sum, guest) => {
                const total = guest.totalAmount || 0;
                const paid = guest.paidAmount || 0;
                return sum + (total - paid);
            }, 0);
            
            document.getElementById('payments-total-received').textContent = formatCurrency(totalReceived);
            document.getElementById('payments-total-pending').textContent = formatCurrency(totalPending);
            renderGuestPaymentsList();
            renderSupplierPaymentsList();
        };

        const renderGuestPaymentsList = () => {
            const event = getActiveEvent();
            const container = document.getElementById('guest-payments-list');
            if (!event) return;
            if (event.guests.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum convidado cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            event.guests.forEach(guest => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const paymentStatus = guest.paymentStatus || 'pending';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-user"></i>
                        <div>
                            <div><strong>${guest.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${guest.phone || guest.email}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span style="font-weight: 500;">${formatCurrency(paidAmount)} / ${formatCurrency(totalAmount)}</span>
                        <button class="btn secondary" onclick="editGuest(${guest.id})" style="padding: 8px 10px;"><i class="fa-solid fa-edit"></i></button>
                        <button class="btn secondary" onclick="showReceipt(${guest.id})" style="padding: 8px 10px;"><i class="fa-solid fa-receipt"></i></button>
                    </div>
                `;
                container.appendChild(li);
            });
        };

        const renderSupplierPaymentsList = () => {
            const event = getActiveEvent();
            const container = document.getElementById('supplier-payments-list');
            if (!event) return;
            if (event.suppliers.length === 0) {
                container.innerHTML = '<li class="list-item" style="justify-content: center; opacity: 0.7;">Nenhum fornecedor cadastrado</li>';
                return;
            }
            
            container.innerHTML = '';
            event.suppliers.forEach(supplier => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const cost = supplier.cost || 0;
                const paid = supplier.paid || 0;
                const paymentStatus = paid >= cost ? 'paid' : paid > 0 ? 'partial' : 'pending';
                
                li.innerHTML = `
                    <div class="list-item-main">
                        <i class="fa-solid fa-truck"></i>
                        <div>
                            <div><strong>${supplier.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--text-light-color);">${supplier.service}</div>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <span class="status ${paymentStatus}">${getPaymentStatusText(paymentStatus)}</span>
                        <span style="font-weight: 500;">${formatCurrency(paid)} / ${formatCurrency(cost)}</span>
                        <button class="btn secondary" onclick="editSupplier(${supplier.id})" style="padding: 8px 10px;"><i class="fa-solid fa-edit"></i></button>
                    </div>
                `;
                container.appendChild(li);
            });
        };

        // ===== PÁGINA DE CONTROLE DE ENTRADA (Refatorado com QR Scanner) =====
        const renderCheckinPage = () => {
            const form = document.getElementById('checkin-form');
            const input = document.getElementById('checkin-code');
            const resultDiv = document.getElementById('checkin-result');
            
            const startBtn = document.getElementById('start-qr-scanner-btn');
            const stopBtn = document.getElementById('stop-qr-scanner-btn');
            const toggleManualBtn = document.getElementById('toggle-manual-checkin');
            const manualContainer = document.getElementById('manual-checkin-container');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                processCheckinCode(input.value); 
            };

            input.onfocus = () => {
                resultDiv.style.display = 'none';
            }
            
            startBtn.onclick = startQrScanner;
            stopBtn.onclick = stopQrScanner;
            
            toggleManualBtn.onclick = (e) => {
                e.preventDefault();
                if (manualContainer.style.display === 'none') {
                    manualContainer.style.display = 'block';
                    toggleManualBtn.innerHTML = '<i class="fa-solid fa-qrcode"></i> Voltar para o Leitor QR';
                    stopQrScanner(); // Para o scanner se estiver ativo
                } else {
                    manualContainer.style.display = 'none';
                    toggleManualBtn.innerHTML = '<i class="fa-solid fa-keyboard"></i> Não conseguiu ler? Digite o código manual.';
                }
            };
        };

        /**
         * Inicia o leitor de QR Code
         */
        const startQrScanner = () => {
            const resultDiv = document.getElementById('checkin-result');
            resultDiv.style.display = 'none'; 
            
            document.getElementById('qr-scanner-container').style.display = 'block';

            if (state.qrScanner) {
                stopQrScanner();
            }

            const onScanSuccess = (decodedText, decodedResult) => {
                console.log(`Code matched = ${decodedText}`, decodedResult);
                processCheckinCode(decodedText); 
                // Não para mais o scanner, permite múltiplas leituras
                // stopQrScanner(); 
                
                // Pisca o resultado
                setTimeout(() => {
                    document.getElementById('checkin-result').style.display = 'none';
                }, 2000); // Esconde o resultado após 2 segundos
            };

            const onScanFailure = (error) => {
                // console.warn(`Code scan error = ${error}`);
            };

            state.qrScanner = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            state.qrScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch((err) => {
                    console.log("Falha ao iniciar a câmera traseira, tentando câmera frontal.", err);
                    state.qrScanner.start({ facingMode: "user" }, config, onScanSuccess, onScanFailure)
                        .catch((err2) => {
                            console.error("Não foi possível iniciar nenhuma câmera.", err2);
                            resultDiv.innerHTML = `<h4>Erro de Câmera</h4><p>Não foi possível acessar a câmera para o leitor de QR Code.</p>`;
                            resultDiv.className = 'checkin-result error';
                            resultDiv.style.display = 'block';
                            stopQrScanner(); 
                        });
                });
        };

        /**
         * Para o leitor de QR Code
         */
        const stopQrScanner = () => {
            const container = document.getElementById('qr-scanner-container');
            if (state.qrScanner && state.qrScanner.isScanning) {
                try {
                    state.qrScanner.stop().then((ignore) => {
                        console.log("QR Scanner parado.");
                        container.style.display = 'none';
                        state.qrScanner = null;
                    }).catch((err) => {
                        console.log("Falha ao parar QR Scanner (provavelmente já estava parado).");
                        container.style.display = 'none';
                        state.qrScanner = null;
                    });
                } catch (err) {
                     console.log("Falha ao parar QR Scanner.", err);
                     container.style.display = 'none';
                     state.qrScanner = null;
                }
            } else {
                 container.style.display = 'none';
            }
        };


        /**
         * NOVO: Processa código de check-in com lógica de contagem
         */
        const processCheckinCode = (code) => {
            const event = getActiveEvent();
            const input = document.getElementById('checkin-code');
            const resultDiv = document.getElementById('checkin-result');
            
            if (!event) {
                resultDiv.innerHTML = `<h4>Nenhum Evento Ativo</h4><p>Por favor, selecione um evento para iniciar o check-in.</p>`;
                resultDiv.className = 'checkin-result error';
                resultDiv.style.display = 'block';
                return;
            }

            if (!code) {
                resultDiv.innerHTML = `<h4>Código Inválido</h4><p>O código está em branco.</p>`;
                resultDiv.className = 'checkin-result error';
                resultDiv.style.display = 'block';
                return;
            }

            // Encontra o convidado pelo código de acesso
            const guest = event.guests.find(g => String(g.accessCode) === String(code));

            if (!guest) {
                resultDiv.innerHTML = `<h4>Código Invállido</h4><p>Nenhum convidado encontrado com este código (${code}).</p>`;
                resultDiv.className = 'checkin-result error';
            } else {
                const familyCount = guest.familyCount || 1;
                let checkedInCount = guest.checkedInCount || 0;
                const isFree = event.eventData.isFree;

                // 1. Verifica se o pagamento é necessário e se está pendente
                if (!isFree && guest.paymentStatus !== 'paid') {
                    resultDiv.innerHTML = `<h4>Pagamento Pendente</h4><p>A entrada de <strong>${guest.name}</strong> não pode ser liberada.</p><p>Status do Pagamento: <strong>${getPaymentStatusText(guest.paymentStatus)}</strong>.</p><p>Favor regularizar a situação.</p>`;
                    resultDiv.className = 'checkin-result error';
                
                // 2. Verifica se o check-in do grupo já está completo
                } else if (guest.checkedIn || checkedInCount >= familyCount) {
                    guest.checkedIn = true; // Garante que está marcado
                    resultDiv.innerHTML = `<h4>Check-in Completo</h4><p><strong>${guest.name}</strong> já registrou todas as ${familyCount} entradas.</p>`;
                    resultDiv.className = 'checkin-result pending'; // 'pending' (amarelo) para "já registrado"
                
                // 3. Processa a nova entrada
                } else {
                    checkedInCount++;
                    guest.checkedInCount = checkedInCount;
                    guest.checkinTime = new Date().toISOString(); // Atualiza para a hora da última entrada

                    // 3a. Verifica se esta foi a última entrada
                    if (checkedInCount >= familyCount) {
                        guest.checkedIn = true; // Marca o grupo como totalmente check-in
                        resultDiv.innerHTML = `<h4>Entrada Registrada (${checkedInCount}/${familyCount})</h4><p>Bem-vindo(a), <strong>${guest.name}</strong>!</p><p>Este foi o último membro. Check-in completo.</p>`;
                        resultDiv.className = 'checkin-result success';
                    
                    // 3b. Ainda faltam entradas
                    } else {
                        guest.checkedIn = false; // Garante que não está marcado como completo
                        resultDiv.innerHTML = `<h4>Entrada Registrada (${checkedInCount}/${familyCount})</h4><p>Bem-vindo(a), <strong>${guest.name}</strong>!</p><p>Ainda restam ${familyCount - checkedInCount} entradas para este convite.</p>`;
                        resultDiv.className = 'checkin-result success'; // Sucesso, mas parcial
                    }
                    
                    saveData();
                    
                    // Atualiza a lista de convidados e dashboard
                    if (state.activePage === 'guests-page') renderGuestsList();
                    renderDashboard(); // Sempre atualiza o dashboard (gráfico de check-in)
                }
            }

            resultDiv.style.display = 'block';
            input.value = ''; // Limpa o campo manual
        };

        // ===== PÁGINA DE RELATÓRIOS =====
        const renderReportsPage = () => {
            const event = getActiveEvent();
            if (!event) {
                document.getElementById('total-income').textContent = formatCurrency(0);
                document.getElementById('total-expenses').textContent = formatCurrency(0);
                document.getElementById('final-balance').textContent = formatCurrency(0);
                return;
            }
            
            // Segurança: redireciona se for gratuito
            if (event.eventData.isFree) {
                 navigateToPage('dashboard-page');
                 return;
            }
            
            const totalIncome = event.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalExpenses = calculateTotalCost();
            const finalBalance = totalIncome - totalExpenses;
            
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('final-balance').textContent = formatCurrency(finalBalance);
            
            document.getElementById('generate-balance-report-btn').onclick = () => generateBalancePDF();
            document.getElementById('generate-guest-payments-report-btn').onclick = () => generateGuestPaymentsPDF();
            document.getElementById('generate-expenses-report-btn').onclick = () => generateExpensesPDF();
        };

        // ===== PÁGINA DE BACKUP =====
        const renderBackupPage = () => {
            document.getElementById('export-data-btn').onclick = exportAllData;
            document.getElementById('export-guests-btn').onclick = exportGuestsData;
            document.getElementById('import-data-btn').onclick = importData;
            document.getElementById('clear-data-btn').onclick = confirmClearData;
        };

        const exportAllData = () => {
            const data = {
                events: state.events,
                activeEventId: state.activeEventId,
                exportDate: new Date().toISOString()
            };
            downloadJSON(data, 'eventos-pro-backup-completo-v3.json');
        };

        const exportGuestsData = () => {
            const event = getActiveEvent();
            if (!event) {
                alert('Selecione um evento para exportar os convidados.');
                return;
            }
            const data = {
                eventName: event.eventData.name,
                guests: event.guests,
                exportDate: new Date().toISOString()
            };
            downloadJSON(data, `eventos-pro-convidados-${event.eventData.name.replace(/ /g, '_')}.json`);
        };

        const importData = () => {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecione um arquivo de backup.');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.events) {
                        importedData.events.forEach(importedEvent => {
                            const existingIndex = state.events.findIndex(e => e.id === importedEvent.id);
                            if (existingIndex === -1) {
                                state.events.push(importedEvent);
                            } else {
                                state.events[existingIndex] = importedEvent;
                            }
                        });
                        if (importedData.activeEventId) {
                            state.activeEventId = importedData.activeEventId;
                        }
                    } else {
                        alert('Arquivo de backup inválido.');
                        return;
                    }
                    saveData();
                    alert('Dados importados com sucesso! Recarregando a página.');
                    location.reload(); 
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    alert('Erro ao importar dados. Verifique se o arquivo é válido.');
                }
            };
            reader.readAsText(file);
        };

        const confirmClearData = () => {
            if (confirm('Tem certeza que deseja limpar TODOS OS DADOS de TODOS OS EVENTOS? Esta ação não pode ser desfeita.')) {
                localStorage.removeItem('eventManagementData_v3');
                alert('Todos os dados foram removidos.');
                location.reload();
            }
        };

        const downloadJSON = (data, filename) => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ===== COMPROVANTE / CONVITE (PDF com QR Code) (Refatorado) =====
        const showReceipt = (guestId) => {
            const event = getActiveEvent();
            if (!event) {
                alert('Nenhum evento ativo selecionado!');
                return;
            }
            const guest = event.guests.find(g => g.id === guestId);
            if (!guest) {
                alert('Convidado não encontrado!');
                return;
            }

            const isFree = event.eventData.isFree; // NOVO
            const docTitle = isFree ? 'Convite' : 'Comprovante de Pagamento';
            const docFileName = isFree ? 'convite' : 'recibo';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [100, 150]
            });

            const primaryColor = '#5636D3';
            const textColor = '#363F5F';
            const lightTextColor = '#969CB2';
            const dangerColor = '#E83F5B';
            const successColor = '#12A454';
            const margin = 10;
            let yPosition = 15;

            // Cabeçalho
            doc.setFontSize(16);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text(event.eventData.name || (isFree ? 'Convite' : 'Comprovante'), doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 6;
            
            doc.setFontSize(10);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'normal');
            doc.text(docTitle, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 4;
            
            doc.setLineWidth(0.5);
            doc.setDrawColor(primaryColor);
            doc.line(margin, yPosition, doc.internal.pageSize.getWidth() - margin, yPosition);
            yPosition += 10;

            // Detalhes
            const addDetail = (label, value) => {
                doc.setFontSize(10);
                doc.setTextColor(lightTextColor);
                doc.setFont(undefined, 'normal');
                doc.text(label, margin, yPosition);
                
                doc.setTextColor(textColor);
                doc.setFont(undefined, 'bold');
                doc.text(String(value), doc.internal.pageSize.getWidth() - margin, yPosition, { align: 'right' });
                
                yPosition += 7;
            };

            addDetail('Convidado:', guest.name);
            addDetail('Telefone:', guest.phone || 'N/A');
            addDetail('Total de Pessoas:', guest.familyCount || 1); // NOVO
            addDetail('Evento:', event.eventData.name || 'N/A');
            addDetail('Data do Evento:', event.eventData.date ? new Date(event.eventData.date).toLocaleDateString('pt-BR') : 'N/A');
            yPosition += 3;
            
            // NOVO: Detalhes de pagamento ou entrada gratuita
            if (isFree) {
                addDetail('Entrada:', 'Gratuita');
            } else {
                addDetail('Valor Total:', formatCurrency(guest.totalAmount || 0));
                addDetail('Valor Pago:', formatCurrency(guest.paidAmount || 0));
                addDetail('Status:', getPaymentStatusText(guest.paymentStatus));
            }
            yPosition += 5;

            // --- Geração do QR Code ---
            try {
                const qr = qrcode(0, 'M'); 
                qr.addData(String(guest.accessCode)); 
                qr.make();
                const qrImgData = qr.createDataURL(5, 5); 

                const qrSize = 40;
                const qrX = (doc.internal.pageSize.getWidth() / 2) - (qrSize / 2);
                doc.addImage(qrImgData, 'PNG', qrX, yPosition, qrSize, qrSize);
                
                yPosition += qrSize + 7; 

                doc.setFontSize(14);
                doc.setTextColor(textColor);
                doc.setFont(undefined, 'bold');
                doc.text(`CÓDIGO: ${guest.accessCode}`, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
                yPosition += 7; 

            } catch (qrError) {
                console.error("Erro ao gerar QR Code:", qrError);
                doc.setFontSize(10);
                doc.setTextColor(dangerColor);
                doc.text('Erro ao gerar QR Code.', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
                yPosition += 10;
            }
            // --- Fim do QR Code ---


            // Rodapé
            yPosition = 135; 
            doc.setLineWidth(0.2);
            doc.setDrawColor(lightTextColor);
            doc.line(margin, yPosition, doc.internal.pageSize.getWidth() - margin, yPosition);
            yPosition += 5;

            doc.setFontSize(8);
            doc.setTextColor(lightTextColor);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 4;
            
            doc.setFontSize(9);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'bold');
            doc.text('Eventos Pro', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            yPosition += 4;
            
            doc.setFontSize(8);
            doc.setTextColor(lightTextColor);
            doc.setFont(undefined, 'normal');
            doc.text('Desenvolvido por: Dj Alek', doc.internal.pageSize.getWidth() / 2, yPosition, { align: 'center' });
            
            // NOVO: Nome do arquivo dinâmico
            doc.save(`${docFileName}-${guest.name.replace(/ /g, '_')}-${guest.id}.pdf`);
        };

        // ===== EXCLUSÃO DE ITENS =====
        const confirmDelete = (id, type) => {
            const event = getActiveEvent();
            if (!event) return;
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-modal-title');
            const message = document.getElementById('delete-message');
            state.currentEditingId = id;
            state.currentEditingType = type;
            
            if (type === 'guest') {
                const guest = event.guests.find(g => g.id === id);
                title.textContent = 'Excluir Convidado';
                message.textContent = `Tem certeza que deseja excluir o convidado "${guest.name}"? Esta ação não pode ser desfeita.`;
            } else if (type === 'supplier') {
                const supplier = event.suppliers.find(s => s.id === id);
                title.textContent = 'Excluir Fornecedor';
                message.textContent = `Tem certeza que deseja excluir o fornecedor "${supplier.name}"? Esta ação não pode ser desfeita.`;
            }
            modal.classList.add('active');
        };

        document.getElementById('confirm-delete-btn').onclick = () => {
            const event = getActiveEvent();
            if (!event) return;
            if (state.currentEditingType === 'guest') {
                event.guests = event.guests.filter(g => g.id !== state.currentEditingId);
                saveData();
                renderGuestsList();
            } else if (state.currentEditingType === 'supplier') {
                event.suppliers = event.suppliers.filter(s => s.id !== state.currentEditingId);
                saveData();
                renderSuppliersList();
            }
            
            renderDashboard();
            renderPaymentsPage();
            closeAllModals();
        };

        
        // ===== RELATÓRIOS PDF =====

        const addPdfHeaderAndFooter = (doc, title) => {
            const pageCount = doc.internal.getNumberOfPages();
            const pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
            const event = getActiveEvent();
            
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // --- CABEÇALHO ---
                doc.setFontSize(18);
                doc.setTextColor(86, 54, 211); // var(--primary-color)
                doc.setFont('helvetica', 'bold');
                doc.text('Eventos Pro', 20, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(54, 63, 95); // var(--text-color)
                doc.setFont('helvetica', 'normal');
                doc.text(title, 20, 28);
                
                doc.setFontSize(10);
                doc.setTextColor(150, 156, 178); // var(--text-light-color)
                doc.text(`Evento: ${event.eventData.name || 'N/D'}`, pageWidth - 20, 20, { align: 'right' });
                doc.text(`Data: ${new Date().toLocaleString('pt-BR')}`, pageWidth - 20, 28, { align: 'right' });

                // Linha
                doc.setDrawColor(234, 235, 240); // var(--border-color)
                doc.line(20, 35, pageWidth - 20, 35);

                // --- RODAPÉ ---
                doc.setFontSize(9);
                doc.setTextColor(150, 156, 178);
                doc.text(`Página ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }
        };

        const generateBalancePDF = () => {
            const event = getActiveEvent();
            if (!event || event.eventData.isFree) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const totalIncome = event.guests.reduce((sum, guest) => sum + (guest.paidAmount || 0), 0);
            const totalExpenses = calculateTotalCost();
            const finalBalance = totalIncome - totalExpenses;
            
            doc.setFontSize(14);
            doc.setTextColor(54, 63, 95);
            doc.text('Resumo Financeiro', 20, 45);
            
            doc.autoTable({
                startY: 50,
                body: [
                    ['Total de Receitas (Convidados)', formatCurrency(totalIncome)],
                    ['Total de Despesas (Custos + Fornecedores)', formatCurrency(totalExpenses)],
                    [{ content: 'Saldo Final', styles: { fontStyle: 'bold', fontSize: 11 } }, 
                     { content: formatCurrency(finalBalance), styles: { fontStyle: 'bold', fontSize: 11 } }],
                ],
                theme: 'grid',
                styles: { font: 'helvetica', cellPadding: 3, fontSize: 10 },
                headStyles: { fillColor: [86, 54, 211], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [247, 248, 252] }, 
                margin: { left: 20, right: 20 }
            });
            
            const head = [['Descrição da Despesa', 'Valor']];
            const body = [];
            
            const costs = event.eventData.costs || {};
            Object.entries(costs).forEach(([category, amount]) => {
                if (amount > 0) {
                    body.push([getCostCategoryName(category), formatCurrency(amount)]);
                }
            });
            event.suppliers.forEach(supplier => {
                body.push([`${supplier.name} (Fornecedor)`, formatCurrency(supplier.cost || 0)]);
            });
            
            const foot = [[
                { content: 'Total de Despesas', styles: { fontStyle: 'bold', halign: 'right' } }, 
                { content: formatCurrency(totalExpenses), styles: { fontStyle: 'bold' } }
            ]];
            
            doc.setFontSize(14);
            doc.setTextColor(54, 63, 95);
            doc.text('Detalhes das Despesas', 20, doc.autoTable.previous.finalY + 15);

            doc.autoTable({
                head: head,
                body: body,
                foot: foot,
                startY: doc.autoTable.previous.finalY + 20,
                theme: 'grid',
                styles: { font: 'helvetica', cellPadding: 3, fontSize: 10 },
                headStyles: { fillColor: [86, 54, 211], textColor: [255, 255, 255] },
                footStyles: { fillColor: [234, 235, 240], textColor: [54, 63, 95], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [247, 248, 252] },
                margin: { left: 20, right: 20 }
            });
            
            addPdfHeaderAndFooter(doc, 'Relatório Financeiro (Balanço)');
            doc.save(`relatorio-financeiro-${event.eventData.name.replace(/ /g, '_')}.pdf`);
        };

        const generateGuestPaymentsPDF = () => {
            const event = getActiveEvent();
            if (!event || event.eventData.isFree) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // NOVO: Adiciona coluna 'Pessoas'
            const head = [['#', 'Nome', 'Pessoas', 'Valor Total', 'Valor Pago', 'Valor Pendente', 'Status']];
            
            let totalAmountSum = 0;
            let paidAmountSum = 0;
            let totalPeopleSum = 0;
            
            const body = event.guests.map((guest, index) => {
                const totalAmount = guest.totalAmount || 0;
                const paidAmount = guest.paidAmount || 0;
                const pendingAmount = totalAmount - paidAmount;
                const familyCount = guest.familyCount || 1;
                
                totalAmountSum += totalAmount;
                paidAmountSum += paidAmount;
                totalPeopleSum += familyCount;
                
                return [
                    index + 1,
                    guest.name,
                    familyCount, // NOVO
                    formatCurrency(totalAmount),
                    formatCurrency(paidAmount),
                    formatCurrency(pendingAmount),
                    getPaymentStatusText(guest.paymentStatus)
                ];
            });
            
            const pendingAmountSum = totalAmountSum - paidAmountSum;
            
            const foot = [[
                { content: 'Total', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                { content: totalPeopleSum, styles: { fontStyle: 'bold' } }, // NOVO
                { content: formatCurrency(totalAmountSum), styles: { fontStyle: 'bold' } },
                { content: formatCurrency(paidAmountSum), styles: { fontStyle: 'bold' } },
                { content: formatCurrency(pendingAmountSum), styles: { fontStyle: 'bold' } },
                ''
            ]];

            doc.autoTable({
                head: head,
                body: body,
                foot: foot,
                startY: 40,
                theme: 'grid',
                styles: { font: 'helvetica', cellPadding: 3, fontSize: 9 },
                headStyles: { fillColor: [86, 54, 211], textColor: [255, 255, 255] },
                footStyles: { fillColor: [234, 235, 240], textColor: [54, 63, 95], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [247, 248, 252] },
                margin: { left: 15, right: 15 } // Ajustado para caber a nova coluna
            });
            
            addPdfHeaderAndFooter(doc, 'Relatório de Pagamentos de Convidados');
            doc.save(`relatorio-pagamentos-${event.eventData.name.replace(/ /g, '_')}.pdf`);
        };

        const generateExpensesPDF = () => {
            const event = getActiveEvent();
            if (!event) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const head = [['Descrição da Despesa', 'Categoria', 'Valor']];
            const body = [];
            
            const costs = event.eventData.costs || {};
            Object.entries(costs).forEach(([category, amount]) => {
                if (amount > 0) {
                    body.push([getCostCategoryName(category), 'Custo Fixo', formatCurrency(amount)]);
                }
            });
            
            event.suppliers.forEach(supplier => {
                body.push([supplier.name, supplier.service || 'Fornecedor', formatCurrency(supplier.cost || 0)]);
            });
            
            const totalCost = calculateTotalCost();
            const foot = [[
                { content: 'Total de Despesas', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, 
                { content: formatCurrency(totalCost), styles: { fontStyle: 'bold' } }
            ]];
            
            doc.autoTable({
                head: head,
                body: body,
                foot: foot,
                startY: 40,
                theme: 'grid',
                styles: { font: 'helvetica', cellPadding: 3, fontSize: 10 },
                headStyles: { fillColor: [86, 54, 211], textColor: [255, 255, 255] },
                footStyles: { fillColor: [234, 235, 240], textColor: [54, 63, 95], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [247, 248, 252] },
                margin: { left: 20, right: 20 }
            });
            
            addPdfHeaderAndFooter(doc, 'Relatório de Despesas');
            doc.save(`relatorio-despesas-${event.eventData.name.replace(/ /g, '_')}.pdf`);
        };
        
        // ===== INICIALIZAÇÃO =====
        const init = () => {
            initializeData();
            setupEventSelector();
            setupNavigation();
            setupModals();
            navigateToPage(state.activePage); 
            
            // Expor funções globais para uso nos event handlers
            window.editGuest = editGuest;
            window.editSupplier = editSupplier;
            window.confirmDelete = confirmDelete;
            window.showReceipt = showReceipt;
            window.closeAllModals = closeAllModals;
            window.toggleTaskCompletion = toggleTaskCompletion;
            window.deleteTask = deleteTask;
        };

        init();
    });
    </script>
</body>
</html>
