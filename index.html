<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Pro - Sistema de Controle</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        :root {
            --primary-color: #5636D3;
            --secondary-color: #FF872C;
            --success-color: #12A454;
            --danger-color: #E83F5B;
            --pending-color: #4B90F7;
            --background-color: #F0F2F5;
            --text-color: #363F5F;
            --text-light-color: #969CB2;
            --card-bg-color: #FFFFFF;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
        }
        
        /* --- Layout Geral --- */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg-color);
            height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: fixed;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            padding: 2rem 3rem;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        header h2 {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }
        
        /* --- Sidebar --- */
        .sidebar .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 3rem;
        }
        
        .sidebar .logo i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .sidebar .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .sidebar nav ul {
            list-style: none;
        }
        
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            text-decoration: none;
            color: var(--text-light-color);
            font-weight: 500;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sidebar nav li a:hover,
        .sidebar nav li a.active {
            background-color: #f0edff;
            color: var(--primary-color);
        }
        
        .sidebar nav li a i {
            width: 20px;
            text-align: center;
        }
        
        /* --- Elementos Comuns --- */
        .card {
            background-color: var(--card-bg-color);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn.secondary {
            background-color: #e0e0e0;
            color: var(--text-color);
        }
        
        .btn.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn.download {
            background-color: var(--pending-color);
            color: white;
        }
        
        .list-item {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* --- Dashboard --- */
        #dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        /* MELHORIA: Estilo "iPhone" para os cards do dashboard */
        #dashboard-cards .card {
            border-radius: 18px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        #dashboard-cards .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--text-light-color);
        }
        
        .card-header i {
            font-size: 1.8rem;
        }
        
        #dashboard-cards .event i {
            color: var(--primary-color);
        }
        
        #dashboard-cards .guests i {
            color: var(--success-color);
        }
        
        #dashboard-cards .suppliers i {
            color: var(--secondary-color);
        }
        
        #dashboard-cards .payments i {
            color: var(--pending-color);
        }
        
        .card p {
            font-size: 2rem;
            font-weight: 500;
        }
        
        .transaction-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .transaction-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .transaction-status.paid {
            background-color: var(--success-color);
        }
        
        .transaction-status.pending {
            background-color: var(--pending-color);
        }
        
        .transaction-info span {
            display: block;
        }
        
        .transaction-info .description {
            font-weight: 500;
        }
        
        .transaction-info .details {
            font-size: 0.8rem;
            color: var(--text-light-color);
        }
        
        .transaction-amount {
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .transaction-amount.income {
            color: var(--success-color);
        }
        
        .transaction-amount.expense {
            color: var(--danger-color);
        }
        
        .list-item-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* --- Páginas de Gerenciamento --- */
        .management-page .card {
            margin-bottom: 2rem;
        }
        
        .management-page form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .management-page .form-control {
            flex-grow: 1;
            min-width: 200px;
        }
        
        .management-page label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .management-page input,
        .management-page select,
        .management-page textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .management-page .list-item i {
            font-size: 1.2rem;
            margin-right: 1rem;
            color: var(--primary-color);
        }
        
        .list-item-main {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        
        /* --- Página QR Code --- */
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: white;
        }
        
        .qr-code {
            margin: 0 auto;
            max-width: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px; /* For canvas */
        }
        
        .qr-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .qr-scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }
        
        .qr-scanner {
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .qr-scanner video, .qr-scanner canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hidden { display: none; }
        
        .qr-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            background-color: #f8f9fa;
            display: none; /* Hidden by default */
        }
        
        .qr-result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .qr-result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .qr-result.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* --- Página Relatórios --- */
        #reports-page .filters {
            background-color: #fff;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        #reports-page .filters .form-control {
            flex-grow: 1;
            min-width: 200px;
        }
        
        #reports-page .filters label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        #reports-page .filters input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        #report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .report-card p {
            font-size: 1.5rem;
        }
        
        /* --- Modal e FAB --- */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 3rem;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 101;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 102;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background-color: var(--card-bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-content h3 {
            margin-bottom: 1.5rem;
        }
        
        .form-control {
            margin-bottom: 1rem;
        }
        
        .form-control label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control input,
        .form-control select,
        .form-control textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }
        
        .modal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .modal-actions .spacer {
            flex-grow: 1;
        }
        
        /* --- Header Mobile --- */
        .mobile-header {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background-color: var(--card-bg-color);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
        }
        
        .mobile-header #menu-toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
        }
        
        .mobile-header h2 {
            font-size: 1.25rem;
            margin-bottom: 0;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* --- Status --- */
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status.paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.partial {
            background-color: #cce7ff;
            color: #004085;
        }
        
        .checkin-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .checkin-status.checked {
            background-color: #d4edda;
            color: #155724;
        }
        
        .checkin-status.not-checked {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 0;
            }
            
            .page-content {
                padding: 0 1.5rem 1.5rem 1.5rem;
            }
            
            header {
                display: none;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .fab {
                right: 1.5rem;
                bottom: 1.5rem;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .list-item-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fa-solid fa-calendar-alt"></i>
            <h1>Eventos Pro</h1>
        </div>
        <nav>
            <ul id="nav-links">
                <li><a data-page="dashboard-page" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a></li>
                <li><a data-page="event-page"><i class="fa-solid fa-calendar-check"></i> Evento</a></li>
                <li><a data-page="guests-page"><i class="fa-solid fa-users"></i> Convidados</a></li>
                <li><a data-page="suppliers-page"><i class="fa-solid fa-truck"></i> Fornecedores</a></li>
                <li><a data-page="payments-page"><i class="fa-solid fa-money-bill-wave"></i> Pagamentos</a></li>
                <li><a data-page="qr-page"><i class="fa-solid fa-qrcode"></i> QR Code</a></li>
                <li><a data-page="reports-page"><i class="fa-solid fa-chart-line"></i> Relatórios</a></li>
                <li><a data-page="backup-page"><i class="fa-solid fa-database"></i> Backup</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <header class="mobile-header">
            <button id="menu-toggle-btn"><i class="fa-solid fa-bars"></i></button>
            <h2 id="mobile-page-title">Dashboard</h2>
        </header>

        <section id="dashboard-page" class="page-content active">
            <header><h2>Dashboard</h2></header>
            <div id="dashboard-cards">
                <div class="card event" data-page="event-page">
                    <div class="card-header"><span>Evento</span><i class="fa-solid fa-calendar-alt"></i></div>
                    <p id="dashboard-event-name">Configurar</p>
                </div>
                <div class="card guests" data-page="guests-page">
                    <div class="card-header"><span>Convidados</span><i class="fa-solid fa-users"></i></div>
                    <p id="dashboard-guest-count">0</p>
                </div>
                <div class="card suppliers" data-page="suppliers-page">
                    <div class="card-header"><span>Fornecedores</span><i class="fa-solid fa-truck"></i></div>
                    <p id="dashboard-supplier-count">0</p>
                </div>
                <div class="card payments" data-page="payments-page">
                    <div class="card-header"><span>Total Recebido</span><i class="fa-solid fa-arrow-up"></i></div>
                    <p id="dashboard-payment-total">R$ 0,00</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Resumo Financeiro</h3>
                <div class="form-grid">
                    <div><strong>Custo Total do Evento:</strong> <span id="total-cost">R$ 0,00</span></div>
                    <div><strong>Custo por Convidado:</strong> <span id="cost-per-guest">R$ 0,00</span></div>
                    <div><strong>Total Recebido:</strong> <span id="total-received" style="color: var(--success-color);">R$ 0,00</span></div>
                    <div><strong>Total a Receber:</strong> <span id="total-pending" style="color: var(--danger-color);">R$ 0,00</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>Últimos Pagamentos Recebidos</h3>
                <ul id="recent-payments-list"></ul>
            </div>
        </section>

        <section id="event-page" class="page-content management-page">
            <header><h2>Configuração do Evento</h2></header>
            <div class="card">
                <div class="card-header"><h3>Informações do Evento</h3><button class="btn primary" id="edit-event-btn">Editar Evento</button></div>
                <div id="event-info"></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Custos do Evento</h3><button class="btn primary" id="edit-costs-btn">Editar Custos</button></div>
                <div id="costs-info"></div>
            </div>
        </section>

        <section id="guests-page" class="page-content management-page">
            <header><h2>Lista de Convidados</h2></header>
            <div class="card">
                <div class="form-control"><input type="text" id="guest-search" placeholder="Buscar convidado..."></div>
            </div>
            <ul id="guests-list"></ul>
        </section>

        <section id="suppliers-page" class="page-content management-page">
            <header><h2>Fornecedores</h2></header>
            <ul id="suppliers-list"></ul>
        </section>

        <section id="payments-page" class="page-content">
            <header><h2>Controle de Pagamentos</h2></header>
            <div class="card">
                <div class="form-grid">
                    <div><h3>Total Recebido: <span id="payments-total-received" style="color: var(--success-color);">R$ 0,00</span></h3></div>
                    <div><h3>Total a Receber: <span id="payments-total-pending" style="color: var(--danger-color);">R$ 0,00</span></h3></div>
                </div>
            </div>
            <div class="card"><h3>Pagamentos Recebidos de Convidados</h3><ul id="guest-payments-list"></ul></div>
            <div class="card"><h3>Pagamentos Efetuados a Fornecedores</h3><ul id="supplier-payments-list"></ul></div>
        </section>

        <section id="qr-page" class="page-content">
            <header><h2>Controle de Entrada com QR Code</h2></header>
            <div class="card">
                <h3>Leitor de QR Code</h3>
                <p>Use esta ferramenta para escanear os QR Codes dos convidados na entrada do evento.</p>
                <div class="qr-scanner-container">
                    <div class="qr-scanner" id="qr-scanner">
                        <div id="qr-scanner-placeholder"><p>Clique em "Iniciar Câmera" para escanear</p></div>
                        <video id="qr-video" class="hidden" playsinline></video>
                        <canvas id="qr-canvas" class="hidden"></canvas>
                    </div>
                    <div class="modal-actions" style="justify-content: center;">
                        <button class="btn success" id="start-camera-btn">Iniciar Câmera</button>
                        <button class="btn secondary hidden" id="stop-camera-btn">Parar Câmera</button>
                    </div>
                    <div id="qr-result" class="qr-result"></div>
                </div>
            </div>
            <div class="card">
                <h3>QR Codes dos Convidados</h3>
                <p>Lista de convidados com seus respectivos QR Codes para entrada no evento.</p>
                <div id="qr-codes-list" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem;"></div>
            </div>
        </section>

        <section id="reports-page" class="page-content">
            <header><h2>Relatórios Financeiros</h2></header>
             <div id="report-summary">
                <div class="card"><div class="card-header"><span>Total de Receitas</span></div><p id="total-income">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Total de Despesas</span></div><p id="total-expenses">R$ 0,00</p></div>
                <div class="card"><div class="card-header"><span>Saldo Final</span></div><p id="final-balance">R$ 0,00</p></div>
            </div>
            <div class="card">
                <div class="card-header"><h3>Balanço Geral</h3><button class="btn download" id="generate-balance-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="balance-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Pagamentos de Convidados</h3><button class="btn download" id="generate-guest-payments-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="guest-payments-details"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h3>Despesas do Evento</h3><button class="btn download" id="generate-expenses-report-btn">Gerar PDF</button></div>
                <table class="report-table" style="width: 100%; border-collapse: collapse;"><tbody id="expenses-details"></tbody></table>
            </div>
        </section>

        <section id="backup-page" class="page-content">
            <header><h2>Backup e Restauração</h2></header>
            <div class="card">
                <h3>Exportar Dados</h3>
                <p>Faça backup de todos os dados do sistema para um arquivo JSON.</p>
                <div class="modal-actions">
                    <button class="btn success" id="export-data-btn">Exportar Tudo</button>
                    <button class="btn success" id="export-guests-btn">Exportar Convidados</button>
                </div>
            </div>
            <div class="card">
                <h3>Importar Dados</h3>
                <p>Restaurar dados de um backup anterior. A importação adicionará novos dados aos existentes.</p>
                <div class="form-control"><label for="backup-file">Selecionar arquivo de backup (.json)</label><input type="file" id="backup-file" accept=".json"></div>
                <div class="modal-actions">
                    <button class="btn secondary" id="import-data-btn">Importar Dados</button>
                </div>
            </div>
            <div class="card">
                <h3>Limpar Dados</h3>
                <p>Remover todos os dados do sistema. Esta ação não pode ser desfeita.</p>
                <div class="modal-actions"><button class="btn danger" id="clear-data-btn">Limpar Todos os Dados</button></div>
            </div>
        </section>
    </main>

    <button class="fab" id="fab-add-btn" style="display: none;"><i class="fa-solid fa-plus"></i></button>

    <div class="modal-overlay" id="event-modal"><div class="modal-content"><h3 id="event-modal-title"></h3><form id="event-form"></form></div></div>
    <div class="modal-overlay" id="costs-modal"><div class="modal-content"><h3 id="costs-modal-title"></h3><form id="costs-form"></form></div></div>
    <div class="modal-overlay" id="guest-modal"><div class="modal-content"><h3 id="guest-modal-title"></h3><form id="guest-form"></form></div></div>
    <div class="modal-overlay" id="supplier-modal"><div class="modal-content"><h3 id="supplier-modal-title"></h3><form id="supplier-form"></form></div></div>
    <div class="modal-overlay" id="delete-modal"><div class="modal-content"><h3 id="delete-modal-title"></h3><p id="delete-message"></p><div class="modal-actions"><button type="button" class="btn secondary" id="cancel-delete-btn">Cancelar</button><button type="button" class="btn danger" id="confirm-delete-btn">Excluir</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===== ESTADO CENTRAL DA APLICAÇÃO =====
        const state = {
            eventData: {},
            guests: [],
            suppliers: [],
            activePage: 'dashboard-page',
            currentEditingId: null,
            currentEditingType: null,
            qrScannerStream: null,
            qrScannerAnimationId: null
        };

        // ===== SELETORES DE ELEMENTOS COMUNS =====
        const selectors = {
            navLinks: document.getElementById('nav-links'),
            pages: document.querySelectorAll('.page-content'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            mobilePageTitle: document.getElementById('mobile-page-title'),
            fab: document.getElementById('fab-add-btn'),
            dashboardCardsContainer: document.getElementById('dashboard-cards')
        };
        
        // ===== FUNÇÕES AUXILIARES =====
        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getPaymentStatusText = (status) => ({ paid: 'Pago', partial: 'Parcial', pending: 'Pendente' }[status] || 'Pendente');
        const getCostCategoryName = (category) => ({ food: 'Alimentação', music: 'Música', venue: 'Aluguel do Espaço', drinks: 'Bebidas', other: 'Outros Custos' }[category] || category);
        const calculateTotalCost = () => (Object.values(state.eventData.costs || {}).reduce((s, c) => s + c, 0)) + (state.suppliers.reduce((s, sup) => s + (sup.cost || 0), 0));

        // ===== PERSISTÊNCIA DE DADOS (LocalStorage) =====
        const initializeData = () => {
            const savedData = JSON.parse(localStorage.getItem('eventManagementData_v2'));
            if (savedData) {
                state.eventData = savedData.eventData || { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
                state.guests = savedData.guests || [];
                state.suppliers = savedData.suppliers || [];
            } else {
                 state.eventData = { name: '', date: '', location: '', description: '', costs: { food: 0, music: 0, venue: 0, drinks: 0, other: 0 } };
            }
            state.activePage = localStorage.getItem('eventActivePage_v2') || 'dashboard-page';
        };

        const saveState = () => {
            const dataToSave = { eventData: state.eventData, guests: state.guests, suppliers: state.suppliers };
            localStorage.setItem('eventManagementData_v2', JSON.stringify(dataToSave));
            localStorage.setItem('eventActivePage_v2', state.activePage);
        };

        // ===== NAVEGAÇÃO E CONTROLE DA UI =====
        const navigateTo = (pageId) => {
            state.activePage = pageId;
            const activeLink = document.querySelector(`.sidebar nav a[data-page="${pageId}"]`);
            document.querySelector('.sidebar nav a.active')?.classList.remove('active');
            activeLink?.classList.add('active');
            
            selectors.mobilePageTitle.textContent = activeLink?.textContent.trim() || 'Dashboard';
            selectors.pages.forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');

            selectors.fab.style.display = ['guests-page', 'suppliers-page'].includes(pageId) ? 'flex' : 'none';
            
            if (window.innerWidth <= 768) {
                selectors.sidebar.classList.remove('open');
                selectors.sidebarOverlay.classList.remove('active');
            }
            app.renderActivePage();
        };

        // ===== MODAIS =====
        const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        const app = {
            // ===== LÓGICA DE RENDERIZAÇÃO DAS PÁGINAS =====
            renderDashboard() {
                document.getElementById('dashboard-event-name').textContent = state.eventData.name || 'Configurar';
                document.getElementById('dashboard-guest-count').textContent = state.guests.length;
                document.getElementById('dashboard-supplier-count').textContent = state.suppliers.length;
                const totalReceived = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                document.getElementById('dashboard-payment-total').textContent = formatCurrency(totalReceived);

                const totalCost = calculateTotalCost();
                const costPerGuest = state.guests.length > 0 ? totalCost / state.guests.length : 0;
                const totalPending = state.guests.reduce((s, g) => s + Math.max(0, (g.suggestedValue || 0) - (g.paidValue || 0)), 0);
                
                document.getElementById('total-cost').textContent = formatCurrency(totalCost);
                document.getElementById('cost-per-guest').textContent = formatCurrency(costPerGuest);
                document.getElementById('total-received').textContent = formatCurrency(totalReceived);
                document.getElementById('total-pending').textContent = formatCurrency(totalPending);

                const recentPaymentsList = document.getElementById('recent-payments-list');
                recentPaymentsList.innerHTML = [...state.guests].filter(g => g.paidValue > 0).sort((a,b) => b.id - a.id).slice(0, 5).map(g => `
                    <li class="list-item" style="cursor:default;">
                        <div class="transaction-details">
                            <div class="transaction-status paid"></div>
                            <div class="transaction-info">
                                <span class="description">${g.name}</span>
                                <span class="details">Pagamento de convidado</span>
                            </div>
                        </div>
                        <div class="transaction-amount income">${formatCurrency(g.paidValue)}</div>
                    </li>
                `).join('') || `<li class="list-item" style="justify-content:center;">Nenhum pagamento recebido.</li>`;
            },
            renderEventPage() {
                document.getElementById('event-info').innerHTML = `
                    <p><strong>Nome do Evento:</strong> <span>${state.eventData.name || 'Não definido'}</span></p>
                    <p><strong>Data do Evento:</strong> <span>${state.eventData.date ? new Date(state.eventData.date).toLocaleDateString('pt-BR', {timeZone:'UTC'}) : 'Não definida'}</span></p>
                    <p><strong>Local do Evento:</strong> <span>${state.eventData.location || 'Não definido'}</span></p>`;
                
                document.getElementById('costs-info').innerHTML = Object.entries(state.eventData.costs || {}).map(([key, value]) => `
                    <p><strong>${getCostCategoryName(key)}:</strong> <span>${formatCurrency(value)}</span></p>`).join('');
            },
            renderGuestsPage() {
                const searchTerm = document.getElementById('guest-search').value.toLowerCase();
                const filtered = state.guests.filter(g => g.name.toLowerCase().includes(searchTerm));
                document.getElementById('guests-list').innerHTML = filtered.map(g => `
                    <li class="list-item" onclick="app.openGuestModal('${g.id}')">
                        <div class="list-item-main">
                            <i class="fa-solid fa-user"></i>
                            <div>
                                <div>${g.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light-color);">${g.email || ''} ${g.phone || ''}</div>
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <span class="status ${g.paymentStatus}">${getPaymentStatusText(g.paymentStatus)}</span>
                            <button class="delete-btn" style="opacity:1" onclick="event.stopPropagation(); app.openDeleteModal('${g.id}', 'guest', '${g.name}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>
                `).join('') || `<li class="list-item" style="justify-content:center;">Nenhum convidado adicionado.</li>`;
            },
            renderSuppliersPage() {
                 document.getElementById('suppliers-list').innerHTML = state.suppliers.map(s => `
                    <li class="list-item" onclick="app.openSupplierModal('${s.id}')">
                         <div class="list-item-main">
                            <i class="fa-solid fa-truck"></i>
                            <div>
                                <div>${s.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light-color);">${s.service} - ${formatCurrency(s.cost)}</div>
                            </div>
                        </div>
                        <div class="list-item-actions">
                            <span class="status ${s.paymentStatus}">${getPaymentStatusText(s.paymentStatus)}</span>
                             <button class="delete-btn" style="opacity:1" onclick="event.stopPropagation(); app.openDeleteModal('${s.id}', 'supplier', '${s.name}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>
                `).join('') || `<li class="list-item" style="justify-content:center;">Nenhum fornecedor adicionado.</li>`;
            },
            renderPaymentsPage() {
                const totalReceived = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                const totalPending = state.guests.reduce((s, g) => s + Math.max(0, (g.suggestedValue || 0) - (g.paidValue || 0)), 0);
                document.getElementById('payments-total-received').textContent = formatCurrency(totalReceived);
                document.getElementById('payments-total-pending').textContent = formatCurrency(totalPending);

                document.getElementById('guest-payments-list').innerHTML = state.guests.map(g => `
                    <li class="list-item" style="cursor:default;">
                        <div class="transaction-details">
                            <div class="transaction-info">
                                <span class="description">${g.name}</span>
                                <span class="details">Sugerido: ${formatCurrency(g.suggestedValue)}</span>
                            </div>
                        </div>
                        <div class="transaction-amount income">${formatCurrency(g.paidValue)}</div>
                    </li>
                `).join('') || `<li class="list-item" style="justify-content:center;">Nenhum pagamento de convidado.</li>`;
                
                document.getElementById('supplier-payments-list').innerHTML = state.suppliers.map(s => `
                     <li class="list-item" style="cursor:default;">
                        <div class="transaction-details">
                            <div class="transaction-info">
                                <span class="description">${s.name} (${s.service})</span>
                                <span class="details">Custo Total: ${formatCurrency(s.cost)}</span>
                            </div>
                        </div>
                        <div class="transaction-amount expense">-${formatCurrency(s.paid)}</div>
                    </li>
                `).join('') || `<li class="list-item" style="justify-content:center;">Nenhum pagamento a fornecedor.</li>`;
            },
            renderQRPage() {
                const listEl = document.getElementById('qr-codes-list');
                listEl.innerHTML = state.guests.map(g => `
                    <div class="card" style="width: 220px; text-align: center;">
                        <h4>${g.name}</h4>
                        <div class="qr-code-container">
                            <div class="qr-code" id="qr-${g.id}"></div>
                            <div class="qr-info">
                                <span class="checkin-status ${g.checkIn ? 'checked' : 'not-checked'}">${g.checkIn ? 'Check-in Feito' : 'Aguardando'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                // Gerar as imagens do QR Code após a renderização do HTML
                state.guests.forEach(g => this.generateQRCodeImage(g.qrCode, `qr-${g.id}`));
            },
            renderReportsPage() {
                const totalIncome = state.guests.reduce((s, g) => s + (g.paidValue || 0), 0);
                const totalExpenses = calculateTotalCost();
                const finalBalance = totalIncome - totalExpenses;
                document.getElementById('total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('final-balance').textContent = formatCurrency(finalBalance);

                // As tabelas são geradas dinamicamente para simplicidade. Poderiam ser mais detalhadas.
                document.getElementById('balance-details').innerHTML = `<tr><td style="padding: 8px;">Receitas</td><td>${formatCurrency(totalIncome)}</td></tr><tr><td style="padding: 8px;">Despesas</td><td>${formatCurrency(totalExpenses)}</td></tr><tr><td style="padding: 8px;"><strong>Saldo</strong></td><td><strong>${formatCurrency(finalBalance)}</strong></td></tr>`;
                document.getElementById('guest-payments-details').innerHTML = state.guests.map(g => `<tr><td style="padding: 8px;">${g.name}</td><td>${formatCurrency(g.paidValue)}</td><td><span class="status ${g.paymentStatus}">${getPaymentStatusText(g.paymentStatus)}</span></td></tr>`).join('');
                document.getElementById('expenses-details').innerHTML = state.suppliers.map(s => `<tr><td style="padding: 8px;">${s.name}</td><td>${formatCurrency(s.paid)} de ${formatCurrency(s.cost)}</td><td><span class="status ${s.paymentStatus}">${getPaymentStatusText(s.paymentStatus)}</span></td></tr>`).join('');
            },
            renderBackupPage() { /* Página estática, não precisa de renderização dinâmica */ },

            renderActivePage() {
                const renderers = {
                    'dashboard-page': this.renderDashboard, 'event-page': this.renderEventPage, 'guests-page': this.renderGuestsPage,
                    'suppliers-page': this.renderSuppliersPage, 'payments-page': this.renderPaymentsPage, 'qr-page': this.renderQRPage,
                    'reports-page': this.renderReportsPage, 'backup-page': this.renderBackupPage,
                };
                renderers[state.activePage]?.call(this);
            },
            
            // ===== LÓGICA DOS MODAIS E FORMULÁRIOS =====
            openEventModal() {
                document.getElementById('event-modal-title').textContent = 'Editar Evento';
                document.getElementById('event-form').innerHTML = `
                    <div class="form-control"><label for="event-name">Nome do Evento</label><input type="text" id="event-name" required></div>
                    <div class="form-control"><label for="event-date">Data do Evento</label><input type="date" id="event-date" required></div>
                    <div class="form-control"><label for="event-location">Local do Evento</label><input type="text" id="event-location" required></div>
                    <div class="modal-actions"><button type="button" class="btn secondary" onclick="app.closeAllModals()">Cancelar</button><button type="submit" class="btn primary">Salvar</button></div>`;
                
                document.getElementById('event-name').value = state.eventData.name || '';
                document.getElementById('event-date').value = state.eventData.date || '';
                document.getElementById('event-location').value = state.eventData.location || '';
                openModal('event-modal');
            },
            saveEvent(e) {
                e.preventDefault();
                state.eventData.name = document.getElementById('event-name').value;
                state.eventData.date = document.getElementById('event-date').value;
                state.eventData.location = document.getElementById('event-location').value;
                this.closeAllModals(); this.updateUI();
            },
             openCostsModal() {
                document.getElementById('costs-modal-title').textContent = 'Editar Custos do Evento';
                document.getElementById('costs-form').innerHTML = `
                    <div class="form-grid">
                        <div class="form-control"><label for="cost-food">Alimentação</label><input type="number" id="cost-food" min="0" step="0.01"></div>
                        <div class="form-control"><label for="cost-music">Música</label><input type="number" id="cost-music" min="0" step="0.01"></div>
                        <div class="form-control"><label for="cost-venue">Aluguel</label><input type="number" id="cost-venue" min="0" step="0.01"></div>
                        <div class="form-control"><label for="cost-drinks">Bebidas</label><input type="number" id="cost-drinks" min="0" step="0.01"></div>
                    </div>
                     <div class="form-control"><label for="cost-other">Outros Custos</label><input type="number" id="cost-other" min="0" step="0.01"></div>
                    <div class="modal-actions"><button type="button" class="btn secondary" onclick="app.closeAllModals()">Cancelar</button><button type="submit" class="btn primary">Salvar</button></div>`;

                Object.keys(state.eventData.costs).forEach(key => document.getElementById(`cost-${key}`).value = state.eventData.costs[key]);
                openModal('costs-modal');
            },
            saveCosts(e) {
                e.preventDefault();
                Object.keys(state.eventData.costs).forEach(key => state.eventData.costs[key] = parseFloat(document.getElementById(`cost-${key}`).value) || 0);
                this.closeAllModals(); this.updateUI();
            },
            openGuestModal(guestId = null) {
                state.currentEditingId = guestId;
                const guest = guestId ? state.guests.find(g => g.id === guestId) : null;
                document.getElementById('guest-modal-title').textContent = guest ? 'Editar Convidado' : 'Adicionar Convidado';
                document.getElementById('guest-form').innerHTML = `
                    <div class="form-control"><label for="guest-name">Nome</label><input type="text" id="guest-name" required></div>
                    <div class="form-grid">
                        <div class="form-control"><label for="guest-email">E-mail</label><input type="email" id="guest-email"></div>
                        <div class="form-control"><label for="guest-phone">Telefone</label><input type="tel" id="guest-phone"></div>
                    </div>
                     <div class="form-grid">
                        <div class="form-control"><label for="guest-suggested-value">Valor Sugerido</label><input type="number" id="guest-suggested-value" min="0" step="0.01"></div>
                        <div class="form-control"><label for="guest-paid-value">Valor Pago</label><input type="number" id="guest-paid-value" min="0" step="0.01"></div>
                    </div>
                    <div class="form-control"><label for="guest-status">Status Pagamento</label><select id="guest-status"><option value="pending">Pendente</option><option value="partial">Parcial</option><option value="paid">Pago</option></select></div>
                    <div class="modal-actions"><button type="button" class="btn secondary" onclick="app.closeAllModals()">Cancelar</button><button type="submit" class="btn primary">Salvar</button></div>`;
                
                if (guest) {
                    document.getElementById('guest-name').value = guest.name; document.getElementById('guest-email').value = guest.email || '';
                    document.getElementById('guest-phone').value = guest.phone || ''; document.getElementById('guest-suggested-value').value = guest.suggestedValue || 0;
                    document.getElementById('guest-paid-value').value = guest.paidValue || 0; document.getElementById('guest-status').value = guest.paymentStatus || 'pending';
                }
                openModal('guest-modal');
            },
            async saveGuest(e) {
                e.preventDefault();
                const oldStatus = state.currentEditingId ? state.guests.find(g => g.id === state.currentEditingId)?.paymentStatus : null;

                const guestData = {
                    name: document.getElementById('guest-name').value, email: document.getElementById('guest-email').value, phone: document.getElementById('guest-phone').value,
                    suggestedValue: parseFloat(document.getElementById('guest-suggested-value').value) || 0, paidValue: parseFloat(document.getElementById('guest-paid-value').value) || 0,
                    paymentStatus: document.getElementById('guest-status').value, checkIn: false
                };

                if (state.currentEditingId) {
                    const index = state.guests.findIndex(g => g.id === state.currentEditingId);
                    guestData.id = state.currentEditingId;
                    guestData.checkIn = state.guests[index].checkIn; // Manter check-in
                    guestData.qrCode = state.guests[index].qrCode;
                    state.guests[index] = guestData;
                } else {
                    guestData.id = Date.now().toString();
                    guestData.qrCode = `GUEST-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    state.guests.push(guestData);
                }
                
                const newStatus = guestData.paymentStatus;
                const justPaid = newStatus === 'paid' && oldStatus !== 'paid';
                
                if (justPaid) {
                    await this.generateGuestReceipt(guestData);
                }

                this.closeAllModals(); this.updateUI();
            },
            openSupplierModal(supplierId = null) {
                state.currentEditingId = supplierId;
                const supplier = supplierId ? state.suppliers.find(s => s.id === supplierId) : null;
                document.getElementById('supplier-modal-title').textContent = supplier ? 'Editar Fornecedor' : 'Adicionar Fornecedor';
                document.getElementById('supplier-form').innerHTML = `
                    <div class="form-control"><label for="supplier-name">Nome</label><input type="text" id="supplier-name" required></div>
                    <div class="form-control"><label for="supplier-service">Serviço</label><input type="text" id="supplier-service" required></div>
                    <div class="form-grid">
                        <div class="form-control"><label for="supplier-cost">Custo</label><input type="number" id="supplier-cost" min="0" step="0.01"></div>
                        <div class="form-control"><label for="supplier-paid">Valor Pago</label><input type="number" id="supplier-paid" min="0" step="0.01"></div>
                    </div>
                    <div class="form-control"><label for="supplier-status">Status</label><select id="supplier-status"><option value="pending">Pendente</option><option value="partial">Parcial</option><option value="paid">Pago</option></select></div>
                    <div class="modal-actions"><button type="button" class="btn secondary" onclick="app.closeAllModals()">Cancelar</button><button type="submit" class="btn primary">Salvar</button></div>`;

                if(supplier) {
                    document.getElementById('supplier-name').value = supplier.name; document.getElementById('supplier-service').value = supplier.service;
                    document.getElementById('supplier-cost').value = supplier.cost || 0; document.getElementById('supplier-paid').value = supplier.paid || 0;
                    document.getElementById('supplier-status').value = supplier.paymentStatus || 'pending';
                }
                openModal('supplier-modal');
            },
            saveSupplier(e) {
                e.preventDefault();
                const supplierData = {
                    name: document.getElementById('supplier-name').value, service: document.getElementById('supplier-service').value,
                    cost: parseFloat(document.getElementById('supplier-cost').value) || 0, paid: parseFloat(document.getElementById('supplier-paid').value) || 0,
                    paymentStatus: document.getElementById('supplier-status').value
                };
                if(state.currentEditingId) {
                    const index = state.suppliers.findIndex(s => s.id === state.currentEditingId);
                    supplierData.id = state.currentEditingId; state.suppliers[index] = supplierData;
                } else {
                    supplierData.id = Date.now().toString(); state.suppliers.push(supplierData);
                }
                this.closeAllModals(); this.updateUI();
            },
            openDeleteModal(id, type, name) {
                state.currentEditingId = id; state.currentEditingType = type;
                document.getElementById('delete-modal-title').textContent = 'Confirmar Exclusão';
                document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir "${name}"? Esta ação não pode ser desfeita.`;
                openModal('delete-modal');
            },
            confirmDelete() {
                if (state.currentEditingType === 'guest') state.guests = state.guests.filter(g => g.id !== state.currentEditingId);
                else if (state.currentEditingType === 'supplier') state.suppliers = state.suppliers.filter(s => s.id !== state.currentEditingId);
                this.closeAllModals(); this.updateUI();
            },
            closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
                state.currentEditingId = null; state.currentEditingType = null;
            },
            
            // ===== LÓGICA DO QR CODE =====
            generateQRCodeImage(data, elementId) {
                const qrElement = document.getElementById(elementId);
                if (!qrElement) return;
                qrElement.innerHTML = '';
                const canvas = document.createElement('canvas');
                qrElement.appendChild(canvas);
                QRCode.toCanvas(canvas, data, { width: 150, margin: 1 }, (err) => { if(err) console.error(err); });
            },
            startQRScanner() {
                const video = document.getElementById('qr-video');
                const canvas = document.getElementById('qr-canvas');
                const placeholder = document.getElementById('qr-scanner-placeholder');
                
                placeholder.style.display = 'none';
                video.classList.remove('hidden');
                document.getElementById('start-camera-btn').classList.add('hidden');
                document.getElementById('stop-camera-btn').classList.remove('hidden');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    state.qrScannerStream = stream;
                    video.srcObject = stream;
                    video.play();
                    this.tickQRScanner();
                }).catch(err => {
                    console.error("Erro ao acessar a câmera: ", err);
                    this.showQRResult('Erro ao acessar a câmera.', 'error');
                });
            },
            tickQRScanner() {
                const video = document.getElementById('qr-video');
                const canvas = document.getElementById('qr-canvas');
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const ctx = canvas.getContext('2d');
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                    
                    if (code) {
                        this.processQRCode(code.data);
                        return; // Stop scanning after a code is found
                    }
                }
                state.qrScannerAnimationId = requestAnimationFrame(() => this.tickQRScanner());
            },
            stopQRScanner() {
                if(state.qrScannerAnimationId) cancelAnimationFrame(state.qrScannerAnimationId);
                if (state.qrScannerStream) {
                    state.qrScannerStream.getTracks().forEach(track => track.stop());
                    state.qrScannerStream = null;
                }
                document.getElementById('qr-video').classList.add('hidden');
                document.getElementById('qr-scanner-placeholder').style.display = 'block';
                document.getElementById('start-camera-btn').classList.remove('hidden');
                document.getElementById('stop-camera-btn').classList.add('hidden');
            },
            processQRCode(data) {
                const guest = state.guests.find(g => g.qrCode === data);
                if (guest) {
                    if (!guest.checkIn) {
                        guest.checkIn = true;
                        this.showQRResult(`Check-in confirmado para ${guest.name}!`, 'success');
                        this.updateUI();
                    } else {
                        this.showQRResult(`${guest.name} já fez check-in.`, 'pending');
                    }
                } else {
                    this.showQRResult('QR Code inválido ou não encontrado.', 'error');
                }
                setTimeout(() => this.stopQRScanner(), 3000);
            },
            showQRResult(message, type) {
                const resultDiv = document.getElementById('qr-result');
                resultDiv.textContent = message;
                resultDiv.className = `qr-result ${type}`;
                resultDiv.style.display = 'block';
                setTimeout(() => resultDiv.style.display = 'none', 3000);
            },

            // ===== LÓGICA DE RELATÓRIOS E BACKUP =====
            async generateGuestReceipt(guest) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Cabeçalho
                doc.setFontSize(22);
                doc.setTextColor(var_primary_color_hex); // Usando a cor primária
                doc.text('Recibo de Pagamento', 105, 20, null, null, 'center');

                // Informações do Evento
                doc.setFontSize(14);
                doc.setTextColor(var_text_color_hex);
                doc.text(state.eventData.name || 'Nome do Evento', 105, 35, null, null, 'center');
                doc.setFontSize(11);
                doc.setTextColor(var_text_light_color_hex);
                const eventDate = state.eventData.date ? new Date(state.eventData.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Data não definida';
                doc.text(`Data: ${eventDate}`, 105, 42, null, null, 'center');
                doc.text(`Local: ${state.eventData.location || 'Local não definido'}`, 105, 49, null, null, 'center');

                // Linha divisória
                doc.setDrawColor(var_primary_color_hex);
                doc.line(20, 60, 190, 60);

                // Informações do Convidado
                doc.setFontSize(12);
                doc.setTextColor(var_text_color_hex);
                doc.text('Recebemos de:', 20, 70);
                doc.setFontSize(16);
                doc.text(guest.name, 20, 80);

                doc.setFontSize(12);
                doc.text('Valor Pago:', 20, 95);
                doc.setFontSize(16);
                doc.setTextColor(var_success_color_hex);
                doc.text(formatCurrency(guest.paidValue), 20, 105);

                // QR Code
                try {
                    const qrCodeDataUrl = await QRCode.toDataURL(guest.qrCode, { width: 400 });
                    doc.addImage(qrCodeDataUrl, 'PNG', 140, 70, 50, 50);
                    doc.setFontSize(10);
                    doc.setTextColor(var_text_light_color_hex);
                    doc.text('Apresente este QR Code na entrada', 165, 128, null, null, 'center');
                } catch (err) {
                    console.error('Falha ao gerar QR Code para o PDF:', err);
                    doc.text('Erro ao gerar QR Code', 150, 90);
                }

                doc.save(`recibo-${guest.name.replace(/\s+/g, '_')}.pdf`);
            },
            generatePDF(title, columns, rows, filename) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text(title, 14, 22);
                doc.setFontSize(11);
                doc.text(`Evento: ${state.eventData.name || 'Não definido'}`, 14, 30);
                doc.autoTable({ head: [columns], body: rows, startY: 35, theme: 'grid', headStyles: { fillColor: [86, 54, 211] } });
                doc.save(filename);
            },
            generateGuestPaymentsReport() {
                const rows = state.guests.map(g => [g.name, formatCurrency(g.suggestedValue), formatCurrency(g.paidValue), getPaymentStatusText(g.paymentStatus)]);
                this.generatePDF('Pagamentos de Convidados', ['Nome', 'Sugerido', 'Pago', 'Status'], rows, 'relatorio_convidados.pdf');
            },
            generateExpensesReport() {
                 const rows = state.suppliers.map(s => [`${s.name} (${s.service})`, formatCurrency(s.cost), formatCurrency(s.paid), getPaymentStatusText(s.paymentStatus)]);
                 this.generatePDF('Despesas do Evento', ['Fornecedor/Serviço', 'Custo', 'Pago', 'Status'], rows, 'relatorio_despesas.pdf');
            },
            exportData(dataType = 'all') {
                let data;
                let filename = `backup_evento_${new Date().toISOString().split('T')[0]}.json`;

                if(dataType === 'guests') {
                    data = { guests: state.guests };
                    filename = `convidados_${new Date().toISOString().split('T')[0]}.json`;
                } else {
                    data = { eventData: state.eventData, guests: state.guests, suppliers: state.suppliers };
                }

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            },
            importData() {
                const file = document.getElementById('backup-file').files[0];
                if (!file) { alert('Por favor, selecione um arquivo.'); return; }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.eventData && !state.eventData.name) state.eventData = data.eventData;
                        if (data.guests) data.guests.forEach(g => { if(!state.guests.find(eg => eg.id === g.id)) state.guests.push(g); });
                        if (data.suppliers) data.suppliers.forEach(s => { if(!state.suppliers.find(es => es.id === s.id)) state.suppliers.push(s); });
                        
                        this.updateUI();
                        alert('Dados importados com sucesso!');
                    } catch (error) {
                        alert('Erro ao ler o arquivo de backup.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            },
            clearAllData() {
                if(confirm('ATENÇÃO! Isso apagará TODOS os dados do evento. Deseja continuar?')) {
                    localStorage.removeItem('eventManagementData_v2');
                    initializeData(); // Reseta o state para o padrão
                    this.updateUI();
                    alert('Todos os dados foram removidos.');
                }
            },

            // ===== ATUALIZAÇÃO GERAL =====
            updateUI() {
                saveState();
                this.renderActivePage();
            }
        };

        // ===== EVENT LISTENERS (OUVINTE DE EVENTOS) =====
        selectors.navLinks.addEventListener('click', e => {
            const link = e.target.closest('a');
            if (link?.dataset.page) {
                e.preventDefault();
                navigateTo(link.dataset.page);
            }
        });
        
        // MELHORIA: Listener para os cards clicáveis do dashboard
        selectors.dashboardCardsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.card[data-page]');
            if (card && card.dataset.page) {
                navigateTo(card.dataset.page);
            }
        });

        selectors.fab.addEventListener('click', () => {
            if (state.activePage === 'guests-page') app.openGuestModal();
            else if (state.activePage === 'suppliers-page') app.openSupplierModal();
        });

        // Modais e formulários
        document.getElementById('event-form').addEventListener('submit', (e) => app.saveEvent(e));
        document.getElementById('costs-form').addEventListener('submit', (e) => app.saveCosts(e));
        document.getElementById('guest-form').addEventListener('submit', async (e) => await app.saveGuest(e));
        document.getElementById('supplier-form').addEventListener('submit', (e) => app.saveSupplier(e));
        document.getElementById('confirm-delete-btn').addEventListener('click', () => app.confirmDelete());
        document.getElementById('cancel-delete-btn').addEventListener('click', () => app.closeAllModals());
        
        // Ações de páginas
        document.getElementById('edit-event-btn').addEventListener('click', () => app.openEventModal());
        document.getElementById('edit-costs-btn').addEventListener('click', () => app.openCostsModal());
        document.getElementById('guest-search').addEventListener('input', () => app.renderGuestsPage());
        document.getElementById('start-camera-btn').addEventListener('click', () => app.startQRScanner());
        document.getElementById('stop-camera-btn').addEventListener('click', () => app.stopQRScanner());
        document.getElementById('generate-guest-payments-report-btn').addEventListener('click', () => app.generateGuestPaymentsReport());
        document.getElementById('generate-expenses-report-btn').addEventListener('click', () => app.generateExpensesReport());
        document.getElementById('export-data-btn').addEventListener('click', () => app.exportData('all'));
        document.getElementById('export-guests-btn').addEventListener('click', () => app.exportData('guests'));
        document.getElementById('import-data-btn').addEventListener('click', () => app.importData());
        document.getElementById('clear-data-btn').addEventListener('click', () => app.clearAllData());

        // Menu mobile
        const toggleSidebar = () => {
            selectors.sidebar.classList.toggle('open');
            selectors.sidebarOverlay.classList.toggle('active');
        };
        selectors.menuToggleBtn.addEventListener('click', toggleSidebar);
        selectors.sidebarOverlay.addEventListener('click', toggleSidebar);

        // ===== INICIALIZAÇÃO DA APLICAÇÃO =====
        // Cores para o PDF
        const var_primary_color_hex = '#5636D3';
        const var_text_color_hex = '#363F5F';
        const var_text_light_color_hex = '#969CB2';
        const var_success_color_hex = '#12A454';
        
        window.app = app; // Expor o objeto app globalmente para os `onclick`
        initializeData();
        navigateTo(state.activePage);
    });
    </script>
</body>
</html>
